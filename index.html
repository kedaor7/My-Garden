<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Catatan Tanaman ü™¥</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<meta name="theme-color" content="#007AFF">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="mobile-web-app-capable" content="yes">

<style>
html, body { 
    overscroll-behavior-y: none; 
    height: 100%;
    overflow-x: hidden;
}

#map-canvas-area {
    overscroll-behavior: none;
    touch-action: none
    }

  }

}


body.editor-active #map-canvas-area {
    touch-action: none;
    cursor: grab;
    user-select: none;
    -webkit-user-drag: none;
}
body.editor-active #map-canvas-area:active {
    cursor: grabbing;
}


/* Dialog z-index fix */
#custom-dialog, #custom-dialog * {
    z-index: 999999 !important;
    position: relative;
}
.modal-backdrop, #modal-backdrop, .custom-dialog-backdrop {
    z-index: 999998 !important;
    position: fixed !important;
}



#avatarMenuPreview {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid rgba(255,255,255,0.25);
    margin: 0 auto 18px auto;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: center;
    

    aspect-ratio: 1 / 1;
    animation: breathingGlow 3s ease-in-out infinite;
}

#avatarMenuPreviewImg {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

@keyframes breathingGlow {
    0% { box-shadow: 0 0 0px rgba(255, 0, 150, 0.25); }
    50% { box-shadow: 0 0 28px rgba(255, 0, 180, 0.70); }
    100% { box-shadow: 0 0 0px rgba(255, 0, 150, 0.25); }
}

@keyframes breathingGlow {
    0% { box-shadow: 0 0 0px rgba(0,150,255,0.2); }
    50% { box-shadow: 0 0 22px rgba(0,150,255,0.55); }
    100% { box-shadow: 0 0 0px rgba(0,150,255,0.2); }
}

.ios-btn{
 padding:14px; border-radius:16px; background:rgba(255,255,255,0.08);
 color:#fff; border:none; font-size:16px;
}
.ios-btn.destructive{ background:rgba(255,0,0,0.2); }
.ios-btn.cancel{ background:rgba(255,255,255,0.15); }
#avatarMenu button:active{ background:rgba(255,255,255,0.25); }

/* =========================================
   iOS NATIVE THEME OVERRIDE
   ========================================= */

:root {
    --bg-color: #F2F2F7;
    --card-bg: #FFFFFF;
    --text-color: #000000;
    --secondary-text-color: #8E8E93;
    --primary-color: #007AFF;
    --accent-green: #34C759;
    --accent-red: #FF3B30;
    --secondary-bg: #E5E5EA;
    --border-color: #C6C6C8;
    --modal-overlay: rgba(0, 0, 0, 0.4);
    --safe-bottom: env(safe-area-inset-bottom);
    --chat-bubble-user: var(--primary-color);
    --chat-bubble-ai: var(--secondary-bg);
    --chat-text-user: #FFFFFF;
    --chat-text-ai: var(--text-color);
}

#record-garden-filter {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 40px;
}


@keyframes fadeSlideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.item-animate {
    animation: fadeSlideUp 0.4s ease forwards;
    opacity: 0;
}

#finance-view {
    background-color: var(--bg-color);
    min-height: 100vh;
}

.finance-header-glass {
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    background: var(--header-bg); 
    border-bottom: 0.5px solid rgba(125,125,125,0.2);
    padding-bottom: 12px;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(15px); /* Muncul sedikit dari bawah */
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Class ini yang akan memicu animasi */
.page-animate {
    animation: fadeInUp 0.4s ease-out forwards;
}

.finance-card-premium {
    background: linear-gradient(135deg, #1c1c1e 0%, #3a3a3c 100%);
    padding: 24px;
    border-radius: 24px;
    color: white;
    margin: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
}

body.dark-mode .finance-card-premium {
    border: 1px solid rgba(255,255,255,0.1);
}

.filter-scroll-wrapper {
    display: flex;
    gap: 8px;
    padding: 5px 16px;
    overflow-x: auto;
    scrollbar-width: none;
}
.filter-scroll-wrapper::-webkit-scrollbar { display: none; }

.ios-chip {
    background: var(--card-bg-alt);
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
}

.ios-chip.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 12px rgba(0,122,255,0.3);
}

.finance-item-card {
    background: var(--card-bg);
    margin: 0 16px 12px;
    padding: 16px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
    border: 0.5px solid rgba(125,125,125,0.1);
}

.finance-item-card:active {
    transform: scale(0.97);
    opacity: 0.8;
}

.icon-box {
    width: 44px;
    height: 44px;
    background: var(--card-bg-alt);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.price-text {
    font-weight: 700;
    font-size: 16px;
    color: var(--accent-red);
}

.finance-title {
    margin: 0;
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--text-color);
}

/* Penyesuaian Input Custom Tanggal agar terlihat di Dark Mode */
#custom-date-filter {
    background: var(--card-bg);
    color: var(--text-color);
}

#custom-date-filter input {
    background: var(--card-bg-alt);
    color: var(--text-color);
    border: 1px solid rgba(125,125,125,0.2);
}


/* Styling tombol navigasi & icon */
.nav-btn {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px;
    background: white;
    color: #333;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 !important; /* Hapus padding biar gak bengkak */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Tombol Tambah (Biru) */
.main-action-btn {
    height: 40px !important;
    padding: 0 15px !important;
    background: #007AFF;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
}

/* Tombol Tutup (Merah/Abu) */
.close-btn {
    height: 40px !important;
    padding: 0 15px !important;
    background: #ff3b30;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
}

/* Efek saat ditekan */
.nav-btn:active, .main-action-btn:active, .close-btn:active {
    transform: scale(0.95);
    opacity: 0.8;
}

.chat-timestamp {
    display: block; 
    font-size: 10px;
    margin-top: 4px;
    white-space: nowrap; 
    
    /* Pengaturan default: abu-abu dan sedikit transparan (untuk AI) */
    color: var(--secondary-text-color); /* Menggunakan warna abu-abu tema */
    opacity: 0.8;
}

/* PERATURAN KHUSUS UNTUK PESAN USER (HITAM)  */
.chat-message.user .chat-timestamp {
    text-align: right;
    color: #000000 !important; /* Warna hitam pekat untuk USER */
    opacity: 1 !important;      /* Tidak transparan */
}

.chat-message.ai .chat-timestamp {
    text-align: left;
}

.chat-bubble {
    position: relative; 
    padding-bottom: 15px !important; 
}


body.editor-active #main-header,
body.editor-active #main-navbar {
    display: none !important;
}

/* 2. Pastikan area konten mengambil 100% layar */
body.editor-active #content-area {
    /* Hapus padding yang biasanya dibuat untuk header/navbar */
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    /* Pastikan tinggi 100% viewport */
    height: 100vh;
    overflow: hidden; 
}

/* 3. Jadikan area kanvas peta menutupi seluruh layar */
body.editor-active #map-canvas-area {
    position: fixed !important; /* Timpa 'absolute' dan jadikan fixed */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important; /* 100% lebar viewport */
    height: 100vh !important; /* 100% tinggi viewport */
    z-index: 900 !important; /* Pastikan berada di atas elemen lain */
}


.ios-search-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 14px;
    background: var(--searchbar-bg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    margin: 12px 16px;
    backdrop-filter: blur(10px);
}

.ios-search-icon {
    font-size: 17px;
    opacity: 0.6;
}

#search-input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 15px;
    color: var(--text-color);
}

:root {
    --searchbar-bg: rgba(255,255,255,0.35); /* Light mode */
}

.dark-mode {
    --searchbar-bg: rgba(255,255,255,0.1); /* Dark mode */
}

.dark-mode {
    --bg-color: #000000;
    --card-bg: #1C1C1E;
    --text-color: #FFFFFF;
    --secondary-text-color: #98989D;
    --primary-color: #0A84FF;
    --accent-green: #30D158;
    --accent-red: #FF453A;
    --secondary-bg: #2C2C2E;
    --border-color: #38383A;
    --chat-bubble-user: var(--primary-color);
    --chat-bubble-ai: var(--secondary-bg);
    --chat-text-user: #FFFFFF;
    --chat-text-ai: var(--text-color);
}

* { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0; padding: 0;
    padding-bottom: calc(85px + var(--safe-bottom)); 
    user-select: none;
}

/* Loading Screen */
#loading-indicator {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    background-color: #000000; 
    color: #ffffff; 
    
    z-index: 9999;
    text-align: center;
}


/* --- MODERN LOGIN SCREEN STYLES (FITUR BARU) --- */
#login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%); /* Fresh Nature Gradient */
    color: #1c1c1e;
    z-index: 9999;
    text-align: center;
    padding: 20px;
}

.dark-mode #login-screen {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    color: #ffffff;
}

.login-container {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.5);
    padding: 40px 30px;
    border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 360px;
    transition: transform 0.3s ease;
}

.dark-mode .login-container {
    background: rgba(28, 28, 30, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.login-container h1 { 
    color: #111; margin-bottom: 5px; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; 
}
.dark-mode .login-container h1 { color: #fff; }

.login-container p { 
    color: #666; margin-bottom: 30px; font-size: 15px; 
}
.dark-mode .login-container p { color: #aaa; }

.login-input {
    width: 100%;
    padding: 16px;
    margin-bottom: 15px;
    border-radius: 12px !important;
    border: 1px solid transparent !important;
    background: #f0f0f5 !important;
    font-size: 16px !important;
    transition: all 0.2s;
    outline: none;
}
.login-input:focus {
    background: #fff !important;
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
}
.dark-mode .login-input {
    background: #2c2c2e !important;
    color: #fff !important;
}
.dark-mode .login-input:focus {
    background: #3a3a3c !important;
}

.login-button {
    width: 100%;
    background: var(--primary-color);
    color: white;
    padding: 16px; border-radius: 14px; border: none;
    font-size: 17px; font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    margin-top: 10px;
    transition: transform 0.1s, opacity 0.2s;
}
.login-button:active { transform: scale(0.98); opacity: 0.9; }

/* --- 1. HEADER TRANSFORMATION --- */
.app-header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(255, 255, 255, 0.85); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 0.5px solid var(--border-color);
    padding: max(10px, env(safe-area-inset-top)) 16px 10px;
}
.dark-mode .app-header { background: rgba(28, 28, 30, 0.85); border-bottom: 0.5px solid var(--border-color);}
.header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}

.header-title { font-size: 28px; letter-spacing: -0.5px; line-height: 1.1; }
.plant-logo { display: none; } 

#search-input {
    width: 100%;
    background: var(--secondary-bg); border-radius: 10px; border: none;
    padding: 10px 12px; font-size: 16px; color: var(--text-color);
}

.header-buttons {
    display: flex; gap: 8px;
}

#add-record-btn, #settings-btn { 
    border-radius: 50%; width: 36px; height: 36px; padding: 0; font-size: 18px; 
    display: flex; align-items: center; justify-content: center;
    background: var(--card-bg); border: 1px solid var(--border-color);
    color: var(--primary-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.dark-mode #add-record-btn, .dark-mode #settings-btn { 
    background: var(--secondary-bg); border: 1px solid var(--border-color);
}

/* --- 2. NAVIGATION BAR --- */
.tab-nav {
    position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-top: 0.5px solid var(--border-color);
    margin: 0; padding: 10px 0 calc(10px + var(--safe-bottom));
    display: flex; justify-content: space-around; border-radius: 0;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}
.dark-mode .tab-nav { background: rgba(28, 28, 30, 0.9); border-top: 0.5px solid var(--border-color);}

#content-container { padding-top: 15px; }

.tab-button {
    background: transparent !important; border: none; padding: 0;
    color: var(--secondary-text-color); font-size: 10px; font-weight: 500;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: none !important; cursor: pointer;
    transition: color 0.2s;
}

.tab-button[data-type]::before { font-size: 24px; margin-bottom: 2px; }
.tab-button[data-type="Dashboard"]::before { content: 'üìä'; }
.tab-button[data-type="Dashboard"]::after { content: 'Dashboard'; font-size: 10px; }
.tab-button[data-type="Daftar Kebun"]::before { content: 'üå≥'; }
.tab-button[data-type="Daftar Kebun"]::after { content: 'Kebun'; font-size: 10px; }

.tab-button[data-type="Daftar Pupuk"]::before { content: 'üõçÔ∏è'; }
.tab-button[data-type="Daftar Pupuk"]::after { content: 'Stok Pupuk'; font-size: 10px; }
.tab-button[data-type="Daftar Racun"]::before { content: 'Ô∏è‚ö†Ô∏è'; }
.tab-button[data-type="Daftar Racun"]::after { content: 'Stok Racun'; font-size: 10px; }
.tab-button[data-type="Daftar Catatan"]::before { content: 'üìù'; }
.tab-button[data-type="Daftar Catatan"]::after { content: 'Catatan'; font-size: 10px; }
.tab-button[data-type="Galeri Tanaman"]::before { content: 'üñºÔ∏è'; }
.tab-button[data-type="Galeri Tanaman"]::after { content: 'Galeri'; font-size: 10px; }
.tab-button[data-type="Peta"]::before { content: 'üó∫Ô∏è'; }
.tab-button[data-type="Peta"]::after { content: 'Peta'; font-size:10px; }
.tab-button[data-type="Keuangan"]::before { content: 'üí∞'; }
.tab-button[data-type="Keuangan"]::after { content: 'Keuangan'; font-size:10px; }

.tab-button[data-type] { font-size: 0; } 


.tab-button.active { color: var(--primary-color); }
.tab-button.active::before { transform: translateY(-2px); transition: 0.2s; }

/* --- 3. CARDS & LISTS --- */
.list-container { padding: 0 16px; } 

.record-card {
    background-color: var(--card-bg);
    border: 0.5px solid var(--border-color); 
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    border-radius: 12px; 
    margin-bottom: 10px;
    padding: 15px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer;
    position: relative; /* For Pin */
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
}

/* PINNED STYLE */
.record-card.pinned {
    border-left: 4px solid var(--primary-color);
    background-color: rgba(0, 122, 255, 0.03);
}
.dark-mode .record-card.pinned {
    background-color: rgba(10, 132, 255, 0.08);
}
.pin-icon {
    position: absolute;
    top: 5px; right: 5px;
    font-size: 14px;
    transform: rotate(45deg);
}

.record-card:active { transform: scale(0.98); box-shadow: 0 1px 4px rgba(0,0,0,0.08); background-color: var(--secondary-bg); }
.dark-mode .record-card:active { background-color: #2C2C2E; }

#stat-cards-container {
    display: grid !important; grid-template-columns: 1fr 1fr; gap: 10px;
}
.stat-card { 
    border-left: none !important; padding: 15px; text-align: left; display: block; 
    flex-direction: column; align-items: flex-start;
}
.stat-card div:first-child { font-size: 13px; color: var(--secondary-text-color); margin-bottom: 5px; text-transform: uppercase; font-weight: 600;}
.stat-card div:last-child { font-size: 24px; font-weight: 700; color: var(--text-color); }
.stat-card {
    transition: all 0.3s ease;
    min-height: 100px;
    height: auto !important;
    cursor: pointer;
}

.stat-card:active {
    transform: scale(0.96);
}

#harvest-filter-menu .ios-chip {
    padding: 4px 10px;
    font-size: 11px;
}


.form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
.detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 0.5px solid var(--border-color); font-size: 15px; }
.detail-group { margin-bottom: 20px; padding: 10px 15px; background: var(--card-bg); border-radius: 12px; border: 0.5px solid var(--border-color); }
.dark-mode .detail-group { background: var(--secondary-bg); }

/* --- 4. MODALS (BOTTOM SHEET STYLE) --- */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
    display: none; justify-content: center; align-items: flex-end; 
    background-color: var(--modal-overlay);
    backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
    padding: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}
.modal.active { opacity: 1; pointer-events: auto; } 

.modal-content {
    background-color: var(--card-bg);
    width: 100%; max-width: 100%; border-radius: 24px 24px 0 0;
    margin: 0; padding: 25px 20px calc(20px + var(--safe-bottom));
    max-height: 90vh; overflow-y: auto;
    position: relative;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
}
.modal.active .modal-content {
     transform: translateY(0);
}

.modal-content::before {
    content: ''; position: sticky; top: 5px; left: 50%; transform: translateX(-50%);
    width: 40px; height: 5px; background: var(--border-color); border-radius: 10px;
    margin-bottom: 15px;
    display: block;
}

/* Form Elements Styling */
input:not([type="checkbox"]):not([type="file"]), select, textarea {
    background: var(--secondary-bg) !important; border: none !important;
    border-radius: 10px !important; padding: 12px 15px !important;
    font-size: 16px !important; color: var(--text-color) !important;
}
input[type="date"], input[type="time"], input[type="datetime-local"] {
     -webkit-appearance: none; appearance: none;
}
input[type="file"] { padding: 10px 0; }
label { margin-bottom: 5px; font-size: 13px; color: var(--secondary-text-color); font-weight: 500; }

.form-actions { 
    margin-top: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
}
.reminder-inputs { display: flex; gap: 10px; }
.reminder-inputs > div { flex: 1; }

/* Buttons (iOS Style) */
.save-btn, .primary-action {
    background: var(--primary-color);
    color: white;
    padding: 16px; border-radius: 14px; border: none;
    font-size: 17px; font-weight: 700;
    cursor: pointer;
    transition: opacity 0.1s;
}
.danger-btn {
    background: var(--accent-red);
    color: white;
    padding: 16px; border-radius: 14px; border: none;
    font-size: 17px; font-weight: 700;
    cursor: pointer;
    transition: opacity 0.1s;
}
.secondary-action, .cancel-btn {
    background: var(--secondary-bg);
    color: var(--primary-color);
    padding: 16px; border-radius: 14px; border: none;
    font-size: 17px; font-weight: 600;
    cursor: pointer;
}
.save-btn:active, .primary-action:active, .danger-btn:active { opacity: 0.8; }

/* --- 6. GALLERY GRID --- */
#gallery-grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 2px; 
    padding: 0 !important; 
    margin-top: 10px;
}
.gallery-item { 
    border-radius: 0; 
    aspect-ratio: 1/1; 
    position: relative;
    cursor: zoom-in;
}
.gallery-item img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    display: block;
}
.gallery-actions { 
    position: absolute; 
    top: 5px; 
    right: 5px;
    z-index: 10;
}
.gallery-actions button {
    background: rgba(0,0,0,0.5); 
    color: white; 
    border: none; 
    border-radius: 50%; 
    width: 24px; 
    height: 24px; 
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.image-preview { margin-top: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 10px; text-align: center; background: var(--secondary-bg); }

/* --- 7. SETTINGS --- */
.settings-group {
    padding: 0 15px;
    margin-bottom: 25px;
}
.settings-group h3 {
    font-size: 15px;
    color: var(--secondary-text-color);
    margin: 0 0 10px;
    text-transform: uppercase;
    font-weight: 600;
}
.settings-list {
    background: var(--card-bg);
    border-radius: 12px;
    border: 0.5px solid var(--border-color);
    overflow: hidden;
}
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 0.5px solid var(--border-color);
    cursor: pointer;
}
.setting-item:last-child { border-bottom: none; }
.setting-item label { 
    color: var(--text-color); 
    font-size: 16px;
    margin: 0;
    font-weight: 400;
}
.setting-action button {
    background: var(--secondary-bg);
    color: var(--primary-color);
    border: none;
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
}
.logout-action button {
    background: var(--accent-red);
    color: white;
}

/* The switch */
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--secondary-bg); transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 21px; width: 21px; left: 2px; bottom: 2px; background-color: var(--card-bg); transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: var(--accent-green); }
input:checked + .slider:before { transform: translateX(20px); }
.dark-mode .spinner { border: 4px solid var(--secondary-bg); }
.spinner { 
     border: 4px solid #F2F2F7; 
     border-top: 4px solid var(--primary-color); 
     border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; 
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.dashboard-nav-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    font-size: 17px;
    font-weight: 500;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.1s;
}
.dashboard-nav-card:active { background: var(--secondary-bg); }
.dark-mode .dashboard-nav-card:active { background: #2C2C2E; }

/* --- AI ASSISTANT STYLES --- */
#ai-assistant-modal .modal-content {
    padding: 0; display: flex; flex-direction: column; justify-content: space-between; max-height: 100%;
}
.chat-header {
    position: sticky; top: 0; padding: 20px 15px 10px; background-color: var(--card-bg); border-bottom: 0.5px solid var(--border-color); border-radius: 24px 24px 0 0; z-index: 10;
}
#chat-messages { flex-grow: 1; padding: 10px 15px; overflow-y: auto; scroll-behavior: smooth; }
.chat-input-area {
    display: flex; padding: 10px 15px calc(10px + var(--safe-bottom)); background-color: var(--card-bg); border-top: 0.5px solid var(--border-color);
}
#chat-input {
    flex-grow: 1; padding: 10px 12px; background: var(--secondary-bg) !important; border-radius: 20px !important; border: none !important; margin-right: 8px; font-size: 16px !important;
}
#chat-send-btn {
    background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.1s;
}
#chat-send-btn:active { opacity: 0.8; }
.chat-message { display: flex; margin-bottom: 10px; }
.chat-message.user { justify-content: flex-end; }
.chat-message.ai { justify-content: flex-start; }
.chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 20px; line-height: 1.4; font-size: 15px; }
.chat-message.user .chat-bubble { background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 5px; }
.chat-message.ai .chat-bubble { background-color: var(--chat-bubble-ai); color: var(--chat-text-ai); border-bottom-left-radius: 5px; }


/* === Modern iOS Dashboard Header === */
.dashboard-header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.dark-mode .dashboard-header {
    background: rgba(20,20,20,0.6);
    border-bottom-color: rgba(255,255,255,0.08);
}

/* Smaller buttons inside map list */
#map-list-container .primary-action,
#map-list-container .secondary-action,
#map-list-container .danger-btn {
    padding: 4px 8px !important;
    font-size: 12px !important;
}

</style>

<style>
/* === iOS Segmented Control === */
.ios-seg-wrapper {
    padding: 10px 15px 20px;
}
.ios-seg {
    display: flex;
    background: var(--card-bg, #f2f2f7);
    padding: 6px;
    border-radius: 14px;
    gap: 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.ios-seg-item {
    padding: 8px 14px;
    border-radius: 12px;
    white-space: nowrap;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-normal, #333);
    transition: all .25s ease;
}
.ios-seg-item.active {
    background: var(--primary-color) !important;
    color: #fff !important;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}
body.dark-mode .ios-seg {
    background: rgba(255,255,255,0.08);
}
body.dark-mode .ios-seg-item {
    color: #ccc;
}
body.dark-mode .ios-seg-item.active {
    background: var(--primary-color) !important;
    color: #fff !important;
    box-shadow: 0 3px 10px rgba(255,255,255,0.12);
}
</style>

<style>
/* Custom Profile Modal Styles (injected) */
.profile-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); backdrop-filter: blur(6px); z-index: 99999; }
.profile-modal .profile-modal-content { width: 92%; max-width: 360px; background: var(--card, #fff); padding: 16px; border-radius: 14px; box-shadow: 0 18px 40px rgba(2,6,23,0.12); text-align: center; }
.pm-title { margin: 0 0 10px 0; font-size: 16px; font-weight: 700; }
.pm-desc { margin: 0 0 14px 0; color: var(--muted,#6b7280); font-size: 14px; }
.pm-btn { display:block; width:100%; padding:10px 12px; margin:8px 0; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
.pm-btn.primary { background: var(--accent, #007AFF); color:white; }
.pm-btn.delete { background:#ff3b30; color:white; }
.pm-btn.ghost { background: transparent; color:var(--muted,#6b7280); border:1px solid rgba(0,0,0,0.06); }
.profile-modal .row { display:flex; gap:8px; }
.profile-modal .row .half { flex:1; }


/* confirm delete modal uses same styles */
</style>
<style>
/* upgraded soft blue and dark modal */
.pm-btn{display:block;width:100%;padding:12px;margin:8px 0;border-radius:12px;border:none;font-weight:600;font-size:15px;cursor:pointer;transition:.2s}
.pm-btn.primary{background:#3f7fff;color:#fff;box-shadow:0 0 8px rgba(63,127,255,.25)}
.pm-btn.delete{background:#ff4d4d;color:#fff;box-shadow:0 0 8px rgba(255,77,77,.25)}
.pm-btn.ghost{background:#2e2e2e;color:#cfcfcf;border:1px solid #4d4d4d}
.profile-modal .profile-modal-content{background:#151515;border-radius:18px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.7)}
.pm-title{color:#fff}
.pm-desc{color:#b5b5b5}
.toast{position:fixed;bottom:25px;left:50%;transform:translateX(-50%) translateY(60px);background:rgba(30,30,30,.9);padding:12px 20px;border-radius:14px;color:#fff;font-size:14px;opacity:0;transition:.3s;z-index:999999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>


<style>
/* === PROFILE AVATAR === */
.profile-avatar {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    overflow: hidden;
    background-color: var(--secondary-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    border: 2px solid rgba(255,255,255,0.1);
    
    /* Tambahan agar gambar tidak gepeng */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    flex-shrink: 0; /* Mencegah terhimpit elemen lain */
}


</style>
</head>
<body>

<!-- HEADER BARU FULL 1 BARIS (A3) -->
<div class="dashboard-header" style="
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
">

    <!-- KIRI: FOTO PROFIL + NAMA -->
    <div style="display: flex; align-items: center; gap: 12px;">
        <!-- Foto Profil -->
        <div id="profileAvatar" class="profile-avatar" onclick="openAvatarMenu()"></div>

        <!-- Nama User -->
        <div style="display:flex; flex-direction:column;">
    <h2 id="header-username" style="margin:0;padding:0;font-size:18px;font-weight:700;line-height:1;">Halo, User!</h2>
    <span style="margin:0;padding:0;font-size:13px;line-height:1.05;color:var(--secondary-text-color);">Kebunmu asetmu üå±</span>
</div>
    </div>

    <!-- KANAN: TOMBOL TAMBAH & SETTINGS -->
    <div style="display: flex; gap: 10px;">
        <button id="add-record-btn" onclick="showAddRecordOptions()">‚ûï</button>
        <button id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>

</div>

<div id="loading-indicator">
<div class="spinner"></div>
<p>Memuat data...</p>
</div>


<div id="login-screen">
<div class="login-container">
    <div style="font-size: 70px; margin-bottom: 10px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">ü™¥</div>
    <h1>My Garden</h1>
    <p id="login-message">Kelola kebunmu dengan mudah.</p>
    <p id="login-error" style="color: var(--accent-red); font-weight: 500; margin-top: -20px; margin-bottom: 20px; display: none;"></p>
    
    <input type="text" id="username" class="login-input" placeholder="Username">
    <input type="password" id="password" class="login-input" placeholder="Password">
    
    <button class="login-button" onclick="handleLogin()">Masuk</button>
    <button class="login-button" style="background: transparent; color: var(--primary-color); box-shadow: none; margin-top: 10px; font-weight: 600;" onclick="openRegisterModal()">Buat Akun Baru</button>
</div>
</div>

<div id="app" style="display: none;"> 
  <div class="ios-search-container">
    <span class="ios-search-icon">üîç</span>
    <input type="text" id="search-input" placeholder="Cari catatan, tanaman‚Ä¶">
</div>

<div id="content-container">
    <div id="dashboard-content" class="list-container" style="display: block;">
        </div>
    
    <div id="garden-list" style="display: none;">
        <div class="list-container" style="padding-top: 0; padding-bottom: 10px;">
            <button class="primary-action" style="margin-top: 0; padding: 14px; width: 100%;" onclick="openGardenModal()">‚ûï Tambah Kebun Baru</button>
        </div>
        <div id="garden-cards-container" class="list-container"></div>
    </div>
    
        <div id="poison-list" style="display: none;">
        <div class="list-container" style="padding-top: 0; padding-bottom: 10px;">
            <button class="primary-action" style="margin-top: 0; padding: 14px; width: 100%;" onclick="openPoisonModal()">Ô∏è‚ö†Ô∏è Tambah Stok Racun</button>
        </div>
        <div id="poison-cards-container" class="list-container"></div>
    </div>


    <div id="fertilizer-list" style="display: none;">
        <div class="list-container" style="padding-top: 0; padding-bottom: 10px;">
            <button class="primary-action" style="margin-top: 0; padding: 14px; width: 100%;" onclick="openFertilizerModal()">üõçÔ∏è Tambah Stok Pupuk</button>
        </div>
        <div id="fertilizer-cards-container" class="list-container"></div>
    </div>

    <div id="record-list" style="display: none; padding: 0;">
        </div>
    
    <div id="gallery-view" style="display: none;">
        <div class="list-container" style="padding-top: 0; padding-bottom: 10px;">
            <button class="primary-action" style="margin-top: 0; padding: 14px; width: 100%;" onclick="openGalleryModal()">üñºÔ∏è Tambah Foto Galeri Baru</button>
        </div>
        <div id="gallery-grid"></div>
    </div>

    <div id="settings-view" style="display: none;">
         </div>
</div>


<div id="map-view" style="display: none; padding: 10px;">
    <div id="map-menu-container" style="padding: 0 16px 12px;">
            <h2 style="margin:0 0 8px; font-size:20px;">Peta Kebun</h2>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <button class="primary-action" onclick="openMapForm()">‚ûï Tambah Peta Baru</button>
                <button class="secondary-action" onclick="renderMapList()">üìã Daftar Peta</button>
            </div>
            <div id="map-list-container"></div>
        </div>

        <div id="map-canvas-area" style="display:none; position:relative; height: calc(100vh - 220px); margin: 0; background: #086f3e; border-radius: 8px; overflow: hidden; border:1px solid var(--border-color);">
            <!-- full-screen green map area -->
            <div id="map-viewport" style="width:100%; height:100%; transform-origin: 0 0; touch-action: none; position: absolute; left:0; top:0;">
                <div id="map-inner" style="position: absolute; left:0; top:0; width:2000px; height:1200px; background: linear-gradient(#086f3e,#086f3e);">
                    <!-- trees will be appended here -->
                </div>
            </div>
<div id="default-map-controls" style="position:absolute; right:10px; top:10px; display:flex; gap:4px; z-index:100; align-items: center; max-width: 98vw;">
    
    <div style="display:flex; gap:1px;">
        <button class="nav-btn" onclick="zoomMap(1.2)" style="width:30px; height:30px; font-size:14px; padding:0;">Ôºã</button>
        <button class="nav-btn" onclick="zoomMap(0.8)" style="width:32px; height:32px; font-size:14px; padding:0;">Ôºç</button>
        <button id="btn-select-mode" class="nav-btn" onclick="toggleMultiSelect()" style="width:32px; height:32px; font-size:14px; padding:0;">‚úÖ</button>
        <button class="nav-btn" onclick="exportMapToImage()" style="width:32px; height:32px; font-size:14px; padding:0;">üì∏</button>
    </div>

    <div style="display:flex; gap:4px; align-items: center;">
        <button class="main-action-btn" onclick="addTreePrompt()" style="padding: 0 8px; height: 32px; font-size: 11px; white-space: nowrap;">üå± Tambah</button>
        <button class="main-action-btn" onclick="addNewText()" style="padding: 0 8px; height: 32px; font-size: 11px; background: #4f46e5; white-space: nowrap;">‚úé Teks</button>
        <button class="close-btn" onclick="closeMapView()" style="padding: 0 8px; height: 32px; font-size: 11px; background: #dc2626; white-space: nowrap;">Tutup</button>
    </div>
</div>


<style>
    /* Biar scrollbar-nya gak muncul ngerusak pemandangan */
    div::-webkit-scrollbar {
        display: none;
    }
</style>

<div id="text-dialog-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:20px; border-radius:15px; width:85%; max-width:320px; border: 1px solid #333;">
        <h3 id="dialog-title" style="margin-top:0; color:#eee; font-size:18px;">Tambah Teks</h3>
        
        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Isi Teks:</label>
        <input type="text" id="dialog-text-input" style="width:100%; padding:10px; margin-bottom:12px; border:1px solid #444; border-radius:8px; background:#252525; color:white; outline:none;" placeholder="Ketik sesuatu...">
        
        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Ukuran Teks (px):</label>
        <input type="number" id="dialog-size-input" value="25" min="10" max="200" style="width:100%; padding:10px; margin-bottom:12px; border:1px solid #444; border-radius:8px; background:#252525; color:white; outline:none;">

        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px; gap:10px;">
            <div style="flex:1;">
                <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Warna:</label>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                    <div onclick="setDialogColor('#ffffff')" style="background:#fff; height:22px; border-radius:4px; cursor:pointer;"></div>
                    <div onclick="setDialogColor('#ffff00')" style="background:#ff0; height:22px; border-radius:4px; cursor:pointer;"></div>
                    <input type="color" id="dialog-color-input" style="width:100%; height:22px; border:none; background:none; padding:0; cursor:pointer;">
                </div>
            </div>
            <div style="text-align:center;">
                <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Lock:</label>
                <button id="btn-lock-text" onclick="toggleTextLock()" style="background:#252525; border:1px solid #444; padding:4px 12px; border-radius:8px; font-size:18px; cursor:pointer;">üîì</button>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; gap:8px;">
                <button onclick="closeTextDialog()" style="flex:1; padding:12px; background:#333; color:#ccc; border:none; border-radius:8px; font-size:14px; cursor:pointer;">Batal</button>
                <button onclick="confirmTextDialog()" style="flex:2; padding:12px; background:#4f46e5; color:white; border:none; border-radius:8px; font-weight:bold; font-size:14px; cursor:pointer;">Simpan</button>
            </div>
            <button id="btn-delete-text" onclick="deleteTextAction()" style="display:none; width:100%; padding:8px; background:rgba(220, 38, 38, 0.1); color:#ef4444; border:1px solid #7f1d1d; border-radius:8px; font-size:12px; cursor:pointer;">Hapus Teks</button>
        </div>
    </div>
</div>


<div id="confirm-dialog-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:25px; border-radius:15px; width:80%; max-width:280px; text-align:center; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <div id="confirm-icon" style="font-size:40px; margin-bottom:15px;">‚ö†Ô∏è</div>
        <p id="confirm-message" style="color:white; margin-bottom:25px; font-size:14px; line-height:1.5;">Apakah Anda yakin?</p>
        
        <div style="display:flex; gap:10px;">
            <button id="btn-confirm-cancel" onclick="closeCustomConfirm()" style="flex:1; padding:12px; background:#333; color:#ccc; border:none; border-radius:8px; cursor:pointer;">Batal</button>
            <button id="btn-confirm-ok" style="flex:1; padding:12px; background:#4f46e5; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Oke</button>
        </div>
    </div>
</div>





        </div>
    </div>
    
<div id="multi-select-bar" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(28,28,30,0.95); padding:8px 14px; border-radius:40px; z-index:1000; box-shadow:0 8px 20px rgba(0,0,0,0.4); align-items:center; gap:8px; backdrop-filter:blur(15px); border:1px solid rgba(255,255,255,0.1); width:max-content; max-width:95%;">
    
    <span id="select-count" style="color:#fff; font-weight:600; margin-right:4px; font-size:12px; white-space:nowrap;">0 Terpilih</span>
    
    <button onclick="copySelectedTrees()" style="background:#007AFF; color:#fff; border:none; padding:6px 12px; border-radius:15px; font-weight:600; font-size:12px; cursor:pointer;">üìã Copy</button>
    
    <button onclick="lockSelectedTrees()" style="background:#FF9500; color:#fff; border:none; padding:6px 12px; border-radius:15px; font-weight:600; font-size:12px; cursor:pointer;">üîí Lock/Unlock</button>
    
    <button onclick="deleteSelectedTrees()" style="background:#FF3B30; color:#fff; border:none; padding:6px 12px; border-radius:15px; font-weight:600; font-size:12px; cursor:pointer;">üóëÔ∏è Hapus</button>
    
    <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 2px;"></div>
    
    <button onclick="cancelMultiSelect()" style="background:transparent; color:#bbb; border:none; padding:6px 8px; font-size:12px; cursor:pointer;">Batal</button>
</div>



<div class="tab-nav" id="tab-nav">
    <button class="tab-button active" data-type="Dashboard">Dashboard</button>
    <button class="tab-button" data-type="Daftar Kebun">Daftar Kebun</button>
    <button class="tab-button" data-type="Daftar Pupuk">Stok Pupuk</button>
    <button class="tab-button" data-type="Daftar Racun">Stok Racun</button>
    <button class="tab-button" data-type="Daftar Catatan">Daftar Catatan</button>
    <button class="tab-button" data-type="Galeri Tanaman">Galeri Tanaman</button>
    <button class="tab-button" data-type="Peta">Peta</button>
    <button class="tab-button" data-type="Keuangan">Keuangan</button>
</div>
</div>

<div id="record-modal" class="modal">
<div class="modal-content">
     </div>
</div>

<div id="preview-modal" class="modal">
<div class="modal-content">
    <h2 id="preview-title">Detail Catatan</h2>
    <div id="preview-content"></div> 
    <div id="garden-detail-content"></div> 
</div>
</div>


<!-- FULL-SHEET MODAL (FORMS) -->
<div id="sheet-modal" class="modal" style="align-items: flex-end; padding:0;">
  <div class="modal-content" style="border-radius: 18px 18px 0 0; max-height: 85vh; width:100%;">
    <div id="sheet-inner" style="padding:16px 18px; overflow:auto;"></div>
  </div>
</div>

<div id="custom-dialog" class="modal" style="z-index:999999;position:fixed;">
<div class="modal-content" style="text-align: center;">
    <h2 id="dialog-title">My Garden Form</h2>
    <p id="dialog-message"></p>
    <div class="form-actions" id="dialog-actions"></div>
</div>
</div>

<div id="add-options-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;" id="add-options-title">Pilih Kebun</h2>
    <div id="garden-selection-area"></div>
</div>
</div>

<div id="gallery-add-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;">Tambah Foto Galeri</h2>
    <form id="gallery-form" onsubmit="handleGallerySubmit(event)">
        <input type="hidden" id="gallery-photo-id">
        <div class="form-group"><label for="gallery-plant-name">Nama Tanaman</label><input type="text" id="gallery-plant-name" placeholder="Contoh: Lidah Buaya" required></div>
        
        <div class="form-group">
            <label for="gallery-photo-file">Foto (File)</label>
            <input type="file" id="gallery-photo-file" accept="image/*" style="margin-bottom: 10px;" onchange="updatePerawatanPhotoPreview(null, this.files[0], 'gallery')">
            <label for="gallery-photo-url">Atau URL Foto</label>
            <input type="text" id="gallery-photo-url" placeholder="Masukkan URL Foto" oninput="previewPerawatanPhoto('gallery')">
            <div class="image-preview" id="photo-preview-gallery"></div>
        </div>

        <div class="form-actions">
            <button type="submit" class="save-btn">Simpan Foto</button>
            <button type="button" class="cancel-btn" onclick="closeModal('gallery-add-modal')">Batal</button>
        </div>
    </form>
</div>
</div>

<div id="register-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;">Daftar Akun Baru</h2>
    <form id="register-form" onsubmit="handleRegister(event)">
        <div class="form-group"><label for="reg-username">Username <span style="color: var(--accent-red);">*</span></label><input type="text" id="reg-username" required></div>
        <div class="form-group"><label for="reg-password">Password <span style="color: var(--accent-red);">*</span></label><input type="password" id="reg-password" required></div>
        <div class="form-actions">
            <button type="submit" class="save-btn">Daftar</button>
        <button type="button" class="cancel-btn" onclick="handleCancelRegistration()">Batal</button>

        </div>
    </form>
</div>
</div>

<div id="change-profile-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;">Ubah Profil Anda</h2>
    <p id="profile-error-message" style="color: var(--accent-red); margin-bottom: 15px; text-align: center; display: none; font-weight: 500;"></p>
    <form id="change-profile-form" onsubmit="handleChangeProfile(event)">
        <div class="form-group"><label for="new-username">Username Baru</label><input type="text" id="new-username" required></div>
        <div class="form-group"><label for="current-password">Password Saat Ini <span style="color: var(--accent-red);">*</span></label><input type="password" id="current-password" required></div>
        <div class="form-group"><label for="new-password">Password Baru (Kosongkan jika tidak diubah)</label><input type="password" id="new-password"></div>
        <div class="form-actions">
            <button type="submit" class="save-btn">Simpan Perubahan</button>
            <button type="button" class="cancel-btn" onclick="closeModal('change-profile-modal')">Batal</button>
        </div>
    </form>
</div>
</div>

<div id="garden-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;" id="garden-modal-title">Tambah Kebun Baru</h2>
    <form id="garden-form" onsubmit="handleGardenSubmit(event)">
        <input type="hidden" id="garden-id">
        <div class="form-group"><label for="garden-title">Judul Kebun <span style="color: var(--accent-red);">*</span></label><input type="text" id="garden-title" placeholder="Contoh: Kebun Sayur Belakang Rumah" required></div>
        <div class="form-group"><label for="garden-date-tanam">Tanggal Tanam/Mulai</label><input type="date" id="garden-date-tanam"></div> 
        <div class="form-group"><label for="garden-plant-count">Jumlah Tanaman</label><input type="number" id="garden-plant-count" min="0" value="0"></div>
        <div class="form-group"><label for="garden-varieties">Varietas Utama</label><input type="text" id="garden-varieties" placeholder="Contoh: Cabai Merah, Tomat Cherry"></div>
        <div class="form-group"><label for="garden-area">Luas Lahan (m¬≤)</label><input type="number" id="garden-area" step="0.01" min="0" value="0"></div>
        <div class="form-actions">
            <button type="submit" class="save-btn">Simpan Kebun</button>
            <button type="button" class="cancel-btn" onclick="closeModal('garden-modal')">Batal</button>
        </div>
    </form>
</div>
</div>

<div id="fertilizer-inventory-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;" id="fertilizer-modal-title">Tambah Stok Pupuk</h2>
    <form id="fertilizer-inventory-form" onsubmit="handleFertilizerSubmit(event)">
        <input type="hidden" id="fertilizer-inv-id">
        <div class="form-group"><label for="fertilizer-inv-name">Nama Pupuk <span style="color: var(--accent-red);">*</span></label><input type="text" id="fertilizer-inv-name" placeholder="Contoh: NPK Mutiara 16-16-16" required></div>
        <div class="form-group"><label for="fertilizer-inv-date">Tanggal Beli</label><input type="date" id="fertilizer-inv-date"></div>
        <div class="form-group">
            <label for="fertilizer-inv-price-display">Harga (Rp)</label>
            <input type="text" id="fertilizer-inv-price-display" placeholder="Contoh: 150.000" oninput="formatCostInput(this, 'fertilizer-inv-price')" inputmode="numeric">
            <input type="hidden" id="fertilizer-inv-price">
        </div>
        <div class="form-group"><label for="fertilizer-inv-weight">Berat / Isi (kg) <span style="color: var(--accent-red);">*</span></label><input type="number" id="fertilizer-inv-weight" step="0.01" min="0" placeholder="Contoh: 50" required></div>
        
        <div class="form-actions">
            <button type="submit" class="save-btn">Simpan Stok</button>
            <button type="button" class="cancel-btn" onclick="closeModal('fertilizer-inventory-modal')">Batal</button>
        </div>
    </form>
</div>
</div>

<div id="poison-inventory-modal" class="modal">
<div class="modal-content">
    <h2 style="margin-top: 0;" id="poison-modal-title">Tambah Stok Racun</h2>
    <form id="poison-inventory-form" onsubmit="handlePoisonSubmit(event)">
        <input type="hidden" id="poison-inv-id">
        <div class="form-group"><label for="poison-inv-name">Nama Racun <span style="color: var(--accent-red);">*</span></label><input type="text" id="poison-inv-name" placeholder="Contoh: Herbisida RoundUp" required></div>
        <div class="form-group"><label for="poison-inv-date">Tanggal Beli</label><input type="date" id="poison-inv-date"></div>
        <div class="form-group">
            <label for="poison-inv-price-display">Harga (Rp)</label>
            <input type="text" id="poison-inv-price-display" placeholder="Contoh: 150.000" oninput="formatCostInput(this, 'poison-inv-price')" inputmode="numeric">
            <input type="hidden" id="poison-inv-price">
        </div>
        <div class="form-group"><label for="poison-inv-weight">Berat / Isi (Liter/L) <span style="color: var(--accent-red);">*</span></label><input type="number" id="poison-inv-weight" step="0.01" min="0" placeholder="Contoh: 1L" required></div>
        
        <div class="form-actions">
            <button type="submit" class="save-btn">Simpan Stok</button>
            <button type="button" class="cancel-btn" onclick="closeModal('poison-inventory-modal')">Batal</button>
        </div>
    </form>
</div>
</div>

<div id="ai-assistant-modal" class="modal">
<div class="modal-content">
    <div class="chat-header">
        <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center;">ü§ñ Asisten AI</h2>
        <p style="margin: 5px 0 0; font-size: 13px; color: var(--secondary-text-color); text-align: center;">Tanya tentang seputar kebun/tanaman.</p>
        <button type="button" class="cancel-btn" onclick="closeModal('ai-assistant-modal')" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 14px; background: var(--secondary-bg); color: var(--primary-color);">Tutup</button>
    </div>
    
    <div id="chat-messages">
        </div>
    
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ketik pesan...">
        <button id="chat-send-btn" onclick="sendChatMessage()">
            <span style="display: block; transform: rotate(45deg);">‚û§</span>
        </button>
    </div>
</div>
</div>

<div id="finance-view" style="display: none; padding-bottom: 100px;">
    <div class="finance-header-glass">
        <div style="display:flex; justify-content:space-between; align-items:center; padding: 16px 20px 8px;">
            <h1 class="finance-title">Keuangan</h1>
            <button onclick="openFinanceModal()" style="background:var(--primary-color); color:white; border:none; width:36px; height:36px; border-radius:50%; font-size:20px; font-weight:bold; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,122,255,0.3);">+</button>
        </div>
        
<div class="filter-scroll-wrapper">
    <button class="ios-chip active" onclick="setFinanceFilter('all', this)">Semua</button>
    <button class="ios-chip" onclick="setFinanceFilter('week', this)">Minggu Ini</button>
    <button class="ios-chip" onclick="setFinanceFilter('month', this)">Bulan</button>
    <button class="ios-chip" onclick="setFinanceFilter('year', this)">Tahun</button>
    <button class="ios-chip" onclick="openCustomDateFilter(event)">üìÖ Kustom</button>
</div>

    </div>

    <div id="custom-date-filter" style="display:none; padding: 16px; margin: 0 16px 16px; background: var(--card-bg); border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 1px solid rgba(125,125,125,0.1);">
        <div style="display:flex; gap:12px;">
            <div style="flex:1;">
                <label style="font-size:10px; font-weight:bold; color:var(--secondary-text-color); margin-left:4px;">MULAI</label>
                <input type="date" id="filter-start-date" style="width:100%; border:none; background:var(--card-bg-alt); color:var(--text-color); padding:10px; border-radius:10px; font-family:inherit;">
            </div>
            <div style="flex:1;">
                <label style="font-size:10px; font-weight:bold; color:var(--secondary-text-color); margin-left:4px;">SAMPAI</label>
                <input type="date" id="filter-end-date" style="width:100%; border:none; background:var(--card-bg-alt); color:var(--text-color); padding:10px; border-radius:10px; font-family:inherit;">
            </div>
        </div>
        <button onclick="applyCustomFilter()" style="width:100%; margin-top:12px; background:var(--text-color); color:var(--bg-color); border:none; padding:12px; border-radius:12px; font-weight:700; font-size:14px;">Terapkan Filter</button>
    </div>

    <div class="finance-card-premium">
        <div style="position:relative; z-index:2;">
            <p style="margin:0; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1.5px; opacity:0.7;">Total Pengeluaran</p>
            <h1 id="finance-total-display" style="margin:8px 0; font-size:36px; font-weight:800; letter-spacing:-1px;">Rp 0</h1>
            <div id="finance-filter-label" style="display:inline-block; background:rgba(255,255,255,0.15); padding:4px 12px; border-radius:10px; font-size:10px; font-weight:700; backdrop-filter:blur(5px);">Semua Waktu</div>
        </div>
        <div style="position:absolute; bottom:-10px; right:-10px; font-size:100px; opacity:0.1; transform: rotate(-15deg);">üí∞</div>
    </div>

    <div id="finance-list-container"></div>
</div>

<div id="finance-modal" class="modal">
    <div class="modal-content">
        <h2 id="finance-modal-title" style="margin-top:0; color:var(--text-color);">Catat Pengeluaran</h2>
        <form id="finance-form" onsubmit="handleFinanceSubmit(event)">
            <input type="hidden" id="finance-id">
            <div class="form-group">
                <label>Nama Barang / Keperluan</label>
                <input type="text" id="finance-name" required placeholder="Contoh: Beli Pupuk NPK">
            </div>
            <div class="form-group">
                <label>Tanggal</label>
                <input type="date" id="finance-date" required>
            </div>
            <div class="form-group">
                <label>Nominal (Rp)</label>
                <input type="text" id="finance-price-display" inputmode="numeric" oninput="formatFinanceCurrency(this)" required placeholder="0" style="font-size: 20px; font-weight: bold; color: var(--primary-color);">
                <input type="hidden" id="finance-price-value">
            </div>
            <div class="form-group">
                <label>Catatan (Opsional)</label>
                <textarea id="finance-notes" rows="2"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="save-btn">Simpan</button>
                <button type="button" class="cancel-btn" onclick="closeModal('finance-modal')">Batal</button>
            </div>
        </form>
    </div>
</div>


<script>


// --- JAVASCRIPT LOGIC START --

// --- PERBAIKAN FITUR PETA KASTRASI ---

function viewRecordMap(recordId) {
    const record = records.find(r => r.id === recordId);
    if (!record || !record.selectedTreeIds) {
        showToast("Data pohon tidak ditemukan.");
        return;
    }

    // Cari Peta berdasarkan referensi kebun di catatan
    const map = maps.find(m => m.gardenId === record.gardenIdReference);
    if (!map) {
        showCustomDialog("Peta Tidak Ada", "Peta untuk kebun ini tidak ditemukan.", null, "OK");
        return;
    }

    // 1. SET GLOBAL ACTIVE MAP (KUNCI AGAR BISA DIGESER/PANNING)
    // Tanpa baris ini, event listener di 'map-canvas-area' akan return false.
    activeMap = map; 

    // 2. Tutup modal preview agar tidak menghalangi
    closeModal('preview-modal');
    
    // 3. Sembunyikan semua menu konten utama
    ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'finance-view', 'settings-view'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });

    // 4. Tampilkan Area Peta
    document.getElementById('map-view').style.display = 'block';
    document.getElementById('map-menu-container').style.display = 'block';
    document.getElementById('map-canvas-area').style.display = 'block';
    
    // Aktifkan class editor agar kursor grab aktif
    document.body.classList.add('editor-active');

    // 5. SEMBUNYIKAN KONTROL PETA BAWAAN (Edit, Tambah, Select Mode, dll)
    const defaultControls = document.getElementById('default-map-controls');
    if(defaultControls) defaultControls.style.display = 'none';

    // 6. BUAT KONTROL KHUSUS KASTRASI (Zoom & Tutup Saja)
    let kastrasiControls = document.getElementById('kastrasi-map-controls');
    if (!kastrasiControls) {
        kastrasiControls = document.createElement('div');
        kastrasiControls.id = 'kastrasi-map-controls';
        // Style mirip tombol peta asli tapi khusus
        kastrasiControls.style.cssText = "position:fixed; top:20px; right:20px; z-index:999999; display:flex; flex-direction:column; gap:10px; align-items:flex-end;";
        document.body.appendChild(kastrasiControls);
    }
    
    // Isi tombol khusus (Zoom In, Zoom Out, Tutup Merah)
    kastrasiControls.innerHTML = `
    <div style="position: fixed; top: 15px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 8px; padding: 0 15px; pointer-events: none;">
        <div style="display: flex; background: rgba(255, 255, 255, 0.95); padding: 4px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); backdrop-filter: blur(5px); pointer-events: auto; border: 1px solid rgba(0,0,0,0.05);">
            <button onclick="zoomMap(1.2)" style="width: 36px; height: 36px; background: none; border: none; font-size: 18px; color: #333; display: flex; align-items: center; justify-content: center;">Ôºã</button>
            <div style="width: 1px; height: 20px; background: #ddd; margin: 8px 2px;"></div>
            <button onclick="zoomMap(0.8)" style="width: 36px; height: 36px; background: none; border: none; font-size: 18px; color: #333; display: flex; align-items: center; justify-content: center;">Ôºç</button>
        </div>
        <button onclick="closeRecordMapView('${recordId}')" style="pointer-events: auto; background: #FF3B30; color: white; border: none; padding: 0 15px; height: 44px; border-radius: 10px; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 12px rgba(255, 59, 48, 0.25);">
            <span style="font-size: 14px;">‚úï</span> Tutup Peta
        </button>
    </div>
`;
kastrasiControls.style.display = 'block';


    // 7. Render Peta & Pohon
    const mapViewport = document.getElementById('map-viewport');
    const mapInner = document.getElementById('map-inner');
    
    // Reset Zoom ke posisi default
    mapScale = 0.8; 
    mapTranslate = {x: 0, y: 0};
    mapViewport.style.transform = `translate(0px, 0px) scale(${mapScale})`;
    
    mapInner.innerHTML = '';
    
    map.trees.forEach(tree => {
        const isCastrated = record.selectedTreeIds.includes(tree.id);
        const el = document.createElement('div');
        
        // Render visual: Merah Besar (Kastrasi), Hijau Transparan (Normal)
        el.style.cssText = `
            position: absolute; left: ${tree.x}px; top: ${tree.y}px;
            width: 50px; height: 50px; border-radius: 50%;
            background: ${isCastrated ? '#FF3B30' : 'rgba(52,199,89,0.15)'};
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            box-shadow: ${isCastrated ? '0 0 20px rgba(255, 59, 48, 0.8)' : 'none'};
            z-index: ${isCastrated ? 100 : 1};
            border: ${isCastrated ? '3px solid white' : '1px solid rgba(255,255,255,0.1)'};
            transform: scale(${isCastrated ? 1.2 : 0.8});
            pointer-events: none; /* Biar tidak mengganggu drag peta */
        `;
        
        el.innerHTML = isCastrated ? '‚úÇÔ∏è' : 'üå≥';
        mapInner.appendChild(el);
    });

    // Render teks juga agar peta lengkap (opsional, visual only)
    if(map.texts) {
        map.texts.forEach(t => {
            const el = document.createElement('div');
            el.innerText = t.content;
            el.style.cssText = `position:absolute; left:${t.x}px; top:${t.y}px; color:${t.color}; font-size:${t.fontSize}px; font-weight:bold; pointer-events:none; text-shadow:2px 2px 4px black;`;
            mapInner.appendChild(el);
        });
    }
}

function closeRecordMapView(recordId) {
    // 1. Matikan Active Map & Bersihkan State Editor
    activeMap = null; 
    document.body.classList.remove('editor-active');
    
    // 2. Sembunyikan Area Peta
    document.getElementById('map-canvas-area').style.display = 'none';
    document.getElementById('map-view').style.display = 'none';
    
    // 3. Hapus Kontrol Khusus Kastrasi
    const kastrasiControls = document.getElementById('kastrasi-map-controls');
    if(kastrasiControls) kastrasiControls.remove();

    // 4. Munculkan Kembali Kontrol Peta Bawaan (Reset State untuk Peta Biasa)
    const defaultControls = document.getElementById('default-map-controls');
    if(defaultControls) defaultControls.style.display = 'flex';
    
    // 5. KUNCI PERBAIKAN NAVIGASI (FIX BLANK SCREEN)
    // Jangan hanya memunculkan 'record-list', tapi panggil renderContent
    // agar sistem mengecek kita sedang di tab mana (Dashboard, Kebun, atau Catatan)
    // dan memunculkan halaman yang benar.
    if (typeof renderContent === 'function') {
        renderContent(currentRecordType || 'Dashboard');
    } else {
        // Fallback jika terjadi error
        document.getElementById('dashboard-content').style.display = 'block';
    }
    
    // 6. Buka kembali modal detail catatan (UX yang baik)
    if(recordId) {
        setTimeout(() => {
            previewRecord(recordId);
        }, 100);
    }
}

function closeRecordMapView(recordId) {
    // 1. Reset State Peta
    activeMap = null; 
    document.body.classList.remove('editor-active');
    
    // 2. Sembunyikan Area Peta & Container Peta Utama
    document.getElementById('map-canvas-area').style.display = 'none';
    document.getElementById('map-view').style.display = 'none'; // PENTING: Ini yang menutupi dashboard
    
    // 3. HAPUS KONTROL KASTRASI (FIX TOMBOL NYANGKUT)
    const kastrasiControls = document.getElementById('kastrasi-map-controls');
    if(kastrasiControls) {
        kastrasiControls.remove(); // Kita hapus dari DOM, bukan cuma hide
    }

    // 4. RESTORE KONTROL PETA BAWAAN (Agar normal saat buka menu Peta nanti)
    const defaultControls = document.getElementById('default-map-controls');
    if(defaultControls) defaultControls.style.display = 'flex';
    
    // 5. RESTORE TAMPILAN DASHBOARD (FIX DASHBOARD HILANG)
    // Kita paksa render ulang halaman terakhir yang dibuka.
    // Jika tidak ada history, paksa ke 'Dashboard'.
    const targetPage = currentRecordType && currentRecordType !== 'Peta' ? currentRecordType : 'Dashboard';
    
    // Panggil fungsi render utama aplikasi untuk menampilkan kembali div yang sesuai
    if (typeof renderContent === 'function') {
        renderContent(targetPage);
    } else {
        // Fallback manual jika renderContent error
        document.getElementById('dashboard-content').style.display = 'block';
        document.getElementById('app').style.display = 'block';
    }
    
    // 6. Buka kembali modal detail catatan (UX)
    if(recordId) {
        setTimeout(() => {
            const modal = document.getElementById('preview-modal');
            if(modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10);
                // Kita panggil previewRecord lagi untuk memastikan data fresh
                previewRecord(recordId);
            }
        }, 100);
    }
}



// --- LOGIKA SELEKSI POHON UNTUK KASTRASI ---
let isRecordSelectMode = false;
let tempRecordTreeIds = [];

function openTreeSelectorForRecord() {
    const gardenId = document.getElementById('garden-id-reference').value;
    
    // Validasi Kebun
    if (!gardenId) {
        showToast("Pilih nama Kebun terlebih dahulu di kolom paling atas!");
        return;
    }

    // Cari peta berdasarkan ID Kebun
    const map = maps.find(m => m.gardenId === gardenId);
    
    if (!map) {
        showCustomDialog("Peta Tidak Ditemukan", "Kebun ini belum memiliki peta. Silakan buat peta baru di menu 'Peta' terlebih dahulu.", null, "OK");
        return;
    }

    // Persiapkan Data Seleksi
    const currentIds = document.getElementById('selected-tree-ids').value;
    tempRecordTreeIds = currentIds ? JSON.parse(currentIds) : [];
    
    // Set Map Aktif
    activeMap = map;
    isRecordSelectMode = true; 
    
    // Sembunyikan Modal Record Sementara (Biar gak nutupin peta)
    document.getElementById('record-modal').style.display = 'none';
    
    // --- PERBAIKAN DISPLAY DISINI ---
    // 1. Sembunyikan konten lain di background (Dashboard, List, dll)
    ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'finance-view', 'settings-view'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });

    // 2. Tampilkan Container Utama Peta (#map-view) DULUAN
    document.getElementById('map-view').style.display = 'block'; 

    // 3. Di dalam map-view, sembunyikan menu list, tampilkan kanvas
    document.getElementById('map-menu-container').style.display = 'none';
    document.getElementById('map-canvas-area').style.display = 'block';
    // --------------------------------

    document.body.classList.add('editor-active');
    
    // Reset Zoom & Pan agar peta pas di tengah
    mapScale = 1; 
    mapTranslate = {x: 0, y: 0};
    const mapViewport = document.getElementById('map-viewport');
    const mapInner = document.getElementById('map-inner');
    
    if(mapViewport) mapViewport.style.transform = `translate(0px, 0px) scale(1)`;
    
    // Render Pohon Mode Seleksi
    if(mapInner) {
        mapInner.innerHTML = '';
        if (activeMap.trees) {
            activeMap.trees.forEach(t => renderTreeForSelection(t));
        }
    }

    // Tampilkan Floating Bar
    showSelectionFloatingBar();
}

function showSelectionFloatingBar() {
    // Buat UI Bar melayang
    let bar = document.getElementById('record-select-bar');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'record-select-bar';
        bar.style.cssText = "position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); padding:10px 20px; border-radius:30px; display:flex; gap:15px; align-items:center; z-index:99999; backdrop-filter:blur(5px); box-shadow:0 10px 30px rgba(0,0,0,0.5);";
        document.body.appendChild(bar);
    }
    
    updateSelectionBarUI();
}

function updateSelectionBarUI() {
    const defaultControls = document.getElementById('default-map-controls');
    if(defaultControls) defaultControls.style.display = 'none';
    const bar = document.getElementById('record-select-bar');
    if(bar) {
        bar.innerHTML = `
            <span style="color:white; font-weight:bold;">${tempRecordTreeIds.length} Dipilih</span>
            <button onclick="confirmTreeSelection()" style="background:#34C759; border:none; color:white; padding:8px 16px; border-radius:20px; font-weight:bold; cursor:pointer;">‚úÖ Selesai</button>
            <button onclick="cancelTreeSelection()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 12px; border-radius:20px; font-size:12px; cursor:pointer;">Batal</button>
        `;
        bar.style.display = 'flex';
    }
}

// Render Pohon Khusus Mode Seleksi (Beda dengan renderTreeElement biasa)
function renderTreeForSelection(tree) {
    const mapInner = document.getElementById('map-inner');
    const el = document.createElement('div');
    const isSelected = tempRecordTreeIds.includes(tree.id);

    el.className = 'map-tree-select';
    el.style.cssText = `
        position: absolute; left: ${tree.x}px; top: ${tree.y}px;
        width: 48px; height: 48px; border-radius: 50%;
        background: ${isSelected ? '#FF3B30' : 'rgba(52,199,89,0.5)'};
        border: ${isSelected ? '3px solid white' : 'none'};
        box-shadow: ${isSelected ? '0 0 15px rgba(255, 59, 48, 0.8)' : 'none'};
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; cursor: pointer; user-select: none;
        transform: scale(${isSelected ? 1.2 : 1});
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    `;
    
    el.innerHTML = isSelected ? '‚úÇÔ∏è' : 'üå≥';

    // Click Event: Toggle Seleksi
    el.onclick = (e) => {
        e.stopPropagation();
        const idx = tempRecordTreeIds.indexOf(tree.id);
        if (idx > -1) {
            tempRecordTreeIds.splice(idx, 1); // Unselect
            el.style.background = 'rgba(52,199,89,0.5)';
            el.style.border = 'none';
            el.style.transform = 'scale(1)';
            el.innerHTML = 'üå≥';
            el.style.boxShadow = 'none';
        } else {
            tempRecordTreeIds.push(tree.id); // Select
            el.style.background = '#FF3B30';
            el.style.border = '3px solid white';
            el.style.transform = 'scale(1.2)';
            el.innerHTML = '‚úÇÔ∏è';
            el.style.boxShadow = '0 0 15px rgba(255, 59, 48, 0.8)';
        }
        updateSelectionBarUI();
    };

    mapInner.appendChild(el);
}

function confirmTreeSelection() {
    // Simpan ke Hidden Input Form
    document.getElementById('selected-tree-ids').value = JSON.stringify(tempRecordTreeIds);
    
    // Update Teks di Form
    const countLabel = document.getElementById('tree-selection-count');
    if(countLabel) countLabel.innerText = `${tempRecordTreeIds.length} Pohon Dipilih`;
    
    closeSelectionMode();
}

function cancelTreeSelection() {
    closeSelectionMode();
}

function closeSelectionMode() {
    isRecordSelectMode = false;
    
    // --- PERBAIKAN DISPLAY DISINI ---
    // 1. Sembunyikan Area Kanvas
    document.getElementById('map-canvas-area').style.display = 'none';
    
    // 2. Sembunyikan Container Utama Peta (#map-view) juga
    document.getElementById('map-view').style.display = 'none';
    
    // 3. Kembalikan Menu List Peta (untuk jaga-jaga saat buka menu Peta nanti)
    document.getElementById('map-menu-container').style.display = 'block';
    // --------------------------------

    document.body.classList.remove('editor-active');
    
    const bar = document.getElementById('record-select-bar');
    if(bar) bar.style.display = 'none';
    
    // Tampilkan kembali Modal Record
    const recordModal = document.getElementById('record-modal');
    recordModal.style.display = 'flex';
    
    // Render ulang konten di belakang modal (misal: Daftar Catatan) agar tidak blank hitam
    // Cek variabel global currentRecordType
    if (typeof currentRecordType !== 'undefined' && currentRecordType) {
        // Kita panggil renderContent secara manual tapi jangan reset modal
        // Cukup tampilkan div backgroundnya saja
        const bgIdMap = {
            'Dashboard': 'dashboard-content',
            'Daftar Kebun': 'garden-list',
            'Daftar Catatan': 'record-list',
            'Daftar Pupuk': 'fertilizer-list',
            'Daftar Racun': 'poison-list',
            'Keuangan': 'finance-view',
            'Galeri Tanaman': 'gallery-view'
        };
        const bgId = bgIdMap[currentRecordType];
        if(bgId && document.getElementById(bgId)) {
            document.getElementById(bgId).style.display = 'block';
        }
    }
}



function toggleArchivePoison(id) {
    const p = poison.find(x => x.id === id);
    if (!p) return;

    p.isArchived = !p.isArchived;
    savePoison(); // Pastikan lu punya fungsi savePoison() yang simpan ke dbHelper/localStorage
    
    // Cek tab mana yang lagi aktif buat refresh UI
    const isArchivedTab = document.querySelector('#view-archived-btn')?.classList.contains('active') || false;
    renderPoisonList(p.isArchived ? false : true); 
    
    showToast(p.isArchived ? 'Racun diarsipkan.' : 'Racun dipulihkan.');
}


function toggleArchiveFertilizer(id) {
    const f = fertilizers.find(x => x.id === id);
    if (!f) return;

    // Toggle status arsip (true/false)
    f.isArchived = !f.isArchived;
    
    saveFertilizers();
    
    // Refresh tampilan sesuai tab yang sedang aktif
    if (document.getElementById('view-archived-btn').classList.contains('active')) {
        renderFertilizerList(true); // Render list arsip
    } else {
        renderFertilizerList(false); // Render list aktif
    }

    const msg = f.isArchived ? 'Pupuk diarsipkan (Sembunyi).' : 'Pupuk dikembalikan ke Stok Aktif.';
    showToast(msg);
}



function toggleFertilizerMode() {
    const mode = document.getElementById('pupuk-input-mode').value;
    const mainContainer = document.getElementById('fertilizer-main-inputs');
    const detailInputs = document.getElementById('pupuk-detail-inputs');
    const displayField = document.getElementById('pupuk-total-display');
    const manualInput = document.getElementById('pupuk-total-input-manual');
    
    // Target input yang bikin masalah
    const doseInput = document.getElementById('pupuk-dose');
    const qtyInput = document.getElementById('pupuk-quantity');

    if (!mode) {
        if (mainContainer) mainContainer.style.display = 'none';
        return;
    }

    if (mainContainer) mainContainer.style.display = 'block';

    if (mode === 'quick') {
        if (detailInputs) detailInputs.style.display = 'none';
        if (displayField) displayField.style.display = 'none';
        if (manualInput) {
            manualInput.style.display = 'block';
            manualInput.required = true;
        }
        
        // MATIKAN REQUIRED (Biar bisa simpan walau kosong)
        if (doseInput) doseInput.required = false;
        if (qtyInput) qtyInput.required = false;

    } else if (mode === 'detail') {
        if (detailInputs) detailInputs.style.display = 'block';
        if (displayField) displayField.style.display = 'block';
        if (manualInput) {
            manualInput.style.display = 'none';
            manualInput.required = false;
        }

        // HIDUPKAN REQUIRED (Karena menu detail wajib isi ini)
        if (doseInput) doseInput.required = true;
        if (qtyInput) qtyInput.required = true;
        
        if (typeof calculatePupukTotal === 'function') calculatePupukTotal(); 
    }
}

function syncQuickTotal() {
    const val = document.getElementById('pupuk-total-input-manual').value;
    document.getElementById('pupuk-total-value').value = val;
}



async function saveFinances() {
    if (loggedInUsername) await dbHelper.set(`finances_${loggedInUsername}`, finances);
}

function formatFinanceCurrency(el) {
    let val = el.value.replace(/[^0-9]/g, '');
    if (!val) {
        document.getElementById('finance-price-value').value = 0;
        el.value = '';
        return;
    }
    const numVal = parseInt(val, 10);
    document.getElementById('finance-price-value').value = numVal;
    el.value = numVal.toLocaleString('id-ID');
}

function openFinanceModal(id) {
    document.getElementById('finance-form').reset();
    document.getElementById('finance-id').value = '';
    document.getElementById('finance-price-value').value = 0;
    document.getElementById('finance-modal-title').textContent = 'Catat Pengeluaran';
    document.getElementById('finance-date').valueAsDate = new Date();

    if (id) {
        const item = finances.find(f => f.id === id);
        if (item) {
            document.getElementById('finance-modal-title').textContent = 'Edit Pengeluaran';
            document.getElementById('finance-id').value = item.id;
            document.getElementById('finance-name').value = item.name;
            document.getElementById('finance-date').value = item.date;
            document.getElementById('finance-price-value').value = item.price;
            document.getElementById('finance-price-display').value = parseInt(item.price).toLocaleString('id-ID');
            document.getElementById('finance-notes').value = item.notes || '';
        }
    }
    openModal('finance-modal');
}

function handleFinanceSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('finance-id').value || Date.now().toString();
    const name = document.getElementById('finance-name').value.trim();
    const date = document.getElementById('finance-date').value;
    const price = parseInt(document.getElementById('finance-price-value').value) || 0;
    const notes = document.getElementById('finance-notes').value.trim();

    const newItem = { id, name, date, price, notes };
    const idx = finances.findIndex(f => f.id === id);
    
    if (idx > -1) finances[idx] = newItem;
    else finances.unshift(newItem);

    saveFinances();
    closeModal('finance-modal');
    renderFinanceList();
    showToast('Data tersimpan');
}
function setFinanceFilter(filter, btn) {
    currentFinanceFilter = filter;
    const chips = document.querySelectorAll('#finance-view .ios-chip');
    chips.forEach(chip => chip.classList.remove('active'));
    if (btn) {
        btn.classList.add('active');
    }
    const customArea = document.getElementById('custom-date-filter');
    if (customArea) customArea.style.display = 'none';
    renderFinanceList();
}

function openCustomDateFilter(e) {
    const chips = document.querySelectorAll('#finance-view .ios-chip');
    chips.forEach(chip => chip.classList.remove('active'));
    e.currentTarget.classList.add('active');

    const customArea = document.getElementById('custom-date-filter');
    if (customArea) {
        customArea.style.display = 'block';
        customArea.style.animation = 'popupUp 0.5s ease-out';
    }
}


function applyCustomFilter() {
    const start = document.getElementById('filter-start-date').value;
    const end = document.getElementById('filter-end-date').value;
    if(!start || !end) {
        showToast('Pilih tanggal mulai dan akhir');
        return;
    }
    currentFinanceFilter = 'custom';
    renderFinanceList();
}

function renderFinanceList() {
    const container = document.getElementById('finance-list-container');
    if(!container) return;
    
    container.innerHTML = '';
    let filtered = [...finances];
    const now = new Date();
    let labelText = "Semua Waktu";

    // ... (Logika filter tetap sama seperti sebelumnya) ...
    // [Pastikan logika filter tetap ada di sini]
    if (currentFinanceFilter === 'week') {
        const d = new Date();
        const monday = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)));
        monday.setHours(0,0,0,0);
        filtered = filtered.filter(f => new Date(f.date) >= monday);
        labelText = "Minggu Ini";
    } else if (currentFinanceFilter === 'month') {
        filtered = filtered.filter(f => {
            const d = new Date(f.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        labelText = "Bulan Ini";
    } else if (currentFinanceFilter === 'year') {
        filtered = filtered.filter(f => new Date(f.date).getFullYear() === now.getFullYear());
        labelText = "Tahun Ini";
    } else if (currentFinanceFilter === 'custom') {
        const start = document.getElementById('filter-start-date').value;
        const end = document.getElementById('filter-end-date').value;
        if(start && end) {
            filtered = filtered.filter(f => f.date >= start && f.date <= end);
            labelText = "Periode Kustom";
        }
    }

    filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    const total = filtered.reduce((sum, item) => sum + (parseInt(item.price)||0), 0);
    
    document.getElementById('finance-total-display').textContent = `Rp ${total.toLocaleString('id-ID')}`;
    document.getElementById('finance-filter-label').textContent = labelText;

    if (filtered.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:50px; color:#8e8e93; font-weight:500;">
            <div style="font-size:50px; margin-bottom:10px;">üçÉ</div>
            Tidak ada transaksi
        </div>`;
        return;
    }

        filtered.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'finance-item-card item-animate';
        div.style.animationDelay = `${index * 0.05}s`;
        
        div.onclick = () => showFinanceDetail(item.id);
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="icon-box">üõí</div>
                <div>
                    <div style="font-weight:700; color:var(--text-color);">${item.name}</div>
                    <div style="font-size:11px; color:var(--secondary-text-color);">${item.date}</div>
                </div>
            </div>
            <div class="price-text">Rp ${parseInt(item.price).toLocaleString('id-ID')}</div>
        `;
        container.appendChild(div);
    });
}


function showFinanceDetail(id) {
    const item = finances.find(f => f.id === id);
    if (!item) return;

    const content = document.getElementById('preview-content');
    const detailContainer = document.getElementById('garden-detail-content');
    if(detailContainer) detailContainer.style.display = 'none';
    
    content.style.display = 'block';
    document.getElementById('preview-title').textContent = "Detail Transaksi";

    content.innerHTML = `
        <div class="detail-group">
            <div class="detail-row"><span class="detail-label">Barang</span><span class="detail-value" style="font-weight:600;">${item.name}</span></div>
            <div class="detail-row"><span class="detail-label">Tanggal</span><span class="detail-value">${item.date}</span></div>
            <div class="detail-row"><span class="detail-label">Nominal</span><span class="detail-value" style="color:var(--accent-red); font-weight:bold; font-size:16px;">Rp ${parseInt(item.price).toLocaleString('id-ID')}</span></div>
            <div class="detail-row"><span class="detail-label">Catatan</span><span class="detail-value">${item.notes || '-'}</span></div>
        </div>
        <div class="form-actions">
            <button class="primary-action" onclick="openFinanceModal('${item.id}'); closeModal('preview-modal');">‚úèÔ∏è Edit</button>
            <button class="danger-btn" onclick="deleteFinance('${item.id}')">üóëÔ∏è Hapus</button>
            <button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button>
        </div>
    `;
    openModal('preview-modal');
}

function deleteFinance(id) {
    showConfirmDialog('Hapus Data', 'Yakin ingin menghapus catatan ini?', () => {
        finances = finances.filter(f => f.id !== id);
        saveFinances();
        closeModal('preview-modal');
        renderFinanceList();
        showToast('Data dihapus');
    }, null, 'danger');
}



async function openEditTreeModal(tree, el) {
    if (!activeMap) { showCustomDialog('Error', 'Buka peta dulu.'); return; }
    
    // Gunakan tanggal yang sudah ada, atau default hari ini jika belum ada
    const currentDate = tree.datePlanted || new Date().toISOString().split('T')[0];

    const fields = `
        <div class="form-group">
            <label>Nama Pohon</label>
            <input id="sheet-tree-name" value="${tree.name || ''}" placeholder="Contoh: Durian Musang King">
        </div>
        <div class="form-group">
            <label>Tanggal Tanam</label>
            <input type="date" id="sheet-tree-date" value="${currentDate}">
        </div>
        <div class="form-group">
            <label>Deskripsi (opsional)</label>
            <textarea id="sheet-tree-desc" rows="3">${tree.desc || ''}</textarea>
        </div>
    `;

    const res = await showInputSheet('Edit Data Pohon', fields);
    if (!res) return;

    const name = res['sheet-tree-name'] && res['sheet-tree-name'].trim();
    const datePlanted = res['sheet-tree-date'];
    const desc = res['sheet-tree-desc'] || '';

    if (!name) { showNotify('Nama pohon tidak boleh kosong'); return; }

    // --- PROSES UPDATE (Bukan Create) ---
    // Update data pada objek tree yang asli
    tree.name = name;
    tree.datePlanted = datePlanted;
    tree.desc = desc;

    // Simpan ke database/localStorage
    saveMaps();

    // Update tampilan label di peta secara langsung tanpa render ulang semua
    if (el) {
        const label = el.querySelector('div');
        if (label) label.textContent = name;
    }

    showNotify('Data pohon berhasil diperbarui! üå±');
    
    // Tutup dialog detail jika sedang terbuka agar info terbaru muncul saat diklik lagi
    const backdrop = document.querySelector('.custom-dialog-backdrop');
    if(backdrop) backdrop.remove();
}



let isTextLocked = false; // Variabel bantuan sementara di dialog

function toggleTextLock() {
    isTextLocked = !isTextLocked;
    const btn = document.getElementById('btn-lock-text');
    
    // Update visual tombol
    btn.innerText = isTextLocked ? "üîí" : "üîì";
    btn.style.opacity = isTextLocked ? "1" : "0.5";

    // Munculkan toast sesuai status
    if (isTextLocked) {
        showToast("Posisi Terkunci üîí");
    } else {
        showToast("Kunci Dibuka üîì");
    }
}


function showCustomConfirm(message, onConfirm, isAlert = false) {
    const overlay = document.getElementById('confirm-dialog-overlay');
    const msgEl = document.getElementById('confirm-message');
    const btnOk = document.getElementById('btn-confirm-ok');
    const btnCancel = document.getElementById('btn-confirm-cancel');

    msgEl.innerText = message;
    overlay.style.display = 'flex';

    // Jika cuma Alert (peringatan), sembunyikan tombol Batal
    btnCancel.style.display = isAlert ? 'none' : 'block';

    btnOk.onclick = () => {
        overlay.style.display = 'none';
        if (onConfirm) onConfirm();
    };
}

function closeCustomConfirm() {
    document.getElementById('confirm-dialog-overlay').style.display = 'none';
}


function setDialogColor(hex) {
    document.getElementById('dialog-color-input').value = hex;
    
    // Kasih feedback visual dikit biar tau warna mana yang aktif
    const presets = document.querySelectorAll('[onclick^="setDialogColor"]');
    presets.forEach(p => p.style.outline = "none");
    event.target.style.outline = "2px solid #4f46e5";
}

function addNewText() {
    window.currentEditingId = null; // WAJIB: biar dianggap teks baru
    window.isTextLocked = false; 
    document.getElementById('dialog-text-input').value = "";
    document.getElementById('text-dialog-overlay').style.display = 'flex';
}


function confirmTextDialog() {
    // 1. Pastikan objek texts ada di activeMap biar gak error 'find'
    if (!activeMap.texts) {
        activeMap.texts = [];
    }

    const content = document.getElementById('dialog-text-input').value;
    const color = document.getElementById('dialog-color-input').value;
    const size = document.getElementById('dialog-size-input').value;

    if (!content) {
        showToast("Teks tidak boleh kosong!");
        return;
    }

    // 2. Cari data berdasarkan ID yang di-set saat klik (window.currentEditingId)
    let textObj = activeMap.texts.find(t => t.id === window.currentEditingId);

    if (textObj) {
        // MODE EDIT
        textObj.content = content;
        textObj.color = color;
        textObj.fontSize = parseInt(size);
        textObj.locked = window.isTextLocked || false;
    } else {
        // MODE TAMBAH BARU
        const newText = {
            id: 'text_' + Date.now(),
            content: content,
            color: color,
            fontSize: parseInt(size),
            x: 150, // Muncul di koordinat awal
            y: 150,
            locked: false
        };
        activeMap.texts.push(newText);
    }

    // 3. Simpan ke IndexedDB lewat fungsi bawaan lu
    saveMaps(); 
    
    // 4. Refresh tampilan: Hapus semua div teks lama dan render ulang dari data terbaru
    document.querySelectorAll('.text-element').forEach(el => el.remove());
    activeMap.texts.forEach(t => renderTextElement(t));

    closeTextDialog();
    showToast("Teks disimpan!");
}


// 3. Fungsi Hapus (Dipanggil dari tombol Hapus di Dialog)
function deleteTextAction() {
    if (!window.currentEditingId) return;
    
    showCustomConfirm("Hapus teks ini secara permanen?", () => {
        activeMap.texts = activeMap.texts.filter(x => x.id !== window.currentEditingId);
        const el = document.getElementById(window.currentEditingId);
        if (el) el.remove();
        
        if (typeof saveMaps === 'function') saveMaps();
        closeTextDialog();
        showToast("Teks dihapus!");
    });
}

// 4. Fungsi Menutup Dialog
function closeTextDialog() {
    document.getElementById('text-dialog-overlay').style.display = 'none';
    window.currentEditingId = null;
}

// 5. Fungsi Render Elemen (Menampilkan di Peta)
function renderTextElement(t) {
    const canvas = document.getElementById('map-inner') || document.getElementById('map-canvas-area');
    if (!canvas) return;

    const el = document.createElement('div');
    el.id = t.id;
    el.classList.add('text-element'); // <--- TAMBAHKAN INI COY
    el.innerText = t.content;
    
    // ... sisa kode style lu tetap sama ...

    
    Object.assign(el.style, {
        position: 'absolute',
        left: t.x + 'px',
        top: t.y + 'px',
        color: t.color || '#ffffff',
        fontSize: (t.fontSize || 25) + 'px',
        fontWeight: 'bold',
        textShadow: '3px 3px 6px rgba(0,0,0,0.9)',
        zIndex: '1000',
        cursor: t.locked ? 'default' : 'move', // Cursor berubah kalau lock
        touchAction: 'none',
        whiteSpace: 'nowrap',
        padding: '10px',
        opacity: t.locked ? '0.8' : '1' // Kasih visual dikit kalau lock
    });

    let isMoving = false;
    let hasMoved = false;

    el.onpointerdown = (e) => {
        if (t.locked) return; // JIKA LOCK, BERHENTI DI SINI
        isMoving = true;
        hasMoved = false;
        el.setPointerCapture(e.pointerId);
        e.stopPropagation();
    };

    el.onpointermove = (e) => {
        if (!isMoving) return;
        hasMoved = true;
        let s = window.mapScale || 1;
        t.x += e.movementX / s;
        t.y += e.movementY / s;
        el.style.left = t.x + 'px';
        el.style.top = t.y + 'px';
    };

    el.onpointerup = () => {
        isMoving = false;
        if (typeof saveMaps === 'function') saveMaps();
    };

    el.onclick = (e) => {
        if (hasMoved) return; 
        e.stopPropagation();
        window.currentEditingId = t.id; 
        
        // Load data ke dialog
        document.getElementById('dialog-text-input').value = t.content;
        document.getElementById('dialog-color-input').value = t.color || '#ffffff';
        document.getElementById('dialog-size-input').value = t.fontSize || 25;
        
        // Load status lock ke dialog
        isTextLocked = t.locked || false;
        const btn = document.getElementById('btn-lock-text');
        btn.innerText = isTextLocked ? "üîí" : "üîì";
        
        document.getElementById('btn-delete-text').style.display = 'block';
        document.getElementById('text-dialog-overlay').style.display = 'flex';
    };

    canvas.appendChild(el);
}


function lockSelectedTrees() {
    if (selectedTrees.length === 0) return;

    // 1. Logika Pintar: 
    // Jika ada salah satu pohon terpilih yang posisinya terbuka (tidak dikunci), maka aksi ini akan MENGUNCI semua.
    // Jika semua pohon terpilih sudah terkunci, maka aksi ini akan MEMBUKA KUNCI semua.
    
    // Ambil object pohon asli dari activeMap berdasarkan ID yang dipilih
    const targetTrees = activeMap.trees.filter(t => selectedTrees.includes(t.id));
    
    // Cek apakah ada yang belum dikunci?
    const shouldLock = targetTrees.some(t => !t.isLocked);

    // 2. Update Status Data
    targetTrees.forEach(t => {
        t.isLocked = shouldLock;
    });
    
    // Simpan ke database
    saveMaps();

    // 3. Update Visual (Render Ulang Element)
    // Kita harus menghapus dan membuat ulang elemen agar event drag-nya dimatikan/dinyalakan
    targetTrees.forEach(t => {
        const oldEl = document.querySelector(`.map-tree[data-id="${t.id}"]`);
        if (oldEl) oldEl.remove(); // Hapus elemen lama
        renderTreeElement(t);      // Render ulang dengan status baru
    });

    // 4. Feedback & Reset
    const statusMsg = shouldLock ? "Dikunci üîí" : "Terbuka üîì";
    showToast(`${targetTrees.length} Pohon Berhasil ${statusMsg}`);
    
    // Keluar dari mode multiple select setelah aksi selesai
    cancelMultiSelect();
}


let isMultiSelectMode = false;
let selectedTrees = [];

function toggleMultiSelect() {
    isMultiSelectMode = !isMultiSelectMode;
    const btn = document.getElementById('btn-select-mode');
    const bar = document.getElementById('multi-select-bar');

    if(isMultiSelectMode) {
        // Reset data setiap kali mode baru diaktifkan
        selectedTrees = []; 
        document.getElementById('select-count').textContent = "0 Terpilih";
        
        btn.style.background = "#007AFF";
        btn.style.color = "#fff";
        bar.style.display = 'flex';
        showToast("Mode Pilih Aktif");
    } else {
        cancelMultiSelect();
    }
}

function cancelMultiSelect() {
    isMultiSelectMode = false;
    // KUNCI PERBAIKAN: Reset array jadi kosong
    selectedTrees = []; 
    
    // Update tampilan teks jadi 0
    const selectCountEl = document.getElementById('select-count');
    if(selectCountEl) selectCountEl.textContent = "0 Terpilih";

    const btn = document.getElementById('btn-select-mode');
    if(btn) {
        btn.style.background = "";
        btn.style.color = "";
    }
    
    const bar = document.getElementById('multi-select-bar');
    if(bar) bar.style.display = 'none';
    
    // Hilangkan semua garis biru (outline) di pohon
    document.querySelectorAll('.map-tree').forEach(el => {
        el.style.outline = "none";
        el.style.transform = "scale(1)";
    });
}

function handleTreeClick(treeId, element) {
    if (!isMultiSelectMode) return;
    const index = selectedTrees.indexOf(treeId);
    if (index === -1) {
        selectedTrees.push(treeId);
        element.style.outline = "4px solid #007AFF";
        element.style.transform = "scale(1.1)";
    } else {
        selectedTrees.splice(index, 1);
        element.style.outline = "none";
        element.style.transform = "scale(1)";
    }
    document.getElementById('select-count').textContent = selectedTrees.length + " Terpilih";
}

function copySelectedTrees() {
    if (selectedTrees.length === 0) return;
    const groupId = "group_" + Date.now();
    selectedTrees.forEach(id => {
        const t = activeMap.trees.find(x => x.id === id);
        if(t) {
            const copy = JSON.parse(JSON.stringify(t));
            copy.id = Date.now().toString() + Math.random();
            copy.groupId = groupId;
            copy.x += 50;
            copy.y += 50;
            copy.isLocked = false;
            activeMap.trees.push(copy);
            renderTreeElement(copy);
        }
    });
    saveMaps();
    showToast("Copy Berhasil! Pohon kini tertaut.");
    cancelMultiSelect();
}

function deleteSelectedTrees() {
    if (selectedTrees.length === 0) return;

    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(4px);";

    const dialog = document.createElement('div');
    dialog.style.cssText = "background:#1c1c1e; width:90%; max-width:320px; padding:25px; border-radius:20px; text-align:center; color:white; box-shadow:0 20px 40px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1);";
    
    dialog.innerHTML = `
        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 style="margin:0 0 10px 0; font-size:20px;">Hapus Pohon?</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 25px; font-size:14px; line-height:1.5;">
            Yakin mau menghapus <b>${selectedTrees.length}</b> pohon yang dipilih? Data tidak bisa dikembalikan.
        </p>
    `;

    const btnHapus = document.createElement('button');
    btnHapus.textContent = "Ya, Hapus Semua";
    btnHapus.style.cssText = "width:100%; background:#FF3B30; color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; font-size:16px; margin-bottom:10px; cursor:pointer;";
    btnHapus.onclick = () => {
        activeMap.trees = activeMap.trees.filter(t => !selectedTrees.includes(t.id));
        selectedTrees.forEach(id => {
            const el = document.querySelector(`.map-tree[data-id="${id}"]`);
            if (el) el.remove();
        });
        saveMaps();
        showToast(`${selectedTrees.length} pohon dihapus.`);
        cancelMultiSelect();
        backdrop.remove();
    };

    const btnBatal = document.createElement('button');
    btnBatal.textContent = "Batal";
    btnBatal.style.cssText = "width:100%; background:rgba(255,255,255,0.1); color:white; border:none; padding:14px; border-radius:12px; font-size:16px; cursor:pointer;";
    btnBatal.onclick = () => {
        backdrop.remove();
    };

    dialog.appendChild(btnHapus);
    dialog.appendChild(btnBatal);
    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);
}


async function exportMapToImage() {
    const mapCanvasArea = document.getElementById('map-canvas-area'); // Jendela tampilan
    const mapInner = document.getElementById('map-inner'); // Isi peta (pohon-pohon)

    if (!mapCanvasArea || !mapInner) return showToast("Gagal menemukan area peta");

    showToast("üì∏ Sedang memproses gambar...");

    // 1. AMBIL UKURAN LAYAR SAAT INI
    const rect = mapCanvasArea.getBoundingClientRect();

    // 2. BUAT WADAH SEMENTARA (STAGE)
    // Wadah ini kita buat persis seukuran layar peta, tapi tersembunyi
    const stage = document.createElement('div');
    stage.style.position = 'fixed';
    stage.style.left = '0';
    stage.style.top = '0';
    stage.style.width = rect.width + 'px';
    stage.style.height = rect.height + 'px';
    stage.style.overflow = 'hidden'; // Potong apa yang diluar layar
    stage.style.zIndex = '-9999'; // Taruh di belakang layar
    stage.style.backgroundColor = '#086f3e'; // Samakan warna background

    // 3. DUPLIKAT ISI PETA (CLONE)
    const clone = mapInner.cloneNode(true);
    
    // 4. TERAPKAN POSISI & ZOOM YANG SAMA PERSIS
    // Kita ambil nilai global mapTranslate dan mapScale yang sedang aktif
    clone.style.transform = `translate(${mapTranslate.x}px, ${mapTranslate.y}px) scale(${mapScale})`;
    clone.style.transformOrigin = '0 0'; // Wajib, supaya titik zoom sama
    
    // Masukkan clone ke stage, lalu stage ke body
    stage.appendChild(clone);
    document.body.appendChild(stage);

    try {
        // 5. FOTO WADAH SEMENTARA TADI
        const canvas = await html2canvas(stage, {
            useCORS: true,
            scale: 2, // Resolusi HD
            backgroundColor: "#086f3e",
            logging: false,
            width: rect.width,
            height: rect.height,
            // Kita tidak butuh x/y/scroll manual lagi karena 'stage' sudah diposisikan di 0,0 layar
        });

        // 6. DOWNLOAD GAMBAR
        const image = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        const mapName = (typeof activeMap !== 'undefined' && activeMap.title) ? activeMap.title : 'Kebun';
        
        // Nama file ada jam-nya biar unik
        const now = new Date();
        const timeStr = `${now.getHours()}${now.getMinutes()}`;
        
        link.download = `Peta_${mapName}_${timeStr}.png`;
        link.href = image;
        link.click();

        showToast("‚úÖ Gambar tersimpan sesuai tampilan layar!");
    } catch (err) {
        console.error(err);
        showToast("‚ùå Gagal: " + err.message);
    } finally {
        // 7. BERSIHKAN (Hapus wadah sementara)
        document.body.removeChild(stage);
    }
}



async function initNotifServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            await navigator.serviceWorker.register('sw.js');
            console.log("SW Aktif untuk Notifikasi");
        } catch (e) {
            console.error("Gagal daftar SW:", e);
        }
    }
}

async function sendMobileNotification(title, message) {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;

    const reg = await navigator.serviceWorker.ready;

    reg.showNotification(title, {
        body: message,

        // ICON LANGSUNG DI ROOT
        icon: 'icon-192.png',   // icon besar notif
        badge: 'icon-96.png',   // icon kecil status bar

        // FEEL ANDROID
        vibrate: [120, 60, 120, 60, 200],
        requireInteraction: false,

        // BEHAVIOR
        tag: 'jadwal-pemupukan',
        renotify: true,

        // DATA SAAT DIKLIK
        data: {
            url: '/'
        }
    });
}
// 3. Scanner Jadwal (Cek setiap 1 menit)
function startReminderScanner() {
    console.log("Sistem Pengingat Aktif...");
    
    setInterval(() => {
        const todayStr = new Date().toLocaleDateString('en-CA'); 

        if (typeof reminders !== 'undefined' && reminders.length > 0) {
            // AMBIL NAMA USER DARI STORAGE
            const savedName = localStorage.getItem('userName') || 'Bos';

            reminders.forEach(rem => {
                const remDate = rem.dateDue.split('T')[0];

                if (remDate === todayStr && !rem.hasNotified) {
                    const garden = typeof gardens !== 'undefined' ? gardens.find(g => g.id === rem.gardenIdReference) : null;
                    const gardenName = garden ? garden.title : "Kebun";

                    // RAKIT PESAN PERSONAL
                    const personalMessage = `Halo, ${savedName}! Waktunya Pemupukan.\nLokasi: ${gardenName}`;

                    sendMobileNotification(
                        "Jadwal " + rem.title,
                        personalMessage
                    );

                    rem.hasNotified = true;
                    if (typeof saveReminders === 'function') saveReminders(); 
                }
            });
        }
    }, 60000);
}

// 4. Jalankan saat Start
window.addEventListener('load', () => {
    initNotifServiceWorker(); // Daftar SW dulu
    
    // Minta izin
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    setTimeout(startReminderScanner, 4000);
});

const DB_CONFIG = {
    name: 'TanamanAppDB',
    version: 1,
    storeName: 'appData' // Kita menggunakan Key-Value store sederhana agar mirip localStorage
};

const dbHelper = {
    db: null,

    open: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);

            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DB_CONFIG.storeName)) {
                    db.createObjectStore(DB_CONFIG.storeName);
                }
            };

            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve(this.db);
            };

            request.onerror = (e) => {
                console.error("IndexedDB Error:", e.target.error);
                reject(e.target.error);
            };
        });
    },

    get: function(key) {
        return new Promise((resolve, reject) => {
            if (!this.db) return resolve(null);
            const tx = this.db.transaction([DB_CONFIG.storeName], 'readonly');
            const store = tx.objectStore(DB_CONFIG.storeName);
            const request = store.get(key);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },

    set: function(key, value) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("DB not open");
            const tx = this.db.transaction([DB_CONFIG.storeName], 'readwrite');
            const store = tx.objectStore(DB_CONFIG.storeName);
            const request = store.put(value, key);

            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
        });
    },

    delete: function(key) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("DB not open");
            const tx = this.db.transaction([DB_CONFIG.storeName], 'readwrite');
            const store = tx.objectStore(DB_CONFIG.storeName);
            const request = store.delete(key);

            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
        });
    },

    // Fitur untuk memindahkan data dari LocalStorage ke IndexedDB sekali jalan
    migrateFromLocalStorage: async function() {
        const migrated = localStorage.getItem('idb_migrated');
        if (migrated) return;

        console.log("Migrating data from LocalStorage to IndexedDB...");
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // Jangan migrasi flag sistem tertentu jika tidak perlu
            if (key === 'darkMode') continue; 
            
            try {
                const value = localStorage.getItem(key);
                // Coba parse JSON, jika gagal simpan string aslinya
                try {
                    const parsed = JSON.parse(value);
                    await this.set(key, parsed);
                } catch (e) {
                    await this.set(key, value);
                }
            } catch (err) {
                console.error(`Failed to migrate key: ${key}`, err);
            }
        }
        localStorage.setItem('idb_migrated', 'true');
        // Opsional: Bersihkan localStorage untuk hemat memori setelah migrasi sukses
        // localStorage.clear(); (Hati-hati, biarkan dulu untuk keamanan)
    }
};

function handleCancelRegistration() {
    closeModal('register-modal');
    openModal('login-screen');
}


function showToast(message, duration = 2000) {
    document.querySelectorAll('.app-toast').forEach(toast => toast.remove());

    const toast = document.createElement('div');
    toast.className = 'app-toast';
    toast.textContent = message;

    toast.style.cssText = `
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--card-bg);
        color: var(--text-color);
        padding: 10px 15px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1000000082;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        font-size: 14px;
        font-weight: 500;
        max-width: 80%;
        text-align: center;
    `;

    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(-50%) translateY(-10px)';
    });

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(10px)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}


function previewTreePhoto(url) {
    const html = `
        <img src="${url}" style="width:100%; border-radius:12px; margin-bottom:15px;">
    `;

    showCustomDialog("Foto Pohon", html, null, null);
}

function showImageLightbox(imageUrl) {
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    // UPDATE: Menambahkan z-index tertinggi dan !important
    backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.95);
        z-index: 2147483647 !important; /* LAYER TERTINGGI */
        display: flex; align-items: center; justify-content: center;
        cursor: zoom-out;
        transition: opacity 0.2s ease-out;
        opacity: 0;
    `;

    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.cssText = `
        max-width: 95vw; max-height: 90vh;
        object-fit: contain; border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        transform: scale(0.95); transition: transform 0.2s;
    `;

    // Tutup saat diklik
    backdrop.onclick = () => {
        backdrop.style.opacity = '0';
        img.style.transform = 'scale(0.95)';
        setTimeout(() => backdrop.remove(), 200);
    };

    backdrop.appendChild(img);
    document.body.appendChild(backdrop);

    // Animasi masuk
    requestAnimationFrame(() => {
        backdrop.style.opacity = '1';
        img.style.transform = 'scale(1)';
    });
}


function getTreeAgeString(dateString) {
    if (!dateString) return 'Belum diset';
    
    const start = new Date(dateString);
    const now = new Date();
    
    // Set jam ke 0 biar hitungan hari akurat
    start.setHours(0,0,0,0);
    now.setHours(0,0,0,0);
    
    if (start > now) return 'Belum Tanam';

    let years = now.getFullYear() - start.getFullYear();
    let months = now.getMonth() - start.getMonth();
    let days = now.getDate() - start.getDate();

    // Koreksi jika hari minus (berarti belum sebulan penuh dari bulan lalu)
    if (days < 0) {
        months--;
        // Ambil jumlah hari di bulan sebelumnya
        const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
        days += prevMonth;
    }

    // Koreksi jika bulan minus (berarti belum setahun penuh)
    if (months < 0) {
        years--;
        months += 12;
    }

    // Susun string output
    let result = [];
    if (years > 0) result.push(`${years} Thn`);
    if (months > 0) result.push(`${months} Bln`);
    if (days > 0) result.push(`${days} Hr`);
    
    if (result.length === 0) return 'Hari Ini';
    return result.join(' ');
}


function showCustomAlert(message, title = 'Perhatian') {
    const backdrop = document.createElement('div');
    // Tambahkan style inline !important untuk z-index
    backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex; align-items: flex-end; justify-content: center;
        z-index: 2147483647 !important; /* Nilai Z-Index Maksimum Browser */
        opacity: 0; transition: opacity 0.2s ease-out;
    `;

    const box = document.createElement('div');
    box.style.cssText = `
        background-color: #fff; /* Atau var(--card-bg) */
        color: #000; /* Atau var(--text-color) */
        width: 90%; max-width: 400px;
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        display: flex; flex-direction: column; gap: 10px;
        text-align: center;
    `;

    if (document.body.classList.contains('dark-mode')) {
        box.style.backgroundColor = '#1C1C1E';
        box.style.color = '#FFFFFF';
    }

    const titleEl = document.createElement('h3');
    titleEl.textContent = title;
    titleEl.style.margin = '0 0 5px 0';

    const msgEl = document.createElement('p');
    msgEl.textContent = message;
    msgEl.style.margin = '0 0 15px 0';
    msgEl.style.color = 'var(--secondary-text-color)';

    const btn = document.createElement('button');
    btn.textContent = 'OK';
    btn.style.cssText = `
        background: #007AFF; color: white; border: none;
        padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px;
    `;

    btn.onclick = () => {
        backdrop.style.opacity = '0';
        setTimeout(() => backdrop.remove(), 200);
    };

    box.appendChild(titleEl);
    box.appendChild(msgEl);
    box.appendChild(btn);
    backdrop.appendChild(box);
    document.body.appendChild(backdrop);

    // Animasi masuk
    requestAnimationFrame(() => {
        backdrop.style.opacity = '1';
    });
}



let records = []; 
let galleryPhotos = []; 
let gardens = []; 
let reminders = []; 
let fertilizers = []; 
let maps = [];
let poison = [];
let finances = [];
let currentFinanceFilter = 'all';


// DAFTAR VARIABEL FILTER (WAJIB ADA BIAR GAK ERROR)
window.listFilterType = localStorage.getItem('listFilterType') || 'Semua';
window.listFilterDate = localStorage.getItem('listFilterDate') || 'Semua';
window.customDateStart = localStorage.getItem('customDateStart') || '';
window.customDateEnd = localStorage.getItem('customDateEnd') || '';


let registeredUsers = [{ username: 'user', password: '123' }]; 

let currentRecordType = 'Dashboard'; 
let loggedInUsername = localStorage.getItem('loggedInUsername') || ''; // Session tetap di localStorage agar cepat
let isSettingsOpen = false; 

let listFilterType = localStorage.getItem('listFilterType') || 'Semua';
let listFilterDate = localStorage.getItem('listFilterDate') || 'Semua'; 
let listSortBy = localStorage.getItem('listSortBy') || 'dateDesc'; 

const loadingIndicator = document.getElementById('loading-indicator');
const loginScreen = document.getElementById('login-screen');
const app = document.getElementById('app');
const searchInput = document.getElementById('search-input');
const recordList = document.getElementById('record-list');
const dashboardContent = document.getElementById('dashboard-content');
const settingsView = document.getElementById('settings-view');
const galleryView = document.getElementById('gallery-view'); 
const gardenList = document.getElementById('garden-list');
const fertilizerList = document.getElementById('fertilizer-list'); 
const poisonList = document.getElementById('poison-list'); 
const financeList = document.getElementById('finance-view');
const mapList = document.getElementById('map-list-container');
const tabButtons = document.querySelectorAll('.tab-button');

// --- DATA MANAGEMENT FUNCTIONS (ASYNC NOW) ---

async function saveRegisteredUsers() {
     await dbHelper.set('registeredUsers', registeredUsers);
}

async function loadUserData(username) {
    try {
        // Load All Data Asynchronously
        records = (await dbHelper.get(`records_${username}`)) || [];
        galleryPhotos = (await dbHelper.get(`gallery_${username}`)) || [];
        gardens = (await dbHelper.get(`gardens_${username}`)) || []; 
        reminders = (await dbHelper.get(`reminders_${username}`)) || [];
        fertilizers = (await dbHelper.get(`fertilizers_${username}`)) || []; 
        maps = (await dbHelper.get(`maps_${username}`)) || [];
        poison = (await dbHelper.get(`poison_${username}`)) || [];
        finances = (await dbHelper.get(`finances_${username}`)) || []; 
        
        // Load Registered Users Global
        const users = await dbHelper.get('registeredUsers');
        if (users) registeredUsers = users;
        
    } catch (e) {
         console.error("Gagal memuat data Database:", e);
         records = []; galleryPhotos = []; gardens = []; reminders = []; fertilizers = []; maps = []; poison = []; finances = [];
    }
}

async function savePoison() {
    if (loggedInUsername) {
        await dbHelper.set(`poison_${loggedInUsername}`, poison);
    }
}

async function saveRecords() {
    if (loggedInUsername) {
        await dbHelper.set(`records_${loggedInUsername}`, records);
    }
    await saveReminders(); 
    await saveFertilizers();
}

async function saveGalleryPhotos() {
    if (loggedInUsername) {
        await dbHelper.set(`gallery_${loggedInUsername}`, galleryPhotos);
    }
}

async function saveGardens() {
    if (loggedInUsername) {
        await dbHelper.set(`gardens_${loggedInUsername}`, gardens);
    }
}

async function saveReminders() {
    if (loggedInUsername) {
        await dbHelper.set(`reminders_${loggedInUsername}`, reminders);
    }
}

async function saveFertilizers() {
    if (loggedInUsername) {
        await dbHelper.set(`fertilizers_${loggedInUsername}`, fertilizers);
    }
}

async function saveMaps() {
    if (loggedInUsername) {
        await dbHelper.set(`maps_${loggedInUsername}`, maps);
    }
}
// ** INJEKSI MODAL RECORD **
document.getElementById('record-modal').querySelector('.modal-content').innerHTML = `
    <h2 id="record-modal-title">Tambah Catatan Baru</h2>
    <form id="record-form" onsubmit="handleFormSubmit(event)">
        <input type="hidden" id="record-id">
        <input type="hidden" id="record-type">
        <input type="hidden" id="garden-id-reference"> 
        
        <div class="form-group"><label for="plant-name">Nama Tanaman / Kebun <span style="color: var(--accent-red);">*</span></label>
            <input type="text" id="plant-name" list="garden-plants-list" required>
            <datalist id="garden-plants-list">
                </datalist>
        </div>
        
        <div class="form-group"><label for="record-date">Tanggal <span style="color: var(--accent-red);">*</span></label><input type="date" id="record-date" required></div>

        <div id="perawatan-fields" style="display: none;"><div class="form-group"><label for="perawatan-notes">Catatan Perawatan</label><textarea id="perawatan-notes" rows="3"></textarea></div><div class="form-group"><label for="perawatan-photo-file">Foto Perawatan (File)</label><input type="file" id="perawatan-photo-file" accept="image/*" style="margin-bottom: 10px;" onchange="updatePerawatanPhotoPreview(null, this.files[0], 'perawatan')"><label for="perawatan-photo-url">Atau URL Foto</label><input type="text" id="perawatan-photo-url" placeholder="Masukkan URL Foto" oninput="previewPerawatanPhoto('perawatan')"><div class="image-preview" id="photo-preview-perawatan"></div></div></div>
        
<div id="pemupukan-fields" style="display: none;">
    <div class="form-group">
        <label>Mode Input <span style="color: var(--accent-red);">*</span></label>
        <select id="pupuk-input-mode" onchange="toggleFertilizerMode()" style="background: var(--secondary-bg); font-weight: bold; color: var(--primary-color);">
            <option value="" disabled selected>-- Pilih Mode Input --</option>
            <option value="detail">üìù Menu Detail (Hitung Dosis)</option>
            <option value="quick">‚ö° Menu Cepat (Langsung Total)</option>
        </select>
    </div>

    <div id="fertilizer-main-inputs" style="display: none;">
        
        <div class="form-group">
            <label for="pupuk-id-select">Pilih Pupuk (Dari Stok) <span style="color: var(--accent-red);">*</span></label>
            <select id="pupuk-id-select" required onchange="updateFertilizerInfo()">
                <option value="">-- Pilih Pupuk --</option>
            </select>
            <input type="text" id="pupuk-manual-name" placeholder="Masukkan Nama Pupuk" style="display:none; margin-top:10px;">
            <p id="fertilizer-stock-info" style="font-size: 12px; color: var(--accent-green); margin-top: 5px; display: none;">Stok tersedia: 0 kg</p>
        </div>

        <div id="pupuk-detail-inputs" style="display: none;">
            <div class="form-group">
                <label for="pupuk-dose">Dosis Pupuk per Pohon (gram) <span style="color: var(--accent-red);">*</span></label>
                <input type="number" id="pupuk-dose" step="0.1" min="0" oninput="calculatePupukTotal()">
            </div>
            <div class="form-group">
                <label for="pupuk-quantity">Jumlah Pohon/Aplikasi <span style="color: var(--accent-red);">*</span></label>
                <input type="number" id="pupuk-quantity" min="1" oninput="calculatePupukTotal()">
            </div>
        </div>

        <div class="form-group">
            <label id="label-total-pupuk">Total Penggunaan Pupuk (kg)</label>
            <input type="number" id="pupuk-total-input-manual" step="0.001" placeholder="Masukkan total kg" style="display: none;" oninput="syncQuickTotal()">
            <input type="text" id="pupuk-total-display" readonly disabled style="display: none; font-weight: bold; background: rgba(255,255,255,0.05);">
            <input type="hidden" id="pupuk-total-value">
        </div>
        
        <div class="form-group">
            <label for="pupuk-cost-display">Biaya Estimasi (Rp)</label>
            <input type="text" id="pupuk-cost-display" placeholder="Contoh: 80.000" oninput="formatCostInput(this, 'pupuk-cost')" inputmode="numeric">
            <input type="hidden" id="pupuk-cost">
        </div>

        <div class="form-group"><label for="pupuk-notes">Catatan Pemupukan</label><textarea id="pupuk-notes" rows="3"></textarea></div>
        
        <div class="form-group">
            <label>Jadwal Pengingat Selanjutnya (Opsional)</label>
            <div class="reminder-inputs">
                <div><input type="date" id="pupuk-reminder-date" title="Tanggal Pengingat"></div>
                <div><input type="time" id="pupuk-reminder-time" title="Waktu Pengingat"></div>
            </div>
        </div>
    </div>
</div>

        
        <div id="panen-fields" style="display: none;"><div class="form-group"><label for="harvest-quantity">Kuantitas Panen (kg) <span style="color: var(--accent-red);">*</span></label><input type="number" id="harvest-quantity" step="0.01" min="0" required></div><div class="form-group"><label for="harvest-notes">Catatan Panen</label><textarea id="harvest-notes" rows="3"></textarea></div></div>
        
<input type="hidden" id="selected-tree-ids"> 

<div id="sawit-fields" style="display: none;">
    <div class="form-group">
        <label for="sawit-activity-type">Jenis Kegiatan <span style="color: var(--accent-red);">*</span></label>
        <select id="sawit-activity-type" onchange="toggleSawitFields()" required>
            <option value="">Pilih Jenis Kegiatan</option>
            <option value="Penyemprotan">Penyemprotan</option>
            <option value="Pruning">Pruning (Pemotongan Pelepah)</option>
            <option value="Kastrasi">Kastrasi (Buang Bunga/Buah)</option>
        </select>
    </div>

    <div id="tree-selection-ui" style="display:none; margin-bottom:15px; padding:10px; background:var(--card-bg-alt); border:1px dashed var(--border-color); border-radius:10px;">
        <label style="display:block; margin-bottom:8px;">Target Pohon (Opsional)</label>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="tree-selection-count" style="font-weight:bold; color:var(--primary-color);">0 Pohon Dipilih</span>
            <button type="button" class="secondary-action" onclick="openTreeSelectorForRecord()" style="padding:8px 12px; font-size:12px;">üó∫Ô∏è Pilih dari Peta</button>
        </div>
        <p style="font-size:10px; color:var(--secondary-text-color); margin-top:5px;">Pastikan Anda sudah memilih "Kebun" di atas dan Kebun tersebut memiliki Peta.</p>
    </div>
    
<div id="spraying-fields" style="display: none; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px;">
    <h4 style="margin-top: 0; color: var(--secondary-text-color);">Detail Aplikasi Racun</h4>
    
    <div class="form-group">
        <label for="spraying-target">Target Sasaran <span style="color: var(--accent-red);">*</span></label>
        <select id="spraying-target">
            <option value="">-- Pilih Target --</option>
            <option value="Gulma (Rumput)">Gulma (Rumput)</option>
            <option value="Hama (Ulat/Kumbang)">Hama (Ulat/Kumbang)</option>
            <option value="Jamur">Fungisida (Jamur)</option>
            <option value="Lainnya">Lainnya</option>
        </select>
    </div>

    <div class="form-group">
        <label for="poison-id-select">Pilih Racun (Dari Gudang) <span style="color: var(--accent-red);">*</span></label>
        <select id="poison-id-select" onchange="updatePoisonInfo()">
            <option value="">-- Pilih Racun --</option>
        </select>
        <input type="text" id="poison-manual-name" placeholder="Nama Racun (Manual)" style="display:none; margin-top:10px;">
        <p id="poison-stock-info" style="font-size: 12px; color: var(--accent-green); margin-top: 5px; display: none;">Stok tersedia: 0 Liter</p>
    </div>

    <div class="form-group">
        <label for="poison-dose">Dosis (ml) per Tangki/Liter Air <span style="color: var(--accent-red);">*</span></label>
        <input type="number" id="poison-dose" step="0.1" min="0" placeholder="Contoh: 50 ml" oninput="calculatePoisonTotal()">
    </div>

    <div class="form-group">
        <label for="poison-quantity">Jumlah Tangki / Volume Air (Liter) <span style="color: var(--accent-red);">*</span></label>
        <input type="number" id="poison-quantity" min="1" placeholder="Contoh: 10 Tangki" oninput="calculatePoisonTotal()">
    </div>

    <div class="form-group">
        <label>Total Racun Terpakai (Liter)</label>
        <input type="text" id="poison-total-display" readonly disabled style="font-weight: bold; background: #00000 !important;">
        <input type="hidden" id="poison-total-value"> </div>

    <div class="form-group">
        <label for="poison-cost-display">Biaya Estimasi (Rp)</label>
        <input type="text" id="poison-cost-display" placeholder="Contoh: 50.000" oninput="formatCostInput(this, 'poison-cost')" inputmode="numeric">
        <input type="hidden" id="poison-cost">
    </div>
</div>

            <div class="form-group"><label for="sawit-notes">Catatan Kegiatan Sawit</label><textarea id="sawit-notes" rows="3"></textarea></div>
        </div>
        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeModal('record-modal')">Batal</button>
            <button type="submit" class="save-btn" id="save-btn">Simpan</button>
        </div>
    </form>
`;

// ** INJEKSI SETTINGS **
settingsView.innerHTML = `
    <h2 style="font-size: 30px; font-weight: 700; margin: 0 15px 25px;">Pengaturan</h2>
    
    <div class="settings-group">
        <h3>AKUN ANDA</h3>
        <div class="settings-list">
            <div class="setting-item">
                <label>Username</label>
                <div class="setting-action">
                    <span id="display-username" style="font-weight: 600;"></span>
                </div>
            </div>
            <div class="setting-item" onclick="openChangeProfileModal()">
                <label>Ubah Nama / Password</label>
                <div class="setting-action">
                    <span style="color: var(--secondary-text-color);">¬ª</span>
                </div>
            </div>
            <div class="setting-item" onclick="openAvatarMenu()">
                <label>Ubah Foto Profil</label>
                <div class="setting-action">
                    <span style="color: var(--secondary-text-color);">¬ª</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="settings-group">
        <h3>BANTUAN</h3>
        <div class="settings-list">
            <div class="setting-item" onclick="openAiAssistantModal()">
                <label>ü§ñ Asisten AI Tanaman</label>
                <div class="setting-action">
                    <span style="color: var(--secondary-text-color);">Chat</span>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-group">
        <h3>TAMPILAN</h3>
        <div class="settings-list">
            <div class="setting-item">
                <label for="mode-toggle-switch">Mode Gelap / Terang</label>
                <label class="switch">
                    <input type="checkbox" id="mode-toggle-switch">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="settings-group">
        <h3>DATA & PRIVASI</h3>
        <div class="settings-list">
            <div class="setting-item" onclick="exportData()">
                <label>Export Data (.json)</label>
                <div class="setting-action">
                    <span style="color: var(--primary-color);">üíæ Export</span>
                </div>
            </div>
            <div class="setting-item" onclick="document.getElementById('import-file').click()">
                <label>Import Data (.json)</label>
                <div class="setting-action">
                    <span style="color: var(--primary-color);">üìÇ Import</span>
                    <input type="file" id="import-file" style="display: none;" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <div class="settings-group">
        <h3 style="color: var(--accent-red);">Account</h3>
        <div class="settings-list">
            <div class="setting-item" onclick="confirmDeleteAccount()">
                <label style="color: var(--accent-red);">Hapus Akun Permanen</label>
                <div class="setting-action">
                    <span>üóëÔ∏è</span>
                </div>
            </div>
        </div>
    </div>

    <div class="logout-action" style="padding: 0 15px;">
        <button id="logout-btn" class="danger-btn" style="width: 100%;" onclick="showConfirmDialog('Logout', 'Anda yakin ingin keluar dari aplikasi?', handleLogout, null, 'danger')">Logout</button>
    </div>

    <div style="text-align: center; margin-top: 30px; margin-bottom: 20px; opacity: 0.6;">
        <p style="font-size: 12px; color: var(--secondary-text-color); margin: 0; font-weight: 500;">
            Developed by Randa ¬©2025
        </p>
    </div>
`;

// ** Re-bind mode toggle switch **
const newModeToggleSwitch = document.getElementById('mode-toggle-switch');
if(newModeToggleSwitch) {
    newModeToggleSwitch.addEventListener('change', () => {
        if (newModeToggleSwitch.checked) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.setItem('darkMode', 'disabled');
        }
        checkDarkMode();
    });
}

// ** Re-bind Import File Listener **
// --- IMPORT DATA (Versi IndexedDB) ---
// Pastikan kode ini menggantikan event listener import yang lama
// --- IMPORT DATA (Versi Custom Dialog & IndexedDB) ---
// --- UPDATE LOGIKA IMPORT DATA (PUPUK & RACUN ARCHIVE SUPPORT) ---
const importFileInput = document.getElementById('import-file');
if (importFileInput) {
    importFileInput.replaceWith(importFileInput.cloneNode(true)); // Reset listener lama
    
    document.getElementById('import-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showConfirmDialog(
            'Konfirmasi Impor', 
            'Data saat ini akan ditimpa dengan data dari file backup. Lanjutkan?',
            () => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.records && !importedData.gardens) {
                            throw new Error("Format JSON tidak valid.");
                        }

                        showToast("Memproses data...");

                        // 1. Load Data Umum
                        records = importedData.records || [];
                        galleryPhotos = importedData.galleryPhotos || [];
                        gardens = importedData.gardens || [];
                        reminders = importedData.reminders || [];
                        maps = importedData.maps || [];
                        finances = importedData.finances || []; 
                        avatar = importedData.avatar || [];

                        // 2. KHUSUS PUPUK: Pastikan property 'isArchived' ada
                        fertilizers = (importedData.fertilizers || []).map(f => ({
                            ...f,
                            isArchived: f.isArchived === true // Default false jika tidak ada
                        }));

                        // 3. KHUSUS RACUN: Tambahin juga property 'isArchived'
                        poison = (importedData.poison || []).map(p => ({
                            ...p,
                            isArchived: p.isArchived === true // Default false jika tidak ada
                        }));
                        
                        // 4. Simpan ke Database (IndexedDB / LocalStorage via dbHelper)
                        await dbHelper.set(`records_${loggedInUsername}`, records);
                        await dbHelper.set(`gallery_${loggedInUsername}`, galleryPhotos);
                        await dbHelper.set(`gardens_${loggedInUsername}`, gardens);
                        await dbHelper.set(`reminders_${loggedInUsername}`, reminders);
                        await dbHelper.set(`fertilizers_${loggedInUsername}`, fertilizers);
                        await dbHelper.set(`poison_${loggedInUsername}`, poison);
                        await dbHelper.set(`maps_${loggedInUsername}`, maps);
                        await dbHelper.set(`finances_${loggedInUsername}`, finances);
                        await dbHelper.set(`avatar_${loggedInUsername}`, avatar);

                        showCustomDialog('Impor Berhasil', 'Data berhasil dipulihkan termasuk status arsip pupuk & racun.');
                        
                        // Refresh UI sesuai halaman yang lagi dibuka
                        if (typeof renderContent === 'function') {
                            renderContent(currentRecordType);
                        } else {
                            location.reload(); // Fallback jika renderContent tidak tersedia
                        }

                    } catch (error) {
                        showCustomDialog('Impor Gagal', 'Error: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            () => { event.target.value = ''; },
            'danger'
        );
    });
}


// --- MODAL CONTROLS ---
function openModal(id) { 
    const modal = document.getElementById(id);
    modal.style.display = 'flex'; 
    setTimeout(() => {
         modal.classList.add('active');
         if (id === 'ai-assistant-modal') {
             const chatMessages = document.getElementById('chat-messages');
             chatMessages.scrollTop = chatMessages.scrollHeight;
         }
    }, 10);
}

function openFormModal(type, gardenTitle, gardenId) { 
     closeModal('add-options-modal');
     document.getElementById('record-form').reset();
     document.getElementById('record-id').value = '';
     document.getElementById('perawatan-photo-file').value = '';
     document.getElementById('perawatan-photo-url').value = '';
     document.getElementById('photo-preview-perawatan').innerHTML = ''; 
     
     document.getElementById('pupuk-cost-display').value = '';
     document.getElementById('pupuk-cost').value = '0';
     
     document.getElementById('pupuk-reminder-date').value = ''; 
     document.getElementById('pupuk-reminder-time').value = ''; 
     document.getElementById('selected-tree-ids').value = '';
     const countLabel = document.getElementById('tree-selection-count');
     if(countLabel) countLabel.innerText = "0 Pohon Dipilih";
     if(document.getElementById('poison-cost-display')) {
         document.getElementById('poison-cost-display').value = '';
         document.getElementById('poison-cost').value = '0';
         document.getElementById('poison-total-display').value = '';
     }
     
     // AMBIL ELEMENT INPUTNYA
     const plantInput = document.getElementById('plant-name');
     const datalist = document.getElementById('garden-plants-list');

     if (gardenTitle) {
        plantInput.value = gardenTitle;
        plantInput.disabled = true; 
        document.getElementById('garden-id-reference').value = gardenId || ''; 
        
        // KALO ADA KEBUN: Pasang atribut list biar dropdown muncul (kalo perlu)
        // Atau biarkan disabled, toh user ga bisa ngetik.
        plantInput.setAttribute('list', 'garden-plants-list');
     } else {
        plantInput.value = '';
        plantInput.disabled = false;
        document.getElementById('garden-id-reference').value = '';

        // INI KUNCINYA: Buat "Tanpa Kebun", hapus atribut list-nya biar dropdown GA MUNCUL
        plantInput.removeAttribute('list');
     }

     // ISI DATALIST (Hanya isi jika memang mau ada dropdown)
     if (gardenTitle) {
        datalist.innerHTML = gardens.map(g => `<option value="${g.title}"></option>`).join('');
     } else {
        datalist.innerHTML = ''; // Kosongkan kalo tanpa kebun
     }

     document.getElementById('record-modal-title').textContent = `Tambah Catatan ${type}`;
     document.getElementById('record-type').value = type;
     toggleFormFields(type);
     
     if (type === 'Pemupukan') {
         populateFertilizerDropdown();
         updateFertilizerInfo(); 
     }
     
     calculatePupukTotal(); 
     if (type === 'Penyemprotan') {
         populatePoisonDropdown();
         updatePoisonInfo();
     }
     openModal('record-modal');
}

function populateFertilizerDropdown(forceIncludeId = null) {
    const select = document.getElementById('pupuk-id-select');
    if (!select) return;

    select.innerHTML = '<option value="">-- Pilih Pupuk --</option>';
    
    // Sortir: Pupuk yang stoknya ada di atas
    const sortedFertilizers = [...fertilizers].sort((a, b) => b.currentWeight - a.currentWeight);

    sortedFertilizers.forEach(f => {
        // LOGIKA: Tampilkan jika (Stok > 0 DAN Tidak Diarsipkan) ATAU (Ini adalah pupuk yang sedang diedit)
        const isAvailable = (f.currentWeight > 0 && !f.isArchived);
        const isTheOneBeingEdited = (forceIncludeId && f.id === forceIncludeId);

        if (isAvailable || isTheOneBeingEdited) {
            const opt = document.createElement('option');
            opt.value = f.id;
            
            // Tambahkan tanda visual jika stok habis tapi muncul karena sedang diedit
            let stockLabel = `(Sisa: ${f.currentWeight} kg)`;
            if (f.currentWeight <= 0) stockLabel = `(HABIS - ${f.currentWeight} kg)`;
            if (f.isArchived) stockLabel += ` [Diarsipkan]`;

            opt.textContent = `${f.name} ${stockLabel}`;
            select.appendChild(opt);
        }
    });
    
    const manualOpt = document.createElement('option');
    manualOpt.value = "MANUAL";
    manualOpt.textContent = "Lainnya / Manual";
    select.appendChild(manualOpt);
}

function updateFertilizerInfo() {
    const id = document.getElementById('pupuk-id-select').value;
    const info = document.getElementById('fertilizer-stock-info');
    const manualInput = document.getElementById('pupuk-manual-name');
    
    if (id === "MANUAL") {
        info.style.display = 'none';
        manualInput.style.display = 'block';
        manualInput.required = true;
    } else if (id) {
        const f = fertilizers.find(x => x.id === id);
        if (f) {
            info.textContent = `Stok tersedia: ${f.currentWeight} kg`;
            info.style.display = 'block';
        }
        manualInput.style.display = 'none';
        manualInput.required = false;
    } else {
        info.style.display = 'none';
        manualInput.style.display = 'none';
        manualInput.required = false;
    }
}

function showAddRecordOptions() {
     renderGardenSelection();
     openModal('add-options-modal');
}

function closeModal(id) { 
    const modal = document.getElementById(id);
    modal.classList.remove('active'); 
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function showCustomDialog(title, message, callback, actionText, actionType) {
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-message').innerHTML = message;
    const actions = document.getElementById('dialog-actions');
    actions.innerHTML = `<button type="button" class="cancel-btn" onclick="closeModal('custom-dialog')">Tutup</button>`;

    if (callback) {
        const actionBtn = document.createElement('button');
        actionBtn.textContent = actionText || 'Ya, Lakukan';
        actionBtn.className = actionType === 'danger' ? 'danger-btn' : 'save-btn';
        actionBtn.onclick = () => {
            closeModal('custom-dialog');
            callback();
        };
        actions.prepend(actionBtn); 
    }
    openModal('custom-dialog');
}

function showConfirmDialog(title, message, confirmCallback, cancelCallback, actionType) {
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-message').innerHTML = message;
    const actions = document.getElementById('dialog-actions');
    actions.innerHTML = `
        <button type="button" class="cancel-btn" onclick="closeModal('custom-dialog'); ${cancelCallback ? cancelCallback.name + '()' : ''}">Batal</button>
    `;
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Ya, Lanjutkan';
    confirmBtn.className = actionType === 'danger' ? 'danger-btn' : 'save-btn';
    
    confirmBtn.addEventListener('click', () => {
        closeModal('custom-dialog');
        if (typeof confirmCallback === 'function') {
            confirmCallback();
        }
    });

    actions.prepend(confirmBtn);
    openModal('custom-dialog');
}

// --- AI ASSISTANT FUNCTION ---
function openAiAssistantModal() {
    closeModal('custom-dialog');
    openModal('ai-assistant-modal');
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages.children.length === 0) {
         addAiMessage("Halo! Saya Asisten AI Tanaman.");
         addAiMessage(`Gunakan '/fitur untuk melihat fitur yang ada.`);
    }
}

// Tambahkan fungsi formatTime dan Ganti addChatMessage yang lama:
function formatTime() {
    const now = new Date();
    // Format waktu menjadi HH:mm (misalnya 16:05)
    return now.getHours().toString().padStart(2, '0') + ':' + 
           now.getMinutes().toString().padStart(2, '0');
}

function addChatMessage(message, sender) { 
    const chatMessages = document.getElementById('chat-messages'); 
    const messageDiv = document.createElement('div'); 
    messageDiv.className = `chat-message ${sender}`; 
    
    // Panggil fungsi formatTime() yang baru
    const timestampHTML = `<span class="chat-timestamp">${formatTime()}</span>`;
    
    // Ganti baris messageDiv.innerHTML agar ada timestamp
    messageDiv.innerHTML = `
        <div class="chat-bubble">
            ${message}
            ${timestampHTML} 
        </div>
    `;

    chatMessages.appendChild(messageDiv); 
    chatMessages.scrollTop = chatMessages.scrollHeight; 
} 

function addUserMessage(message) { addChatMessage(message, 'user'); } 
function addAiMessage(message) { addChatMessage(message, 'ai'); } 


function addUserMessage(message) { addChatMessage(message, 'user'); }
function addAiMessage(message) { addChatMessage(message, 'ai'); }

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    addUserMessage(message);
    input.value = '';
    setTimeout(() => {
        const aiResponse = getAiResponse(message);
        addAiMessage(aiResponse);
    }, 800);
}

document.getElementById('chat-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        sendChatMessage();
        e.preventDefault(); 
    }
});

/* =========================================
   üß† EINSTEIN OFFLINE AI ENGINE (VERSION 3.0)
   ========================================= */

// Helper untuk mendapatkan nilai harvest mentah (non-formatted)
function getRawTotalHarvest() {
    if (typeof records === 'undefined' || !Array.isArray(records)) return 0; 
    return records
        .filter(r => r.type === 'Panen')
        .reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
}

// Helper: Total Biaya Pupuk Historis (RP)
function getRawTotalFertilizerCost() {
    if (typeof fertilizers === 'undefined' || !Array.isArray(fertilizers)) return 0;
    
    // Menghitung (Harga per kg * Berat Awal (kg)) untuk semua item
    const totalCost = fertilizers.reduce((sum, f) => {
        const price = parseFloat(f.price) || 0; 
        const initialWeight = parseFloat(f.initialWeight) || 0;
        return sum + (price * initialWeight);
    }, 0);
    
    return totalCost;
}

// Helper: Rata-rata Panen (AVG Harvest per catatan)
function getRawAverageHarvest() {
    if (typeof records === 'undefined' || !Array.isArray(records)) return 0;
    const harvestRecords = records.filter(r => r.type === 'Panen');
    if (harvestRecords.length === 0) return 0;
    const total = harvestRecords.reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
    return total / harvestRecords.length;
}

// Helper: Hari Sejak Pemupukan Terakhir
function getDaysSinceLastFertilization() {
    if (typeof records === 'undefined' || !Array.isArray(records)) return null;
    const lastFertilizer = records.find(r => r.type === 'Pemupukan');
    if (!lastFertilizer) return null; // No record found

    const lastDate = new Date(lastFertilizer.date);
    const today = new Date();
    // Hitung perbedaan waktu dalam milidetik dan konversi ke hari
    const diffTime = Math.abs(today.getTime() - lastDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    return diffDays;
}

// Helper: Raw Harvest Productivity per Tree (kg/pokok historis)
function getRawProductivityPerTree() {
    const totalHarvest = getRawTotalHarvest(); 
    const totalTrees = gardens.reduce((sum, g) => sum + (parseInt(g.plantCount) || 0), 0);
    if (totalTrees === 0) return 0;
    return totalHarvest / totalTrees;
}


const aiAnalytics = {
    getTotalHarvest: () => {
        const total = getRawTotalHarvest(); 
        return total > 0 
            ? `Total panen yang tercatat di sistem sampai saat ini adalah **${total.toLocaleString('id-ID')} kg**.` 
            : "Belum ada data panen yang tercatat, Bos.";
    },
    getLastFertilizer: () => {
        const last = records.find(r => r.type === 'Pemupukan'); 
        if (!last) return "Sepertinya belum ada catatan pemupukan sama sekali.";
        return `Terakhir kali memupuk tanggal **${last.date}**. Pakai pupuk **${last.pupukType || 'Tidak Tercatat'}** dosis ${last.dose || 'Tidak Tercatat'}g/pohon.`;
    },
    countTrees: () => {
        const total = gardens.reduce((sum, g) => sum + (parseInt(g.plantCount) || 0), 0);
        return `Total populasi tanaman di semua kebun tercatat ada **${total} pokok**.`;
    },
    checkStock: (keyword) => {
        const items = fertilizers.filter(f => f.name.toLowerCase().includes(keyword));
        if (items.length === 0) return `Stok pupuk "${keyword}" kosong di gudang.`;
        return items.map(f => `- **${f.name}**: Sisa ${f.currentWeight} kg`).join('\n');
    },
    
    // FITUR V4.0: Rekomendasi Dosis Pupuk
    getFertilizerRecs: (ageType) => {
        const recs = {
            'tbm1': "Usia 1 Tahun (TBM 1):\n- Urea: 0.5 kg/pokok/tahun\n- RP/TSP: 0.5 kg/pokok/tahun\n- MOP: 0.25 kg/pokok/tahun\n- Kieserite: 0.25 kg/pokok/tahun\n**Diberikan 3-4 kali aplikasi per tahun.**",
            'tbm3': "Usia 3 Tahun (TBM 3):\n- Urea: 1.5 kg/pokok/tahun\n- RP/TSP: 1.0 kg/pokok/tahun\n- MOP: 2.0 kg/pokok/tahun\n- Kieserite: 1.5 kg/pokok/tahun\n**Diberikan 2-3 kali aplikasi per tahun.**",
            'tm': "Usia 4 Tahun ke atas (TM):\n- Urea: 2.5 kg/pokok/tahun\n- RP/TSP: 1.5 kg/pokok/tahun\n- MOP: 4.0 kg/pokok/tahun\n- Kieserite: 2.0 kg/pokok/tahun\n**Diberikan 2 kali aplikasi per tahun.**"
        };
        
        let key = ageType.includes('tm') || ageType.includes('4') ? 'tm' : 
                  ageType.includes('3') ? 'tbm3' : 'tbm1';
                  
        return `üóìÔ∏è **Rekomendasi Pupuk ${key.toUpperCase()} (Standard):**\n${recs[key]}`;
    },
    
    // FITUR V5.0 REVISI: Total Biaya Pupuk
    getTotalFertilizerCost: () => {
        const cost = getRawTotalFertilizerCost();
        
        if (cost === 0) return "Belum ada data harga/berat awal pupuk yang tercatat.";
        
        return `üí∞ **TOTAL BIAYA PUPUK HISTORIS**\nTotal Uang yang dikeluarkan untuk pembelian pupuk tercatat: **Rp ${cost.toLocaleString('id-ID', { maximumFractionDigits: 0 })}**`;
    },
    
    // FITUR V6.0: Analisis Tren Panen
    getHarvestTrend: () => {
        const harvestRecords = records.filter(r => r.type === 'Panen');
        if (harvestRecords.length < 2) return "Perlu minimal 2 catatan panen untuk menganalisis tren.";

        const lastHarvest = parseFloat(harvestRecords[0].quantity) || 0;
        const avgHarvest = getRawAverageHarvest();
        const diff = lastHarvest - avgHarvest;
        
        let trendText = "";
        
        if (diff > (avgHarvest * 0.1)) { 
            trendText = `üìà **MENINGKAT PESAT!** Panen terakhir (${lastHarvest.toLocaleString('id-ID')} kg) **${((diff/avgHarvest)*100).toFixed(1)}%** lebih tinggi dari rata-rata historis (${avgHarvest.toLocaleString('id-ID', { maximumFractionDigits: 1 })} kg).`;
        } else if (diff > 0) {
            trendText = `‚¨ÜÔ∏è **MENINGKAT.** Panen terakhir (${lastHarvest.toLocaleString('id-ID')} kg) sedikit di atas rata-rata (${avgHarvest.toLocaleString('id-ID', { maximumFractionDigits: 1 })} kg). Pertahankan!`;
        } else if (diff < (avgHarvest * -0.1)) { 
            trendText = `üìâ **MENURUN DRASTIS!** Panen terakhir (${lastHarvest.toLocaleString('id-ID')} kg) **${((diff/avgHarvest)*-100).toFixed(1)}%** di bawah rata-rata historis (${avgHarvest.toLocaleString('id-ID', { maximumFractionDigits: 1 })} kg). Perlu dievaluasi.`;
        } else if (diff < 0) {
            trendText = `‚¨áÔ∏è **MENURUN.** Panen terakhir (${lastHarvest.toLocaleString('id-ID')} kg) sedikit di bawah rata-rata (${avgHarvest.toLocaleString('id-ID', { maximumFractionDigits: 1 })} kg).`;
        } else {
            trendText = "‚ÜîÔ∏è **STABIL.** Hasil panen terakhir sama persis dengan rata-rata historis.";
        }
        
        return `‚úÖ **ANALISIS TREN PANEN**\n${trendText}`;
    },
    
    // FITUR V7.0: Peringatan Stok Pupuk Rendah
    checkLowStock: () => {
        if (typeof fertilizers === 'undefined' || fertilizers.length === 0) return "Belum ada pupuk yang terdaftar di stok, Bos.";
        
        const lowStockItems = fertilizers.filter(f => {
            const initial = parseFloat(f.initialWeight) || 0;
            const current = parseFloat(f.currentWeight) || 0;
            // Warning if current stock is less than 10% of initial stock AND current stock is less than 50kg
            return initial > 0 && current < (initial * 0.1) && current < 50; 
        });

        if (lowStockItems.length === 0) {
            return "‚úÖ Semua stok pupuk dalam kondisi AMAN dan di atas batas minimal. Tidak ada yang perlu dibeli segera.";
        }
        
        let response = "üö® **PERINGATAN STOK RENDAH!**\nBeberapa pupuk mendekati habis (<10% sisa atau <50kg):\n";
        response += lowStockItems.map(f => 
            `- **${f.name}**: Sisa **${f.currentWeight.toLocaleString('id-ID', { maximumFractionDigits: 1 })} kg** (AWAL: ${f.initialWeight} kg)`
        ).join('\n');
        response += "\n\nMohon segera lakukan pembelian ulang.";
        
        return response;
    },
    
    // FITUR V8.0: Analisis Biaya Pupuk per Kg Panen
    getCostPerKgHarvest: () => {
        const totalCost = getRawTotalFertilizerCost();
        const totalHarvest = getRawTotalHarvest();
    
        if (totalHarvest === 0) return "Belum ada data panen yang tercatat. Analisis tidak bisa dihitung.";
        if (totalCost === 0) return "Belum ada data harga/berat awal pupuk yang tercatat untuk menghitung total biaya.";
    
        const costPerKg = totalCost / totalHarvest;
        let commentary;
        
        if (costPerKg < 500) {
            commentary = "üöÄ **FANTASTIS!** Biaya pupuk Anda sangat rendah per kg panen. Efisiensi luar biasa!";
        } else if (costPerKg < 1000) {
            commentary = "üëç **SANGAT BAIK.** Biaya pupuk per kg panen berada di level kompetitif.";
        } else if (costPerKg < 1500) {
            commentary = "‚ö†Ô∏è **PERLU PERHATIAN.** Biaya pupuk per kg panen mulai tinggi. Cek ulang dosis, jenis pupuk, dan kemungkinan panen tidak optimal.";
        } else {
            commentary = "üö® **TINGGI!** Biaya pupuk Anda mahal dibandingkan hasil panen. Harus segera dievaluasi atau profit akan tergerus.";
        }
    
        return `üí≤ **ANALISIS BIAYA PUPUK / KG PANEN**\nTotal Biaya Pupuk Historis: Rp ${totalCost.toLocaleString('id-ID', { maximumFractionDigits: 0 })}\nTotal Panen Historis: ${totalHarvest.toLocaleString('id-ID')} kg\n-------------------\n**Biaya Pupuk per Kg TBS: Rp ${costPerKg.toLocaleString('id-ID', { maximumFractionDigits: 0 })}**\n\n*Komentar AI:* ${commentary}`;
    },
    
    // FITUR V9.0: Peringatan Jadwal Pemupukan Ulang
    checkFertilizationSchedule: () => {
        const days = getDaysSinceLastFertilization();
        const thresholdDays = 90; // Siklus ideal 3 bulan (90 hari)

        if (days === null) return "‚ùå **JADWAL KOSONG.** Belum ada catatan pemupukan sama sekali. Kapan mau mulai, Bos?";
        
        if (days > thresholdDays) {
            const overDue = days - thresholdDays;
            return `‚è∞ **JADWAL TERLAMBAT!**\nTerakhir memupuk **${days} hari** yang lalu. Sudah terlambat **${overDue} hari** dari jadwal ideal 3 bulanan. Segera lakukan pemupukan ulang!`;
        } else if (days > thresholdDays - 30) { // 30 hari sebelum deadline
            const daysLeft = thresholdDays - days;
            return `üîî **PERSIAPAN PUPUK.**\nTerakhir memupuk **${days} hari** yang lalu. Tinggal **${daysLeft} hari** lagi menuju jadwal ideal (90 hari). Mulai siapkan stok sekarang.`;
        } else {
            return `‚úÖ **JADWAL AMAN.** Terakhir memupuk ${days} hari yang lalu. Masih ada waktu cukup sebelum pemupukan selanjutnya (90 hari).`;
        }
    },
    
    // FITUR V10.0: Analisis Produktivitas Panen per Pohon
    getHarvestProductivity: () => {
        const totalHarvest = getRawTotalHarvest();
        const totalTrees = gardens.reduce((sum, g) => sum + (parseInt(g.plantCount) || 0), 0);
        const productivity = getRawProductivityPerTree();

        if (totalTrees === 0) return "Belum ada kebun yang terdaftar (Jumlah Pohon 0). Tidak bisa menghitung produktivitas per pohon.";
        if (totalHarvest === 0) return "Belum ada data panen yang tercatat. Produktivitas per pohon masih nol.";

        let commentary;
        
        // Komentar didasarkan pada total hasil historis/pokok, bukan per tahun.
        if (productivity > 150) {
            commentary = "üöÄ **PERFORMANS SANGAT KUAT!** Rata-rata hasil historis per pohon menunjukkan manajemen kebun yang efektif dan sehat.";
        } else if (productivity > 80) {
            commentary = "üëç **CUKUP BAIK.** Produktivitas di atas rata-rata dasar. Pertahankan pemupukan dan perawatan.";
        } else if (productivity > 30) {
            commentary = "‚ö†Ô∏è **SEDANG.** Produktivitas masih rendah atau data panen masih sedikit. Jika kebun sudah TM, perlu evaluasi intensif.";
        } else {
            commentary = "üö® **SANGAT RENDAH.** Produktivitas sangat minim. Ini wajar jika kebun masih TBM atau baru mulai panen.";
        }

        return `üå≥ **PRODUKTIVITAS PANEN PER POHON (HISTORIS)**\nTotal Panen: ${totalHarvest.toLocaleString('id-ID')} kg\nTotal Pohon: ${totalTrees.toLocaleString('id-ID')} pokok\n-------------------\n**Rata-rata Hasil per Pohon: ${productivity.toLocaleString('id-ID', { maximumFractionDigits: 2 })} kg/pokok**\n\n*Komentar AI:* ${commentary}`;
    },
    
    // FITUR V11.0: Analisis Margin Profit per Kg TBS
    getProfitMarginPerKg: (price) => {
        const totalCost = getRawTotalFertilizerCost();
        const totalHarvest = getRawTotalHarvest();

        if (totalHarvest === 0) return "Belum ada data panen yang tercatat. Analisis Margin Profit tidak bisa dihitung.";
        if (totalCost === 0) return "Belum ada data harga/berat awal pupuk yang tercatat untuk menghitung biaya per kg.";

        const costPerKg = totalCost / totalHarvest;
        const margin = price - costPerKg;
        
        let commentary;
        
        if (margin < 0) {
            commentary = "üõë **RUGI!** Margin negatif. Total biaya pupuk melebihi harga jual TBS. HARUS EVALUASI BIAYA PUPUK!";
        } else if (margin < price * 0.2) { // Margin is less than 20% of selling price
            commentary = "‚ö†Ô∏è **MARGIN RENDAH.** Margin profit per kg kecil. Perlu meningkatkan efisiensi biaya lain atau meningkatkan hasil panen.";
        } else {
            commentary = "üí∞ **MARGIN SEHAT.** Margin profit per kg sangat baik. Pertahankan efisiensi biaya dan produktivitas kebun.";
        }

        return `üìà **ANALISIS MARGIN PROFIT PER KG TBS**\n> Harga Jual TBS (Input): Rp ${price.toLocaleString('id-ID', { maximumFractionDigits: 0 })}/kg\n> Biaya Pupuk Historis per Kg TBS: Rp ${costPerKg.toLocaleString('id-ID', { maximumFractionDigits: 0 })}/kg\n-------------------\n**MARGIN PROFIT BERSIH per Kg: Rp ${margin.toLocaleString('id-ID', { maximumFractionDigits: 0 })}**\n\n*Komentar AI:* ${commentary}`;
    }
};

// 2. BASIS PENGETAHUAN MENDALAM (DEEP KNOWLEDGE)
const aiKnowledge = {
    sawit: {
        keywords: ['sawit', 'kelapa sawit', 'tbs'],
        facts: [
            "Jarak tanam sawit **9m x 9m x 9m** (segitiga sama sisi) menghasilkan populasi **143 pohon/hektar**.",
            "Standar panen: Minimal 2 brondolan lepas alami di piringan. Jangan panen buah mentah, rendemen minyaknya rendah!",
            "Kastrasi (buang bunga) dilakukan umur 12-20 bulan. Tujuannya biar batang besar & seragam dulu, jangan nafsu buah pasir.",
            "Piringan (bokoran) harus bersih radius 1.5 - 2 meter agar pupuk tidak dimakan gulma, tapi jangan sampai tanah gundul total (erosi).",
            "Tunas pasir (sanitasi) dilakukan sebelum panen perdana. Buang pelepah kering dan bunga jantan."
        ],
        hama: {
            'ulat': "Ulat Api/Kantong: Semprot **Deltametrin** (Decis) atau **Sipermetrin** (Ripcord). Kalau serangan dikit, kutip manual aja pake sarung tangan.",
            'kumbang': "Kumbang Tanduk (Oryctes): Serang TBM. Pake **Feromon** (Pherotrap) buat jebak, atau tabur **Karbofuran** di pucuk (hati-hati racun).",
            'tikus': "Tikus makan buah/bunga: Pake racun antikoagulan (Ratgone) di ketiak pelepah. Musuh alaminya Burung Hantu."
        }
    },
    racun: {
        herbisida: {
            'kuning': "**Glifosat** (sistemik): Mati sampai akar, tapi lama (7-10 hari). Bagus buat ilalang/teki. Jangan kena daun sawit muda!",
            'biru': "**Paraquat** (kontak): Mati cepat (bakar), tapi akarnya hidup lagi. Bagus buat piringan (bokoran) biar akar sawit aman.",
            'kayu': "**Triklopir** (Garlon) atau **Metsulfuron** (Ally): Spesialis anak kayu, pakis, dan keladi liar."
        },
        fungisida: {
            'ganoderma': "Ganoderma (Jamur Akar): Belum ada obat paten. Pencegahan pake **Trichoderma** saat tanam. Isolasi parit gajah kalo ada yang kena.",
            'bercak': "Bercak Daun (Curvularia): Semprot **Mankozeb** atau **Difenokonazol**."
        }
    }
};

// 3. LOGIKA HUMANIS & KONTEKSTUAL
const aiPersona = {
    Toxic: ["Lu kontol", "Lu memek", "anak anjing lo", "mentang mentang gw ai malah lu kata katain", "apalah si kontol ini"],
    greetings: ["Halo Bos! Siap bantu urus kebun.", "Hadir. Gimana kondisi kebun hari ini?", "Oi Bos, ada yang bisa dibantu?", "Halo, Asisten siap 86."],
    agrees: ["Siap laksanakan!", "Copy that, beres.", "Oke, data diamankan.", "Mantap, udah dieksekusi."],
    confused: ["Waduh, gagal paham saya.", "Bisa pake bahasa lain Bos?", "Maksudnya gimana tuh?", "Otak saya belum nyampe situ Bos, coba lebih simpel."],
    encouragement: ["Semangat, Bos! Kebun yang bagus itu hasil kerja keras yang konsisten.", "Gas pol, jangan kasih kendor! Panen raya di depan mata.", "Istirahat dulu kalau capek, Bos. Biar besok makin fresh ngurus kebunnya."],
    status: ["Lancar jaya Bos! Saya siap 24 jam.", "Saya mah bagus-bagus aja Bos, tergantung data yang masuk. Ada yang seru hari ini?", "Siap! Semua sistem hijau, data aman."],
    fallback: ["Maaf Bos, pertanyaan itu di luar area sawit saya. Coba fokus ke pupuk, panen, atau biaya ya.", "Hmm, saya belum terprogram untuk menjawab itu. Mau coba tanya soal biaya pupuk per kg panen?", "Saya bingung, Bos. Coba tanyakan hal lain yang berhubungan dengan kebun."]
};
function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// 4. ACTION HANDLERS (AI YANG BEKERJA)

function aiActionAddStock(text) {
    // Regex pintar: deteksi angka desimal, kg/sak/karung
    let qtyMatch = text.match(/(\d+[\.,]?\d*)\s*(kg|sak|karung|zak)/i) || text.match(/(\d+[\.,]?\d*)/);
    let nameClean = text.replace(/tambah|beli|stok|pupuk|kg|sak|karung|zak|rp|harga/gi, "").replace(/\d+/g, "").trim();
    
    if (nameClean.length < 2) nameClean = "Pupuk Baru";
    let weight = qtyMatch ? parseFloat(qtyMatch[1].replace(',', '.')) : 0;
    
    // Auto-convert Sak ke KG (Asumsi 1 sak = 50kg)
    if (text.match(/sak|karung|zak/i)) {
        weight *= 50;
        nameClean += " (ex-Sak)";
    }

    if (weight > 0) {
        const newFert = {
            id: Date.now().toString(),
            name: nameClean.charAt(0).toUpperCase() + nameClean.slice(1),
            dateBuy: new Date().toISOString().slice(0, 10),
            price: 0,
            currentWeight: weight,
            initialWeight: weight
        };
        fertilizers.unshift(newFert);
        saveFertilizers();
        if(currentRecordType === 'Daftar Pupuk') renderFertilizerList();
        return `${getRandom(aiPersona.agrees)} Stok **${newFert.name}** sebanyak **${weight} kg** berhasil ditambahkan!`;
    }
    return "Berapa banyak stoknya? Sebutin angkanya. Contoh: 'tambah stok KCL 2 sak' atau 'beli urea 50kg'.";
}

function aiActionAddGarden(text) {
    let name = text.replace(/buat|bikin|tambah|kebun|lahan|baru/gi, "").trim();
    if(name.length < 3) return "Kebun apa namanya Bos? Contoh: 'Buat kebun Sawit Blok C'";
    
    let variety = "-";
    if(name.toLowerCase().includes('sawit')) variety = "Kelapa Sawit";
    if(name.toLowerCase().includes('durian')) variety = "Durian";

    const newGarden = {
        id: Date.now().toString(),
        title: name.charAt(0).toUpperCase() + name.slice(1),
        dateTanam: new Date().toISOString().slice(0, 10),
        plantCount: 0,
        varieties: variety,
        area: 0
    };
    gardens.unshift(newGarden);
    saveGardens();
    if(currentRecordType === 'Daftar Kebun') renderGardenList();
    return `${getRandom(aiPersona.agrees)} Kebun **${newGarden.title}** sudah dibuat.`;
}

function aiActionAddNote(text) {
    let type = 'Perawatan';
    if (text.match(/panen|petik/i)) type = 'Panen';
    else if (text.match(/pupuk|cor|tabur/i)) type = 'Pemupukan';
    else if (text.match(/semprot|spray/i)) type = 'Penyemprotan';
    else if (text.match(/pruning|tunas/i)) type = 'Pruning';
    else if (text.match(/kastrasi|bunga/i)) type = 'Kastrasi';
    
    let amountMatch = text.match(/(\d+[\.,]?\d*)/);
    let amount = amountMatch ? parseFloat(amountMatch[1].replace(',', '.')) : 0;
    let notes = text.replace(/catat|tulis|input|data|panen|pupuk|kg|gram|batang|pokok/gi, "").trim();

    const newRecord = {
        id: Date.now().toString(),
        type: type,
        plantName: "Catatan AI",
        date: new Date().toISOString().slice(0, 10),
        notes: `Via AI: ${notes}`,
        quantity: amount,
        totalUsed: (type === 'Pemupukan' ? amount * 1000 : 0) // asumsi input kg
    };
    
    records.unshift(newRecord);
    saveRecords();
    if(currentRecordType === 'Dashboard' || currentRecordType === 'Daftar Catatan') {
        renderRecordList(); renderDashboard();
    }
    return `${getRandom(aiPersona.agrees)} Catatan **${type}** disimpan.`;
}

// 5. OTAK UTAMA (MAIN BRAIN CONTROLLER)
function getAiResponse(message) {
    const msg = message.toLowerCase();
    
    if (msg.trim() === '/fitur' || msg.trim() == 'fitur'){
        const featureList = `
**üìã Daftar Fitur Saya (V11.0) **
----------------
[1]. **Analisis Finansial**
   - Margin Profit/Kg: *Cth:* **"Margin profit harga 2500"**
   - Biaya per Kg Panen: *Cth:* **"Biaya pupuk per kg"**
   - Total Pengeluaran: *Cth:* **"Total biaya pupuk"**
   
[2]. **Kinerja & Produktivitas**
   - Analisis Tren Panen: *Cth:* **"Tren panen"**
   - Produktivitas Pohon: *Cth:* **"Rata-rata hasil per pokok"**
   - Hitung Populasi: *Cth:* **"Populasi 10 hektar"**

[3]. **Perencanaan & Stok**
   - Jadwal Pemupukan: *Cth:* **"Cek jadwal pupuk ulang"**
   - Peringatan Stok Rendah: *Cth:* **"Kondisi stok pupuk"**
   - Cek Stok Spesifik: *Cth:* **"Cek stok MOP"**

[4]. **Input Data Cepat**
   - Catat Panen: *Cth:* **"Catat panen 4 ton"**
   - Tambah Stok: *Cth:* **"Tambah stok Urea 2 sak"**
   - Buat Kebun Baru: *Cth:* **"Buat kebun Blok C"**

[5]. **Konsultasi Teknis**
   - Rekomendasi Dosis: *Cth:* **"Dosis pupuk TBM 3 tahun"**
   - Diagnosa Defisiensi: *Cth:* **"Daun kuning kenapa?"**
   - Info Hama/Racun: *Cth:* **"Cara basmi kumbang tanduk"**

[6]. **Konversi**
   - Konversi: *Cth:* **"Konversi 500 kg ke gram"**
   Konversi: *Cth:* **"Konversi 500 m2 ke hektar"**
`;
        return featureList;
    }
    

    // --- A. INTENT: ANALISIS DATA USER ---
    if (msg.includes('total panen') || msg.includes('dapat berapa')) return aiAnalytics.getTotalHarvest();
    if (msg.includes('terakhir') && (msg.includes('pupuk') || msg.includes('makan'))) return aiAnalytics.getLastFertilizer();
    if (msg.includes('jumlah pohon') || msg.includes('berapa batang')) return aiAnalytics.countTrees();
    if (msg.includes('cek stok') || msg.includes('sisa pupuk')) {
        const keyword = msg.replace('cek stok', '').replace('sisa pupuk', '').trim();
        return keyword ? aiAnalytics.checkStock(keyword) : "Mau cek stok pupuk apa? Sebut namanya.";
    }
    
    // FITUR V11.0: ANALISIS MARGIN PROFIT PER KG
    if (msg.includes('margin profit') || msg.includes('untung per kg') || msg.includes('selisih harga')) {
        // Regex untuk mencari angka di dekat kata 'harga', 'rp', atau 'jual'
        const priceMatch = msg.match(/harga\s*(\d{3,}(?:\.?\d{3})*)/i) || msg.match(/(\d{3,}(?:\.?\d{3})*)/);
        let price = priceMatch ? parseInt(priceMatch[1].replace(/\./g, '')) : 0;
        
        if (price === 0) {
            return `Berapa harga jual TBS per kg saat ini, Bos? (Contoh: Hitung margin harga 2300)`;
        }
        
        return aiAnalytics.getProfitMarginPerKg(price);
    }

    // FITUR V10.0: PRODUKTIVITAS PANEN PER POHON
    if (msg.includes('produktivitas per pohon') || msg.includes('rata-rata hasil per pohon') || msg.includes('hasil per pokok')) {
        return aiAnalytics.getHarvestProductivity();
    }

    // FITUR V9.0: PERINGATAN JADWAL PUPUK ULANG
    if (msg.includes('jadwal pupuk ulang') || msg.includes('kapan pupuk lagi') || msg.includes('cek pemupukan')) {
        return aiAnalytics.checkFertilizationSchedule();
    }
    
    // FITUR V8.0: ANALISIS BIAYA PUPUK PER KG PANEN
    if (msg.includes('biaya pupuk per kg') || msg.includes('cost per kg') || msg.includes('analisis cost')) {
        return aiAnalytics.getCostPerKgHarvest();
    }

    // FITUR V7.0: PERINGATAN STOK RENDAH
    if (msg.includes('kondisi stok') || msg.includes('stok harus dibeli') || msg.includes('stok kurang')) {
        return aiAnalytics.checkLowStock();
    }

    // FITUR V6.0: ANALISIS TREN PANEN
    if (msg.includes('tren panen') || msg.includes('analisis panen') || msg.includes('kinerja panen')) {
        return aiAnalytics.getHarvestTrend();
    }

    // FITUR V5.0 REVISI: TOTAL BIAYA PUPUK HISTORIS
    if (msg.includes('total biaya pupuk') || msg.includes('pengeluaran pupuk') || msg.includes('modal pupuk')) {
        return aiAnalytics.getTotalFertilizerCost();
    }

    // FITUR V4.0: PROFIT CALCULATION (Gross Revenue)
    if (msg.includes('hitung profit') || msg.includes('untung panen') || msg.includes('harga jual')) {
        const rawHarvest = getRawTotalHarvest();
        if (rawHarvest === 0) return "Data panen masih kosong, Bos. Silakan catat panen dulu.";
        
        // Regex untuk mencari angka di dekat kata 'harga', 'rp', atau 'jual'
        const priceMatch = msg.match(/harga\s*(\d{3,}(?:\.?\d{3})*)/i) || msg.match(/(\d{3,}(?:\.?\d{3})*)/);
        let price = priceMatch ? parseInt(priceMatch[1].replace(/\./g, '')) : 0;

        if (price === 0) {
            return `Total panen Anda **${rawHarvest.toLocaleString('id-ID')} kg**. Berapa harga jual TBS per kg saat ini? (Contoh: Hitung profit harga 2300)`;
        }

        const profit = rawHarvest * price;
        return `üíµ **ESTIMASI PENDAPATAN KOTOR**\nTotal Panen: ${rawHarvest.toLocaleString('id-ID')} kg\nHarga Jual: Rp ${price.toLocaleString('id-ID')}/kg\n-------------------\n**Total Profit: Rp ${profit.toLocaleString('id-ID')}**`;
    }
    
    // FITUR V4.0: FERTILIZER DOSAGE REC
    if (msg.includes('rekomendasi pupuk') || msg.includes('dosis pupuk') || msg.includes('jadwal pupuk')) {
        let age = msg.match(/tbm|tm|\d+\s*tahun|umur\s*\d+/);
        age = age ? age[0] : 'tbm1'; // Default ke TBM 1
        return aiAnalytics.getFertilizerRecs(age);
    }
    
    // --- B. INTENT: ACTION ---
    if (msg.match(/tambah stok|beli pupuk/)) return aiActionAddStock(msg);
    if (msg.match(/buat kebun|tambah kebun/)) return aiActionAddGarden(msg);
    if (msg.match(/catat|tulis/)) return aiActionAddNote(msg);
    
    // --- C. INTENT: KONTEKS CUACA ---
    if (msg.includes('hujan')) return "Lagi hujan Bos? üåßÔ∏è **Jangan memupuk** dulu ya, nanti hanyut. Kalau nyemprot juga percuma luntur. Ngopi dulu aja.";
    if (msg.includes('panas')) return "Cuaca panas? ‚òÄÔ∏è Waktu yang pas buat nyemprot herbisida sistemik (racun kuning) biar serapannya mantap.";

    // --- D. INTENT: KNOWLEDGE SAWIT ---
    if (aiKnowledge.sawit.keywords.some(k => msg.includes(k))) {
        // Hama
        if (msg.includes('ulat')) return aiKnowledge.sawit.hama.ulat;
        if (msg.includes('kumbang') || msg.includes('tanduk')) return aiKnowledge.sawit.hama.kumbang;
        if (msg.includes('tikus')) return aiKnowledge.sawit.hama.tikus;
        
        // Teknis
        if (msg.includes('jarak')) return aiKnowledge.sawit.facts[0];
        if (msg.includes('panen')) return aiKnowledge.sawit.facts[1];
        if (msg.includes('kastrasi') || msg.includes('bunga')) return aiKnowledge.sawit.facts[2];
        if (msg.includes('piringan') || msg.includes('semak')) return aiKnowledge.sawit.facts[3];
        return `Fakta Sawit: ${getRandom(aiKnowledge.sawit.facts)}`;
    }

    // --- E. INTENT: DIAGNOSA & RACUN ---
    if (msg.includes('daun') || msg.includes('kuning') || msg.includes('bintik')) {
        if (msg.includes('kuning')) return aiKnowledge.pupuk.defisiensi.kuning;
        if (msg.includes('bintik') || msg.includes('oranye')) return aiKnowledge.pupuk.defisiensi.bintik;
        if (msg.includes('putih') || msg.includes('keriting')) return aiKnowledge.pupuk.defisiensi.putih;
        if (msg.includes('ungu')) return aiKnowledge.pupuk.defisiensi.ungu;
    }
    
    if (msg.includes('racun') || msg.includes('obat') || msg.includes('basmi')) {
        if (msg.includes('ilalang') || msg.includes('kuning')) return aiKnowledge.racun.herbisida.kuning;
        if (msg.includes('bakar') || msg.includes('cepat')) return aiKnowledge.racun.herbisida.biru;
        if (msg.includes('kayu') || msg.includes('pakis')) return aiKnowledge.racun.herbisida.kayu;
        if (msg.includes('jamur') || msg.includes('ganoderma')) return aiKnowledge.racun.fungisida.ganoderma;
        return "Mau basmi apa? Rumput, Anak kayu, atau Jamur?";
    }

    // --- F. INTENT: KALKULATOR POPULASI ---
    // Regex: "populasi 2 hektar"
    const popMatch = msg.match(/populasi\s+(\d+[\.,]?\d*)\s*(ha|hektar)/);
    if (popMatch) {
        const ha = parseFloat(popMatch[1].replace(',', '.'));
        const trees = Math.round(ha * 143); // Standar 143 SPH
        return `üßÆ Untuk lahan **${ha} Hektar** dengan jarak tanam 9x9m (Mata Lima), populasi standarnya adalah sekitar **${trees} pohon** (+/-).`;
    }

    // --- G. INTENT: KONVERSI ---
    const conv = msg.match(/(konversi|ubah|berapa)\s+([\d\.]+)\s*([a-z0-9]+)\s+(ke|menjadi)\s*([a-z0-9]+)/);
    if (conv) {
        const val = parseFloat(conv[2]);
        const from = conv[3];
        const to = conv[5];
        if (from.includes('m') && to.includes('hektar')) return `üìü ${val} m¬≤ = **${val/10000} Hektar**.`;
        if (from.includes('hektar') && to.includes('m')) return `üìü ${val} Ha = **${(val*10000).toLocaleString('id-ID')} m¬≤**.`;
        if (from === 'kg' && to === 'gram') return `üìü ${val} kg = **${(val*1000).toLocaleString('id-ID')} gram**.`;
        if (from === 'ton' && to === 'kg') return `üìü ${val} Ton = **${(val*1000).toLocaleString('id-ID')} kg**.`;
    }

    // --- H. FALLBACK & GENERAL CHAT ---
    if (msg.includes('halo') || msg.includes('hai') || msg.includes('pagi') || msg.includes('siang') || msg.includes('malam')) return getRandom(aiPersona.greetings);
    if (msg.includes('makasih') || msg.includes('terima kasih') || msg.includes('thanks')) return "Sama-sama Bos! Jangan lupa ngopi ‚òï";
    if (msg.includes('siapa pencipta lu?') || msg.includes('siapa pencipta lu')) return "Saya diciptakan oleh bos Randa üòé";
    if (msg.includes('assalamualaikum')) return "Waalaikumsalam";
    
    // New Human-like responses
    if (msg.includes('gimana') || msg.includes('apa kabar') || msg.includes('bagus') || msg.includes('baik')) return getRandom(aiPersona.status);
    if (msg.includes('semangat') || msg.includes('capek') || msg.includes('lelah') || msg.includes('istirahat')) return getRandom(aiPersona.encouragement);
    
    // Toxic/Naughty words
    if (msg.includes('memek') || msg.includes('kontol') || msg.includes('anjing') || msg.includes('tolol')) return getRandom(aiPersona.Toxic);
    
    // Final Fallback
    return getRandom(aiPersona.fallback);
}


// --- AUTHENTICATION & PROFIL MANAGEMENT ---
function openRegisterModal() {
    closeModal('login-screen');
    document.getElementById('register-form').reset();
    openModal('register-modal');
}

async function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value.trim();

    if (!username || !password) {
        showCustomDialog('Error', 'Username dan Password tidak boleh kosong.');
        return;
    }

    if (registeredUsers.some(u => u.username === username)) {
        showCustomDialog('Error', `Username **${username}** sudah terdaftar.`);
        return;
    }

    registeredUsers.push({ username, password });
    await saveRegisteredUsers(); // Await IDB save
    closeModal('register-modal');

    document.getElementById('username').value = username;
    document.getElementById('password').value = password;

    setTimeout(() => {
        showCustomDialog(
            'Pendaftaran Berhasil',
            `Akun **${username}** berhasil didaftar. Silakan Login.`,
            () => {
                closeModal('custom-dialog');handleLogin(); 
    },
    'Login Sekarang'
);

                
    



// Paksa tombol tutup (Batal) untuk ke login screen juga
const closeBtn = document.querySelector('#custom-dialog .cancel-btn');
if(closeBtn) {
    closeBtn.onclick = () => {
        closeModal('custom-dialog');
        document.getElementById('login-screen').style.display = 'flex';
    };
}
}, 350);
}


function handleLogin() {
    if (typeof closeAvatarMenu === 'function') {
        closeAvatarMenu(); 
    }
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    const loginError = document.getElementById('login-error');
    loginError.style.display = 'none';
    
    const userFound = registeredUsers.find(u => u.username === user && u.password === pass);

    if (userFound) {
        loggedInUsername = user;
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInUsername', loggedInUsername);
        
        loginScreen.style.display = 'none';
        loadingIndicator.style.display = 'flex'; 
        
        // Panggil init ulang atau load data manual
        setTimeout(async () => {
            await loadUserData(loggedInUsername);
            await loadUserAvatar(); // Load avatar from IDB
            
            const capitalizedUser = user.charAt(0).toUpperCase() + user.slice(1);
            document.getElementById('header-username').textContent = `Halo, ${capitalizedUser}!`;
            
            loadingIndicator.style.display = 'none'; 
            app.style.display = 'block';
            checkDarkMode();
            renderContent('Dashboard');
        }, 1000); 

    } else {
        loginError.textContent = 'Username atau Password salah.';
        loginError.style.display = 'block';
    }
}

function handleLogout() {
    closeAvatarMenu();
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('loggedInUsername');
    records = []; galleryPhotos = []; gardens = []; reminders = []; fertilizers = []; maps = [];
    window.location.reload();
}

async function performAccountDeletion() {
    await dbHelper.delete(`records_${loggedInUsername}`);
    await dbHelper.delete(`gallery_${loggedInUsername}`);
    await dbHelper.delete(`gardens_${loggedInUsername}`);
    await dbHelper.delete(`reminders_${loggedInUsername}`);
    await dbHelper.delete(`fertilizers_${loggedInUsername}`);
    await dbHelper.delete(`poison_${loggedInUsername}`);
    await dbHelper.delete(`maps_${loggedInUsername}`);
    await dbHelper.delete(`avatar_${loggedInUsername}`);
    await dbHelper.delete(`finances_${loggedInUsername}`);


    registeredUsers = registeredUsers.filter(u => u.username !== loggedInUsername);
    await saveRegisteredUsers();
    handleLogout();
}

// ** FITUR HAPUS AKUN **
function confirmDeleteAccount() {
    showConfirmDialog(
        'Hapus Akun?',
        'PERINGATAN: Tindakan ini tidak bisa dibatalkan. Semua data catatan, kebun, dan foto Anda akan dihapus selamanya. Yakin?',
        performAccountDeletion, 
        null,
        'danger'
    );
}

function performAccountDeletion() {
    localStorage.removeItem(`records_${loggedInUsername}`);
    localStorage.removeItem(`gallery_${loggedInUsername}`);
    localStorage.removeItem(`gardens_${loggedInUsername}`);
    localStorage.removeItem(`reminders_${loggedInUsername}`);
    localStorage.removeItem(`fertilizers_${loggedInUsername}`);
    localStorage.removeItem(`maps_${loggedInUsername}`);
    localStorage.removeItem(`poison_${loggedInUsername}`);
    localStorage.removeItem(`finances_${loggedInUsername}`);
    localStorage.removeItem

    registeredUsers = registeredUsers.filter(u => u.username !== loggedInUsername);
    saveRegisteredUsers();
    handleLogout();
}

function openChangeProfileModal() {
    document.getElementById('change-profile-form').reset();
    document.getElementById('new-username').value = loggedInUsername;
    document.getElementById('profile-error-message').textContent = ''; 
    document.getElementById('profile-error-message').style.display = 'none'; 
    closeModal('custom-dialog');
    openModal('change-profile-modal');
}

async function handleChangeProfile(e) {
    e.preventDefault();
    const newUsername = document.getElementById('new-username').value.trim();
    const currentPassword = document.getElementById('current-password').value.trim();
    const newPassword = document.getElementById('new-password').value.trim(); 
    const errorMessageEl = document.getElementById('profile-error-message'); 
    
    errorMessageEl.style.display = 'none'; 
    
    const userIndex = registeredUsers.findIndex(u => u.username === loggedInUsername);
    if (userIndex === -1) { showCustomDialog('Error', 'Sesi login tidak valid.'); return; }
    const currentUser = registeredUsers[userIndex];
    
    if (currentUser.password !== currentPassword) {
         errorMessageEl.textContent = 'Password Saat Ini salah.';
         errorMessageEl.style.display = 'block';
         return; 
    }
    
    if (newUsername !== loggedInUsername && registeredUsers.some((u, i) => u.username === newUsername && i !== userIndex)) {
        showCustomDialog('Error', `Username **${newUsername}** sudah digunakan.`);
        return;
    }

    const oldUsername = loggedInUsername;
    currentUser.username = newUsername;
    if (newPassword) { currentUser.password = newPassword; }
    
    registeredUsers[userIndex] = currentUser;
    await saveRegisteredUsers();
    
    if (newUsername !== oldUsername) {
        // Migrasi Data Akun di IDB
        const oldRecords = await dbHelper.get(`records_${oldUsername}`) || [];
        const oldGallery = await dbHelper.get(`gallery_${oldUsername}`) || [];
        const oldGardens = await dbHelper.get(`gardens_${oldUsername}`) || [];
        const oldReminders = await dbHelper.get(`reminders_${oldUsername}`) || [];
        const oldFertilizers = await dbHelper.get(`fertilizers_${oldUsername}`) || [];
        const oldPoison = await dbHelper.get(`poison_${oldUsername}`) || [];
        const oldMaps = await dbHelper.get(`maps_${oldUsername}`) || [];
        const oldAvatar = await dbHelper.get(`avatar_${oldUsername}`);

        // Set ke Key Baru
        await dbHelper.set(`records_${newUsername}`, oldRecords);
        await dbHelper.set(`gallery_${newUsername}`, oldGallery);
        await dbHelper.set(`gardens_${newUsername}`, oldGardens);
        await dbHelper.set(`reminders_${newUsername}`, oldReminders);
        await dbHelper.set(`poison_${newUsername}`, oldPoison);
        await dbHelper.set(`fertilizers_${newUsername}`, oldFertilizers);
        await dbHelper.set(`maps_${newUsername}`, oldMaps);
        if(oldAvatar) await dbHelper.set(`avatar_${newUsername}`, oldAvatar);
        
        // Hapus Key Lama
        await dbHelper.delete(`records_${oldUsername}`);
        await dbHelper.delete(`gallery_${oldUsername}`);
        await dbHelper.delete(`gardens_${oldUsername}`);
        await dbHelper.delete(`reminders_${oldUsername}`);
        await dbHelper.delete(`poison_${oldUsername}`);
        await dbHelper.delete(`fertilizers_${oldUsername}`);
        await dbHelper.delete(`maps_${oldUsername}`);
        await dbHelper.delete(`avatar_${oldUsername}`);
        
        loggedInUsername = newUsername;
        localStorage.setItem('loggedInUsername', newUsername);
        document.getElementById('header-username').textContent = `Halo, ${newUsername.charAt(0).toUpperCase() + newUsername.slice(1)}!`;
    }

    closeModal('change-profile-modal');
    showCustomDialog('Perubahan Berhasil', 'Profil Anda telah berhasil diperbarui.');
    toggleSettings(); 
}

async function exportData() {
    if (!loggedInUsername) {
        showCustomDialog('Error', 'Login diperlukan.');
        return;
    }
    
    showToast("Menyiapkan backup...");

    try {
        // Beri jeda sedikit agar UI tidak freeze saat memproses data besar
        await new Promise(resolve => setTimeout(resolve, 500));

        // Ambil avatar secara async sebelum membangun objek data
        const savedAvatar = await dbHelper.get(`avatar_${loggedInUsername}`);

        const data = {
            exportDate: new Date().toISOString(),
            appVersion: "2.6.0",
            username: loggedInUsername,
            
            // Mengambil data terbaru dari Global Variables (RAM)
            records: records,
            galleryPhotos: galleryPhotos,
            gardens: gardens,
            fertilizers: fertilizers, // Sudah termasuk status isArchived
            poison: poison,           // Sudah termasuk status isArchived
            maps: maps,
            finances: finances,
            reminders: reminders,
            avatar: savedAvatar || avatar 
        };

        // Konversi objek ke string JSON yang rapi
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        // Proses download otomatis
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `Backup_GreenLog_${loggedInUsername}_${timestamp}.json`;
        
        document.body.appendChild(a);
        a.click();
        
        // Cleanup memory
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);

        // Hapus semua toast loading dan tampilkan sukses
        document.querySelectorAll('.app-toast').forEach(t => t.remove());
        showCustomDialog('Export Berhasil', 'File backup JSON berhasil dibuat dan diunduh.');
        
    } catch (e) {
        console.error("Export Error:", e);
        document.querySelectorAll('.app-toast').forEach(t => t.remove());
        showCustomDialog('Export Gagal', 'Terjadi kesalahan saat menyiapkan file backup.');
    }
}


function checkDarkMode() {
    const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        const switchElement = document.getElementById('mode-toggle-switch');
        if(switchElement) switchElement.checked = true;
    } else {
        document.body.classList.remove('dark-mode');
        const switchElement = document.getElementById('mode-toggle-switch');
        if(switchElement) switchElement.checked = false;
    }
}

// --- UTILS ---
function highlightText(text, keyword) {
    if (!keyword || keyword.length === 0) return text;
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
    const regex = new RegExp(`(${escapedKeyword})`, 'gi');
    const highlightColor = document.body.classList.contains('dark-mode') ? 'rgba(48, 209, 88, 0.5)' : 'rgba(52, 199, 89, 0.3)';
    return text.replace(regex, `<span style="background-color: ${highlightColor}; border-radius: 2px;">$1</span>`);
}

function calculateAge(startDateString) {
    if (!startDateString) { return 'N/A'; }
    const start = new Date(startDateString);
    const today = new Date();
    start.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    if (start > today) { return 'Belum Mulai'; }

    let years = today.getFullYear() - start.getFullYear();
    let months = today.getMonth() - start.getMonth();
    let days = today.getDate() - start.getDate();

    if (days < 0) { months--; const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0).getDate(); days += prevMonth; }
    if (months < 0) { years--; months += 12; }
    const yearStr = years > 0 ? `${years} Thn` : '';
    const monthStr = months > 0 ? `${months} Bln` : '';
    const dayStr = days > 0 ? `${days} Hr` : '';

    return `${yearStr} ${monthStr} ${dayStr}`.trim() || 'Hari Ini';
}

function formatDateTime(isoString) {
     if (!isoString) return 'N/A';
     const date = new Date(isoString);
     return date.toLocaleDateString('id-ID', {
         year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
     });
}

function getReminderStatus(dateDueISO) {
    if (!dateDueISO) return { text: 'N/A', color: 'var(--secondary-text-color)' };
    const today = new Date();
    const dueDate = new Date(dateDueISO);
    today.setHours(0, 0, 0, 0); 
    dueDate.setHours(0, 0, 0, 0);
    const diffTime = dueDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return { text: 'üö® HARI INI!', color: 'var(--accent-red)' };
    else if (diffDays < 0) return { text: `üö® TERLAMBAT ${Math.abs(diffDays)} Hari!`, color: 'var(--accent-red)' };
    else if (diffDays === 1) return { text: 'Besok', color: 'var(--accent-green)' };
    else return { text: `${diffDays} Hari Lagi`, color: 'var(--primary-color)' };
}

function getRecordIcon(type) {
    switch(type) {
        case 'Perawatan': return 'üí¶'; case 'Pemupukan': return 'üß™'; case 'Panen': return 'üçé';
        case 'Penyemprotan': return 'üí®'; case 'Pruning': return '‚úÇÔ∏è'; case 'Kastrasi': return '‚ùå'; default: return 'üìù';
    }
}

function toggleSawitFields() {
    const activityType = document.getElementById('sawit-activity-type').value;
    const sprayingFields = document.getElementById('spraying-fields');
    const targetSelect = document.getElementById('spraying-target');
    const treeSelectUI = document.getElementById('tree-selection-ui'); // Elemen baru
    
    // Reset tampilan
    if (sprayingFields) sprayingFields.style.display = 'none';
    if (targetSelect) targetSelect.required = false;
    if (treeSelectUI) treeSelectUI.style.display = 'none';

    if (activityType === 'Penyemprotan') { 
        if (sprayingFields) sprayingFields.style.display = 'block'; 
        if (targetSelect) targetSelect.required = true; 
    } 
    else if (activityType === 'Kastrasi') {
        // Tampilkan tombol pilih pohon jika Kastrasi
        if (treeSelectUI) treeSelectUI.style.display = 'block';
    }
}


function toggleFormFields(type) {
    const plantNameInput = document.getElementById('plant-name').value.toLowerCase();
    const isSawit = plantNameInput.includes('sawit') || plantNameInput.includes('kelapa sawit'); 
    
    // Sembunyikan semua dulu
    document.getElementById('perawatan-fields').style.display = 'none';
    document.getElementById('pemupukan-fields').style.display = 'none';
    document.getElementById('panen-fields').style.display = 'none';
    document.getElementById('sawit-fields').style.display = 'none';
    document.getElementById('sawit-activity-type').value = '';

    // --- LOGIKA BARU ---
    // Jika tipe adalah Penyemprotan (Universal) ATAU (Tipe khusus sawit DAN memang tanaman sawit)
    if (type === 'Penyemprotan' || (isSawit && ['Pruning', 'Kastrasi'].includes(type))) {
        document.getElementById('sawit-fields').style.display = 'block';
        document.getElementById('sawit-activity-type').value = type;
        
        // Ubah label agar tidak bingung jika bukan sawit
        const labelKegiatan = document.querySelector('label[for="sawit-activity-type"]');
        if(labelKegiatan) labelKegiatan.innerHTML = type === 'Penyemprotan' ? 'Detail Aplikasi' : 'Jenis Kegiatan Sawit <span style="color: var(--accent-red);">*</span>';

        toggleSawitFields();
    } else {
        // Logika standar lainnya
        if (type === 'Perawatan') document.getElementById('perawatan-fields').style.display = 'block';
        else if (type === 'Pemupukan') document.getElementById('pemupukan-fields').style.display = 'block';
        else if (type === 'Panen') document.getElementById('panen-fields').style.display = 'block';
        toggleSawitFields(); 
    }
    
    // Atur field yang wajib diisi (Required)
    const requiredFields = {
        'Perawatan': [], 
        'Pemupukan': ['pupuk-id-select', 'pupuk-dose', 'pupuk-quantity'],
        'Panen': ['harvest-quantity'], 
        'Penyemprotan': ['sawit-activity-type'], // Penyemprotan butuh ini
        'Pruning': ['sawit-activity-type'], 
        'Kastrasi': ['sawit-activity-type']
    };
    
    // Reset required attributes
    document.querySelectorAll('#record-form [required]').forEach(el => {
         if (el.id !== 'plant-name' && el.id !== 'record-date') el.required = false;
    });

    // Set required attributes baru
    if (requiredFields[type]) {
        requiredFields[type].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.required = true;
        });
    }
    
    // Validasi tambahan khusus penyemprotan
    if (type === 'Penyemprotan') {
         const currentActivity = document.getElementById('sawit-activity-type').value;
         const targetSelect = document.getElementById('spraying-target');
         if(currentActivity === 'Penyemprotan' && targetSelect) targetSelect.required = true;
    }
}


function calculatePupukTotal() {
    const dose = parseFloat(document.getElementById('pupuk-dose').value) || 0;
    const quantity = parseInt(document.getElementById('pupuk-quantity').value) || 0;
    const total_g = dose * quantity; 
    const total_kg = total_g / 1000;
    document.getElementById('pupuk-total-display').value = parseFloat(total_kg.toFixed(3)).toString() + ' kg';
    document.getElementById('pupuk-total-value').value = total_g;
}

function formatCostInput(inputElement, hiddenId) {
    let cleanValue = inputElement.value.replace(/[^0-9]/g, ''); 
    if (!cleanValue) { document.getElementById(hiddenId).value = 0; inputElement.value = ''; return; }
    const numberValue = parseInt(cleanValue, 10);
    document.getElementById(hiddenId).value = numberValue;
    inputElement.value = numberValue.toLocaleString('id-ID');
}

// --- CRUD GARDEN LOGIC ---
function openGardenModal(id) {
    document.getElementById('garden-form').reset();
    document.getElementById('garden-id').value = '';
    document.getElementById('garden-modal-title').textContent = 'Tambah Kebun Baru';
    document.getElementById('garden-date-tanam').value = ''; 

    if (id) {
        const garden = gardens.find(g => g.id === id);
        if (!garden) return;
        document.getElementById('garden-modal-title').textContent = `Edit Kebun: ${garden.title}`;
        document.getElementById('garden-id').value = garden.id;
        document.getElementById('garden-title').value = garden.title;
        document.getElementById('garden-date-tanam').value = garden.dateTanam || ''; 
        document.getElementById('garden-plant-count').value = garden.plantCount;
        document.getElementById('garden-varieties').value = garden.varieties;
        document.getElementById('garden-area').value = garden.area;
    }
    openModal('garden-modal');
}

function handleGardenSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('garden-id').value || Date.now().toString();
    const title = document.getElementById('garden-title').value.trim();
    const dateTanam = document.getElementById('garden-date-tanam').value.trim(); 
    const plantCount = parseInt(document.getElementById('garden-plant-count').value) || 0;
    const varieties = document.getElementById('garden-varieties').value.trim();
    const area = parseFloat(document.getElementById('garden-area').value) || 0;

    if (!title) { showCustomDialog('Error', 'Judul Kebun wajib diisi.'); return; }
    
    const newGarden = { id, title, dateTanam, plantCount, varieties, area }; 
    const existingIndex = gardens.findIndex(g => g.id === id);
    if (existingIndex > -1) {
        gardens[existingIndex] = newGarden;
        showCustomDialog('Berhasil', 'Data kebun berhasil diperbarui!');
    } else {
        gardens.unshift(newGarden); 
        showCustomDialog('Berhasil', 'Kebun baru berhasil disimpan!');
    }
    saveGardens();
    closeModal('garden-modal');
    if (currentRecordType === 'Daftar Kebun') renderContent('Daftar Kebun');
}

function deleteGarden(id) {
    const garden = gardens.find(g => g.id === id);
    if (!garden) return;
    const confirmDelete = () => {
        gardens = gardens.filter(g => g.id !== id);
        records = records.filter(r => r.gardenIdReference !== id);
        reminders = reminders.filter(r => r.gardenIdReference !== id);
        saveGardens(); saveRecords(); saveReminders();
        renderContent('Daftar Kebun');
        showCustomDialog('Berhasil Dihapus', `Kebun **${garden.title}** telah dihapus beserta catatan terkait.`);
    };
    showConfirmDialog('Hapus Kebun', `Yakin ingin menghapus kebun **${garden.title}**?`, confirmDelete, null, 'danger');
}

// --- LOGIKA HELPER RACUN (NEW) ---

function populatePoisonDropdown(forceIncludeId = null) {
    const select = document.getElementById('poison-id-select');
    if (!select) return;

    select.innerHTML = '<option value="">-- Pilih Racun --</option>';
    
    // Urutkan: Stok terbanyak di atas
    const sortedPoison = [...poison].sort((a, b) => b.currentWeight - a.currentWeight);

    sortedPoison.forEach(p => {
        const isAvailable = (p.currentWeight > 0 && !p.isArchived);
        const isTheOneBeingEdited = (forceIncludeId && p.id === forceIncludeId);

        if (isAvailable || isTheOneBeingEdited) {
            const opt = document.createElement('option');
            opt.value = p.id;
            
            let stockLabel = `(Sisa: ${p.currentWeight} liter/kg)`;
            if (p.currentWeight <= 0) stockLabel = `(HABIS - ${p.currentWeight})`;
            if (p.isArchived) stockLabel += ` [Arsip]`;

            opt.textContent = `${p.name} ${stockLabel}`;
            select.appendChild(opt);
        }
    });
    
    const manualOpt = document.createElement('option');
    manualOpt.value = "MANUAL";
    manualOpt.textContent = "Lainnya / Manual";
    select.appendChild(manualOpt);
}

function updatePoisonInfo() {
    const id = document.getElementById('poison-id-select').value;
    const info = document.getElementById('poison-stock-info');
    const manualInput = document.getElementById('poison-manual-name');
    
    if (id === "MANUAL") {
        info.style.display = 'none';
        manualInput.style.display = 'block';
        manualInput.required = true;
    } else if (id) {
        const p = poison.find(x => x.id === id);
        if (p) {
            info.textContent = `Stok tersedia: ${p.currentWeight} Liter`;
            info.style.display = 'block';
        }
        manualInput.style.display = 'none';
        manualInput.required = false;
    } else {
        info.style.display = 'none';
        manualInput.style.display = 'none';
        manualInput.required = false;
    }
}

function calculatePoisonTotal() {
    // Asumsi: Dosis dalam ML, Total dikonversi ke LITER
    const dose = parseFloat(document.getElementById('poison-dose').value) || 0;
    const qty = parseFloat(document.getElementById('poison-quantity').value) || 0;
    
    const totalMl = dose * qty;
    const totalLiter = totalMl / 1000;
    
    document.getElementById('poison-total-display').value = totalLiter.toFixed(3) + ' Liter';
    document.getElementById('poison-total-value').value = totalLiter; // Nilai murni float
}


// --- LOGIKA STOK Racun (BARU) ---
function openPoisonModal(id) {
    document.getElementById('poison-inventory-form').reset();
    document.getElementById('poison-inv-id').value = '';
    document.getElementById('poison-inv-price').value = '0';
    document.getElementById('poison-modal-title').textContent = 'Tambah Stok Racun';
    
    if (id) {
        const p = poison.find(x => x.id === id);
        if (p) {
            document.getElementById('poison-inv-id').value = p.id;
            document.getElementById('poison-modal-title').textContent = `Edit Stok: ${p.name}`;
            document.getElementById('poison-inv-name').value = p.name;
            document.getElementById('poison-inv-date').value = p.dateBuy || '';
            document.getElementById('poison-inv-weight').value = p.currentWeight;
            document.getElementById('poison-inv-price').value = p.price || 0;
            document.getElementById('poison-inv-price-display').value = p.price ? parseInt(p.price).toLocaleString('id-ID') : '';
        }
    }
    openModal('poison-inventory-modal');
}

function handlePoisonSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('poison-inv-id').value || Date.now().toString();
    const name = document.getElementById('poison-inv-name').value.trim();
    const dateBuy = document.getElementById('poison-inv-date').value;
    const price = parseInt(document.getElementById('poison-inv-price').value) || 0;
    const weight = parseFloat(document.getElementById('poison-inv-weight').value) || 0;

    if (!name || weight < 0) { showCustomDialog('Error', 'Nama dan Berat Racun valid wajib diisi.'); return; }
    
    const newFert = { id, name, dateBuy, price, currentWeight: weight, initialWeight: weight };
    
    const existingIndex = poison.findIndex(p=> p.id === id);
    if (existingIndex > -1) {
        newFert.initialWeight = poison[existingIndex].initialWeight; 
        poison[existingIndex] = newFert;
    } else {
        poison.unshift(newFert);
    }
    
    savePoison();
    closeModal('poison-inventory-modal');
    renderPoisonList();
    showCustomDialog('Berhasil', 'Data stok Racun tersimpan.');
}

function deletePoison(id) {
    const p = poison.find(x => x.id === id);
    if (!p) return;
    showConfirmDialog('Hapus Stok', `Hapus **${p.name}** dari gudang?`, () => {
        poison = poison.filter(x => x.id !== id);
        savePoison();
        renderPoisonList();
    }, null, 'danger');
}

// ** NEW: DETAIL Racun **
function showPoisonDetail(id) {
    const p = poison.find(x => x.id === id);
    if (!p) return;
    
    const content = document.getElementById('preview-content');
    const detailContainer = document.getElementById('garden-detail-content');
    
    detailContainer.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('preview-title').textContent = "Detail Stok Racun";
    
    const price = p.price ? `Rp ${parseInt(p.price).toLocaleString('id-ID')}` : '-';
    const date = p.dateBuy ? p.dateBuy : '-';

    content.innerHTML = `
        <div class="detail-group">
            <div class="detail-row"><span class="detail-label">Nama Racun</span><span class="detail-value">${p.name}</span></div>
            <div class="detail-row"><span class="detail-label">Stok Saat Ini</span><span class="detail-value" style="font-weight:bold;color:${p.currentWeight<5?'var(--accent-red)':'var(--accent-green)'}">${p.currentWeight} liter</span></div>
            <div class="detail-row"><span class="detail-label">Stok Awal</span><span class="detail-value">${p.initialWeight || p.currentWeight} Liter</span></div>
            <div class="detail-row"><span class="detail-label">Tanggal Beli</span><span class="detail-value">${date}</span></div>
            <div class="detail-row"><span class="detail-label">Harga Beli</span><span class="detail-value">${price}</span></div>
        </div>
        <div class="form-actions">
            <button class="primary-action" onclick="openPoisonModal('${p.id}'); closeModal('preview-modal');">‚úèÔ∏è Edit Stok</button>
            <button class="danger-btn" onclick="deletePoison('${p.id}'); closeModal('preview-modal');">üóëÔ∏è Hapus Stok</button>
            <button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button>
        </div>
    `;
    openModal('preview-modal');
}

function renderPoisonList(showArchived = false) {
    const container = document.getElementById('poison-cards-container');
    
    const headerHtml = `
        <div style="display:flex; gap:10px; margin-bottom:15px; padding:0 5px;">
            <button onclick="renderPoisonList(false)" 
                class="ios-chip ${!showArchived ? 'active' : ''}" 
                style="flex:1; text-align:center; color: ${!showArchived ? '#fff' : 'var(--text-color)'};">
                üì¶ Stok Aktif
            </button>
            <button onclick="renderPoisonList(true)" 
                class="ios-chip ${showArchived ? 'active' : ''}" 
                style="flex:1; text-align:center; color: ${showArchived ? '#fff' : 'var(--text-color)'};">
                üóÑÔ∏è Arsip
            </button>
        </div>
    `;
    
    const filteredList = poison.filter(p => showArchived ? p.isArchived : !p.isArchived);
    container.innerHTML = headerHtml; 
    
    if (filteredList.length === 0) {
        container.innerHTML += `<p style="text-align: center; margin-top: 30px; color: var(--secondary-text-color);">Data kosong.</p>`;
        return;
    }

    filteredList.forEach(p => {
        const card = document.createElement('div');
        card.className = 'record-card';
        if (p.currentWeight <= 0) card.style.opacity = "0.7"; 
        card.onclick = () => showPoisonDetail(p.id); 
        
        card.innerHTML = `
            <div style="flex:1;">
                <h3 style="margin: 0; font-size: 18px; ${p.currentWeight <= 0 ? 'text-decoration:line-through;' : ''}">üß™ ${p.name}</h3>
                <p style="margin: 5px 0 0; font-size: 13px; color: var(--secondary-text-color);">Stok: <span style="font-weight:600; color:${p.currentWeight <= 0 ? 'red' : 'var(--accent-green)'}">${p.currentWeight} liter</span></p>
            </div>
            <div style="text-align: right;">
                 <button onclick="event.stopPropagation(); toggleArchivePoison('${p.id}')" style="background:var(--secondary-bg); color:var(--text-color); border:1px solid var(--border-color); padding:5px 10px; border-radius:8px; font-size:11px; cursor:pointer;">
                    ${showArchived ? '‚¨ÜÔ∏è Pulihkan' : 'üìÇ Arsip'}
                 </button>
            </div>
        `;
        container.appendChild(card);
    });
}


// --- LOGIKA STOK PUPUK (BARU) ---
function openFertilizerModal(id) {
    document.getElementById('fertilizer-inventory-form').reset();
    document.getElementById('fertilizer-inv-id').value = '';
    document.getElementById('fertilizer-inv-price').value = '0';
    document.getElementById('fertilizer-modal-title').textContent = 'Tambah Stok Pupuk';
    
    if (id) {
        const f = fertilizers.find(x => x.id === id);
        if (f) {
            document.getElementById('fertilizer-inv-id').value = f.id;
            document.getElementById('fertilizer-modal-title').textContent = `Edit Stok: ${f.name}`;
            document.getElementById('fertilizer-inv-name').value = f.name;
            document.getElementById('fertilizer-inv-date').value = f.dateBuy || '';
            document.getElementById('fertilizer-inv-weight').value = f.currentWeight;
            document.getElementById('fertilizer-inv-price').value = f.price || 0;
            document.getElementById('fertilizer-inv-price-display').value = f.price ? parseInt(f.price).toLocaleString('id-ID') : '';
        }
    }
    openModal('fertilizer-inventory-modal');
}

function handleFertilizerSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('fertilizer-inv-id').value || Date.now().toString();
    const name = document.getElementById('fertilizer-inv-name').value.trim();
    const dateBuy = document.getElementById('fertilizer-inv-date').value;
    const price = parseInt(document.getElementById('fertilizer-inv-price').value) || 0;
    const weight = parseFloat(document.getElementById('fertilizer-inv-weight').value) || 0;

    if (!name || weight < 0) { showCustomDialog('Error', 'Nama dan Berat Pupuk valid wajib diisi.'); return; }
    
    const newFert = { id, name, dateBuy, price, currentWeight: weight, initialWeight: weight };
    
    const existingIndex = fertilizers.findIndex(f => f.id === id);
    if (existingIndex > -1) {
        newFert.initialWeight = fertilizers[existingIndex].initialWeight; 
        fertilizers[existingIndex] = newFert;
    } else {
        fertilizers.unshift(newFert);
    }
    
    saveFertilizers();
    closeModal('fertilizer-inventory-modal');
    renderFertilizerList();
    showCustomDialog('Berhasil', 'Data stok pupuk tersimpan.');
}

function deleteFertilizer(id) {
    const f = fertilizers.find(x => x.id === id);
    if (!f) return;
    showConfirmDialog('Hapus Stok', `Hapus **${f.name}** dari gudang?`, () => {
        fertilizers = fertilizers.filter(x => x.id !== id);
        saveFertilizers();
        renderFertilizerList();
    }, null, 'danger');
}

// ** NEW: DETAIL PUPUK **
function showFertilizerDetail(id) {
    const f = fertilizers.find(x => x.id === id);
    if (!f) return;
    
    const content = document.getElementById('preview-content');
    const detailContainer = document.getElementById('garden-detail-content');
    
    detailContainer.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('preview-title').textContent = "Detail Stok Pupuk";
    
    const price = f.price ? `Rp ${parseInt(f.price).toLocaleString('id-ID')}` : '-';
    const date = f.dateBuy ? f.dateBuy : '-';
    
    const archiveBtnText = f.isArchived ? '‚¨ÜÔ∏è Kembalikan ke Stok Aktif' : 'üìÇ Arsipkan (Sembunyikan)';
    const archiveBtnClass = 'secondary-action';

    content.innerHTML = `
        <div class="detail-group">
            <div class="detail-row"><span class="detail-label">Nama Pupuk</span><span class="detail-value">${f.name}</span></div>
            <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value">${f.isArchived ? 'üóÑÔ∏è Diarsipkan' : '‚úÖ Aktif'}</span></div>
            <div class="detail-row"><span class="detail-label">Stok Saat Ini</span><span class="detail-value" style="font-weight:bold;color:${f.currentWeight<=0?'gray':(f.currentWeight<5?'var(--accent-red)':'var(--accent-green)')}">${f.currentWeight} kg</span></div>
            <div class="detail-row"><span class="detail-label">Stok Awal</span><span class="detail-value">${f.initialWeight || f.currentWeight} kg</span></div>
            <div class="detail-row"><span class="detail-label">Tanggal Beli</span><span class="detail-value">${date}</span></div>
            <div class="detail-row"><span class="detail-label">Harga Beli</span><span class="detail-value">${price}</span></div>
        </div>
        <div class="form-actions">
            <button class="primary-action" onclick="openFertilizerModal('${f.id}'); closeModal('preview-modal');">‚úèÔ∏è Edit Stok</button>
            <button class="${archiveBtnClass}" onclick="toggleArchiveFertilizer('${f.id}'); closeModal('preview-modal');">${archiveBtnText}</button>
            <button class="danger-btn" onclick="deleteFertilizer('${f.id}'); closeModal('preview-modal');">üóëÔ∏è Hapus Permanen</button>
            <button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button>
        </div>
    `;
    openModal('preview-modal');
}

function renderFertilizerList(showArchived = false) {
    const container = document.getElementById('fertilizer-cards-container');
    
    // Header dengan Tombol Filter yang Warnanya Adaptif
    const headerHtml = `
        <div style="display:flex; gap:10px; margin-bottom:15px; padding:0 5px;">
            <button id="view-active-btn" onclick="renderFertilizerList(false)" 
                class="ios-chip ${!showArchived ? 'active' : ''}" 
                style="flex:1; text-align:center; color: ${!showArchived ? '#fff' : 'var(--text-color)'};">
                üì¶ Stok Aktif
            </button>
            
            <button id="view-archived-btn" onclick="renderFertilizerList(true)" 
                class="ios-chip ${showArchived ? 'active' : ''}" 
                style="flex:1; text-align:center; color: ${showArchived ? '#fff' : 'var(--text-color)'};">
                üóÑÔ∏è Arsip
            </button>
        </div>
    `;
    
    // Filter data sesuai tombol
    const filteredList = fertilizers.filter(f => showArchived ? f.isArchived : !f.isArchived);

    container.innerHTML = headerHtml; 
    
    if (filteredList.length === 0) {
        const emptyMsg = showArchived ? 'Tidak ada pupuk yang diarsipkan.' : 'Stok pupuk kosong.';
        container.innerHTML += `<p style="text-align: center; margin-top: 30px; color: var(--secondary-text-color);">${emptyMsg}</p>`;
        return;
    }

    filteredList.forEach(f => {
        const card = document.createElement('div');
        card.className = 'record-card';
        if (f.currentWeight <= 0) card.style.opacity = "0.7"; 

        card.onclick = () => showFertilizerDetail(f.id); 
        
        const priceDisplay = f.price ? `Rp ${parseInt(f.price).toLocaleString('id-ID')}` : '-';
        let stockColor = 'var(--accent-green)';
        let stockText = `${f.currentWeight} kg`;

        if (f.currentWeight <= 0) {
            stockColor = 'var(--secondary-text-color)';
            stockText = "HABIS (0 kg)";
        } else if (f.currentWeight < 5) {
            stockColor = 'var(--accent-red)';
        }
        
        card.innerHTML = `
            <div style="flex:1;">
                <h3 style="margin: 0; font-size: 18px; ${f.currentWeight <= 0 ? 'text-decoration:line-through; color:gray;' : ''}">üõçÔ∏è ${f.name}</h3>
                <p style="margin: 5px 0 0; font-size: 14px; color: var(--secondary-text-color);">Beli: ${f.dateBuy || '-'}</p>
                <p style="margin: 2px 0 0; font-size: 14px; font-weight: 600; color: ${stockColor};">Stok: ${stockText}</p>
            </div>
            <div style="text-align: right; display:flex; flex-direction:column; align-items:flex-end; justify-content:space-between;">
                 <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">${priceDisplay}</div>
                 
                 <button onclick="event.stopPropagation(); toggleArchiveFertilizer('${f.id}')" style="background:var(--secondary-bg); color:var(--text-color); border:1px solid var(--border-color); padding:4px 8px; border-radius:8px; font-size:10px; cursor:pointer;">
                    ${showArchived ? '‚¨ÜÔ∏è Pulihkan' : 'üìÇ Arsip'}
                 </button>
            </div>
        `;
        container.appendChild(card);
    });
}


// --- CRUD RECORD LOGIC (FIXED) ---
async function handleFormSubmit(e) {
    e.preventDefault();
    
    try {
        const id = document.getElementById('record-id').value || Date.now().toString();
        const type = document.getElementById('record-type').value;
        const plantName = document.getElementById('plant-name').value;
        const date = document.getElementById('record-date').value;
        const gardenIdReference = document.getElementById('garden-id-reference').value; 
        
        if (!plantName || !date) { 
            throw new Error('Nama Tanaman dan Tanggal wajib diisi.'); 
        }
        
        let newRecord = { id, type, plantName, date, gardenIdReference }; 
        
        // Cari record lama (jika sedang edit) untuk keperluan logika stok
        const existingRecord = records.find(r => r.id === id);
        
        // Preserve Pin State if editing
        if (existingRecord && existingRecord.isPinned) {
            newRecord.isPinned = true;
        }

        let stockReduced = false; // Flag untuk menandai apakah perlu saveFertilizers()
        
        if (type === 'Perawatan') {
            const photoFile = document.getElementById('perawatan-photo-file').files[0];
            const photoUrlInput = document.getElementById('perawatan-photo-url').value;
            let photoUrl = photoUrlInput;
            if (photoFile) {
                 photoUrl = await new Promise((resolve, reject) => { 
                    const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(photoFile); 
                });
            }
            newRecord = { ...newRecord, notes: document.getElementById('perawatan-notes').value, photoUrl };

        } else if (type === 'Pemupukan') {
            // === PERBAIKAN LOGIKA STOK PEMUPUKAN (FIXED) ===
            const mode = document.getElementById('pupuk-input-mode').value;
            // totalUsedVal didapat dari input hidden yang sudah dihitung oleh calculatePupukTotal() atau syncQuickTotal()
            // Nilai ini dalam satuan KG (bukan gram)
            const totalUsedVal = parseFloat(document.getElementById('pupuk-total-value').value); 
            const costValue = parseInt(document.getElementById('pupuk-cost').value) || 0; 
            const fertilizerId = document.getElementById('pupuk-id-select').value;
            
            if (isNaN(totalUsedVal) || totalUsedVal <= 0) throw new Error("Total penggunaan pupuk tidak valid.");

            let pupukName = "";
            let newFertilizerInventoryId = null;
            
            // 1. Tentukan Nama Pupuk & ID Inventory Baru
            if (fertilizerId === "MANUAL") {
                pupukName = document.getElementById('pupuk-manual-name').value;
                if (!pupukName) throw new Error("Nama pupuk manual wajib diisi.");
                newFertilizerInventoryId = null;
            } else if (fertilizerId) {
                const fIndex = fertilizers.findIndex(f => f.id === fertilizerId);
                if (fIndex > -1) {
                    pupukName = fertilizers[fIndex].name;
                    newFertilizerInventoryId = fertilizerId;
                }
            }

            // 2. LOGIKA STOK: Refund Dulu, Baru Potong (Supaya Edit Aman)
            
            // A. Jika EDIT: Kembalikan (Refund) stok lama ke gudang dulu
            if (existingRecord && existingRecord.fertilizerInventoryId && existingRecord.usedAmountKg) {
                const oldFertIndex = fertilizers.findIndex(f => f.id === existingRecord.fertilizerInventoryId);
                if (oldFertIndex > -1) {
                    // Kembalikan stok lama
                    fertilizers[oldFertIndex].currentWeight = parseFloat((fertilizers[oldFertIndex].currentWeight + existingRecord.usedAmountKg).toFixed(3));
                    stockReduced = true; // Tandai ada perubahan stok
                }
            }

            // B. Potong Stok Baru (Berlaku untuk EDIT maupun BARU)
            if (newFertilizerInventoryId) {
                const newFertIndex = fertilizers.findIndex(f => f.id === newFertilizerInventoryId);
                if (newFertIndex > -1) {
                    // Cek apakah stok cukup (Opsional, tapi bagus untuk validasi)
                    // if (fertilizers[newFertIndex].currentWeight < totalUsedVal) { ... }

                    // Kurangi stok sesuai inputan form saat ini
                    fertilizers[newFertIndex].currentWeight = parseFloat((fertilizers[newFertIndex].currentWeight - totalUsedVal).toFixed(3));
                    stockReduced = true; 
                }
            }
            // ================================================

            const reminderDate = document.getElementById('pupuk-reminder-date').value;
            const reminderTime = document.getElementById('pupuk-reminder-time').value;
            let reminderDueDateISO = '';
            if (reminderDate) {
                const dateTimeString = `${reminderDate}T${reminderTime || '10:00'}:00`;
                const dateObj = new Date(dateTimeString);
                if (!isNaN(dateObj)) reminderDueDateISO = dateObj.toISOString();
            }

            // Ambil data dosis & qty hanya jika di mode detail, jika quick set ke 0
            const finalDose = mode === 'detail' ? parseFloat(document.getElementById('pupuk-dose').value) : 0;
            const finalQty = mode === 'detail' ? parseInt(document.getElementById('pupuk-quantity').value) : 0;

            newRecord = { 
                ...newRecord, 
                pupukType: pupukName, 
                fertilizerInventoryId: newFertilizerInventoryId, // ID Inventory Baru
                usedAmountKg: totalUsedVal, // Ini kunci untuk perhitungan stok berikutnya
                totalUsed: totalUsedVal * 1000, // Simpan dalam gram buat cadangan
                dose: finalDose || 0, 
                quantity: finalQty || 0, 
                cost: costValue, 
                notes: document.getElementById('pupuk-notes').value, 
                reminderDueDateISO,
                inputMode: mode 
            };

            
        } else if (type === 'Panen') {
             const quantity = parseFloat(document.getElementById('harvest-quantity').value);
             newRecord = { ...newRecord, quantity, notes: document.getElementById('harvest-notes').value };

} else if (['Penyemprotan', 'Pruning', 'Kastrasi'].includes(type)) { 
     const activityType = document.getElementById('sawit-activity-type').value;
     let sawitDetails = {};
     let notesVal = document.getElementById('sawit-notes').value;
     
     // --- TAMBAHAN BARU: AMBIL TREE IDS ---
     let selectedTreeIds = [];
     if (activityType === 'Kastrasi') {
         const rawIds = document.getElementById('selected-tree-ids').value;
         try {
             selectedTreeIds = rawIds ? JSON.parse(rawIds) : [];
         } catch(e) { selectedTreeIds = []; }
     }

             // === LOGIKA BARU PENYEMPROTAN ===
             if (activityType === 'Penyemprotan') {
                  const poisonId = document.getElementById('poison-id-select').value;
                  const totalUsedLiter = parseFloat(document.getElementById('poison-total-value').value) || 0;
                  const costValue = parseInt(document.getElementById('poison-cost').value) || 0;
                  
                  let poisonName = "";
                  let poisonInventoryId = null;

                  if (poisonId === "MANUAL") {
                      poisonName = document.getElementById('poison-manual-name').value;
                      if (!poisonName) throw new Error("Nama Racun manual wajib diisi.");
                  } else if (poisonId) {
                      const pIndex = poison.findIndex(p => p.id === poisonId);
                      if (pIndex > -1) {
                          poisonName = poison[pIndex].name;
                          poisonInventoryId = poisonId;
                      }
                  }

                  // === LOGIKA EDIT STOK RACUN (MIRIP PUPUK) ===
                  // 1. Refund Stok Lama Jika Edit
                  if (existingRecord && existingRecord.sawitDetails && existingRecord.sawitDetails.poisonInventoryId && existingRecord.sawitDetails.totalUsedLiter) {
                      const oldPoisonIndex = poison.findIndex(p => p.id === existingRecord.sawitDetails.poisonInventoryId);
                      if (oldPoisonIndex > -1) {
                          poison[oldPoisonIndex].currentWeight = parseFloat((poison[oldPoisonIndex].currentWeight + existingRecord.sawitDetails.totalUsedLiter).toFixed(3));
                          sawitStockReduced = true;
                      }
                  }

                  // 2. Potong Stok Baru
                  if (poisonInventoryId) {
                       const newPoisonIndex = poison.findIndex(p => p.id === poisonInventoryId);
                       if (newPoisonIndex > -1) {
                           poison[newPoisonIndex].currentWeight = parseFloat((poison[newPoisonIndex].currentWeight - totalUsedLiter).toFixed(3));
                           sawitStockReduced = true;
                       }
                  }

                  sawitDetails = { 
                      target: document.getElementById('spraying-target').value, 
                      poisonType: poisonName,
                      poisonName: poisonName, 
                      poisonInventoryId: poisonInventoryId, 
                      dose: parseFloat(document.getElementById('poison-dose').value) || 0,
                      quantity: parseFloat(document.getElementById('poison-quantity').value) || 0,
                      totalUsedLiter: totalUsedLiter,
                      cost: costValue
                  };
                  
                  if (sawitStockReduced) savePoison(); // Simpan perubahan stok racun
             }
             // =================================

             newRecord = { 
         ...newRecord, 
         sawitActivity: activityType, 
         sawitDetails: sawitDetails,
         // SIMPAN DATA POHON KE RECORD
         selectedTreeIds: selectedTreeIds, 
         notes: notesVal,
         cost: sawitDetails.cost || 0 
     };
}

        // UPDATE ARRAY RECORDS
        const existingIndex = records.findIndex(r => r.id === id);
        if (existingIndex > -1) { 
            records[existingIndex] = newRecord; 
            showCustomDialog('Berhasil', 'Catatan berhasil diperbarui!'); 
        } else { 
            records.unshift(newRecord); 
            showCustomDialog('Berhasil', 'Catatan baru disimpan!'); 
        }
        
        // Update reminder
        reminders = reminders.filter(r => r.relatedRecordId !== newRecord.id); 
        if (type === 'Pemupukan' && newRecord.reminderDueDateISO) {
            const newReminder = { id: Date.now().toString(), type: 'Pemupukan', title: `Pemupukan: ${plantName}`, dateDue: newRecord.reminderDueDateISO, relatedRecordId: newRecord.id, plantName: plantName, gardenIdReference: gardenIdReference };
            reminders.unshift(newReminder);
        }
        
        // Simpan Data
        if (stockReduced) saveFertilizers(); // Simpan jika ada perubahan stok pupuk
        saveRecords(); 
        saveReminders(); 
        
        closeModal('record-modal'); 
        renderContent(currentRecordType);

    } catch (err) {
        console.error(err);
        showCustomDialog('Error', err.message || 'Gagal menyimpan catatan.');
    }
}

function editRecord(id) {
    const record = records.find(r => r.id === id);
    if (!record) return;
    
    document.getElementById('record-form').reset();
    document.getElementById('record-id').value = record.id;
    document.getElementById('plant-name').value = record.plantName;
    document.getElementById('record-date').value = record.date;
    document.getElementById('garden-id-reference').value = record.gardenIdReference || ''; 
    document.getElementById('plant-name').disabled = false;
    document.getElementById('perawatan-photo-file').value = ''; document.getElementById('perawatan-photo-url').value = ''; document.getElementById('photo-preview-perawatan').innerHTML = '';
    
    if (record.type === 'Perawatan') {
        document.getElementById('perawatan-notes').value = record.notes || '';
        if (record.photoUrl) { document.getElementById('perawatan-photo-url').value = record.photoUrl; updatePerawatanPhotoPreview(record.photoUrl, null, 'perawatan'); }
    } else if (record.type === 'Pemupukan') {
        const mode = record.inputMode || (record.dose > 0 ? 'detail' : 'quick');
        const modeSelect = document.getElementById('pupuk-input-mode');
        
        if (modeSelect) {
            modeSelect.value = mode;
            modeSelect.dispatchEvent(new Event('change'));
        }

        populateFertilizerDropdown(record.fertilizerInventoryId);
        
        const select = document.getElementById('pupuk-id-select');
        const manualInput = document.getElementById('pupuk-manual-name');
        
        if (record.fertilizerInventoryId) {
            select.value = record.fertilizerInventoryId;
            manualInput.style.display = 'none';
        } else {
            select.value = "MANUAL";
            manualInput.value = record.pupukType; 
            manualInput.style.display = 'block';
        }
        updateFertilizerInfo();

        const totalKg = record.usedAmountKg || (record.totalUsed ? record.totalUsed / 1000 : 0);
        document.getElementById('pupuk-total-value').value = totalKg; 

        if (mode === 'detail') {
            document.getElementById('pupuk-dose').value = record.dose || '';
            document.getElementById('pupuk-quantity').value = record.quantity || '';
            if(typeof calculatePupukTotal === 'function') calculatePupukTotal();
        } else {
            const manualTotalInput = document.getElementById('pupuk-total-input-manual');
            if (manualTotalInput) {
                manualTotalInput.value = totalKg;
                if(typeof syncQuickTotal === 'function') syncQuickTotal();
            }
        }
        
        document.getElementById('pupuk-notes').value = record.notes || '';
        
        // 4. Set Reminder
        if (record.reminderDueDateISO) {
            const dueDate = new Date(record.reminderDueDateISO);
            const yyyy = dueDate.getFullYear();
            const mm = String(dueDate.getMonth() + 1).padStart(2, '0');
            const dd = String(dueDate.getDate()).padStart(2, '0');
            const hh = String(dueDate.getHours()).padStart(2, '0');
            const min = String(dueDate.getMinutes()).padStart(2, '0');

            document.getElementById('pupuk-reminder-date').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('pupuk-reminder-time').value = `${hh}:${min}`;
        }
        
        // 5. Set Biaya
        const cost = record.cost || 0;
        document.getElementById('pupuk-cost').value = cost; 
        document.getElementById('pupuk-cost-display').value = cost > 0 ? cost.toLocaleString('id-ID') : '';

    } else if (record.type === 'Panen') {
        document.getElementById('harvest-quantity').value = record.quantity || 0;
        document.getElementById('harvest-notes').value = record.notes || '';
    } else if (['Penyemprotan', 'Pruning', 'Kastrasi'].includes(record.type)) { 
         const activityType = record.sawitActivity || record.type;
         document.getElementById('sawit-activity-type').value = activityType;
         document.getElementById('sawit-notes').value = record.notes || '';
         
         // Trigger toggle agar field yang relevan muncul
         const activitySelect = document.getElementById('sawit-activity-type');
         if (activitySelect) activitySelect.dispatchEvent(new Event('change'));

         if (activityType === 'Kastrasi') {
    const ids = record.selectedTreeIds || [];
    document.getElementById('selected-tree-ids').value = JSON.stringify(ids);
    const countLabel = document.getElementById('tree-selection-count');
    if(countLabel) countLabel.innerText = `${ids.length} Pohon Dipilih`;
}


         // PRE-FILL DATA KHUSUS PENYEMPROTAN
         if (activityType === 'Penyemprotan' && record.sawitDetails) {
              document.getElementById('spraying-target').value = record.sawitDetails.target || '';
              
              // UPDATE: Kirim ID racun agar stok 0/Arsip tetep muncul saat edit
              const poisonId = record.sawitDetails.poisonInventoryId;
              populatePoisonDropdown(poisonId);
              
              const pSelect = document.getElementById('poison-id-select');
              const pManual = document.getElementById('poison-manual-name');
              
              if (poisonId) {
                  pSelect.value = poisonId;
                  pManual.style.display = 'none';
              } else {
                  pSelect.value = "MANUAL";
                  pManual.value = record.sawitDetails.poisonName || '';
                  pManual.style.display = 'block';
              }
              
              // Update info stok (sisa stok, unit, dll)
              if (typeof updatePoisonInfo === 'function') updatePoisonInfo();

              document.getElementById('poison-dose').value = record.sawitDetails.dose || 0;
              document.getElementById('poison-quantity').value = record.sawitDetails.quantity || 0;
              
              // Trigger kalkulasi agar total liter/kg muncul
              if (typeof calculatePoisonTotal === 'function') calculatePoisonTotal();

              // Isi Data Biaya
              const cost = record.sawitDetails.cost || 0;
              document.getElementById('poison-cost').value = cost;
              document.getElementById('poison-cost-display').value = cost > 0 ? cost.toLocaleString('id-ID') : '';
         }
    }

    // Pastikan modal yang terbuka adalah modal utama catatan sawit
    openModal('record-modal');
    document.getElementById('record-modal-title').textContent = `Edit Catatan ${record.type}`;
    document.getElementById('record-type').value = record.type;
    
    // Refresh UI field sekali lagi untuk memastikan state terakhir benar
    if (typeof toggleFormFields === 'function') toggleFormFields(record.type);
}

function deleteRecord(id) {
     const record = records.find(r => r.id === id);
     if (!record) return;
     const confirmDelete = () => { 
         // LOGIKA REFUND STOK
         if (record.type === 'Pemupukan' && record.fertilizerInventoryId && record.usedAmountKg) {
             const fIndex = fertilizers.findIndex(f => f.id === record.fertilizerInventoryId);
             if (fIndex > -1) {
                 fertilizers[fIndex].currentWeight = parseFloat((fertilizers[fIndex].currentWeight + record.usedAmountKg).toFixed(2));
                 saveFertilizers();
             }
         }
         
if (record.sawitActivity === 'Penyemprotan' && record.sawitDetails && record.sawitDetails.poisonInventoryId && record.sawitDetails.totalUsedLiter) {
             const pIndex = poison.findIndex(p => p.id === record.sawitDetails.poisonInventoryId);
             if (pIndex > -1) {
                 poison[pIndex].currentWeight = parseFloat((poison[pIndex].currentWeight + record.sawitDetails.totalUsedLiter).toFixed(3));
                 savePoison();
                 showToast(`Stok ${poison[pIndex].name} dikembalikan.`);
             }
         }
         
         records = records.filter(r => r.id !== id); 
         reminders = reminders.filter(r => r.relatedRecordId !== id); 
         saveRecords(); saveReminders(); 
         renderContent(currentRecordType); 
         showCustomDialog('Berhasil Dihapus', `Catatan dihapus.`); 
     };
     showConfirmDialog('Hapus Catatan', `Yakin ingin menghapus?`, confirmDelete, null, 'danger');
}

// ** FITUR PIN: LOGIKA **
function togglePin(id) {
    const recordIndex = records.findIndex(r => r.id === id);
    if (recordIndex > -1) {
        records[recordIndex].isPinned = !records[recordIndex].isPinned;
        saveRecords();
        renderRecordList();
        closeModal('preview-modal');
    }
}

function previewRecord(id) {
    const record = records.find(r => r.id === id);
    if (!record) return;
    
    document.getElementById('garden-detail-content').style.display = 'none';
    document.getElementById('preview-content').style.display = 'block'; 
    document.getElementById('preview-title').textContent = `Detail Catatan ${getRecordIcon(record.type)} ${record.type}`;
    const previewContent = document.getElementById('preview-content');
    
    let htmlContent = `<div class="detail-group">`;
    htmlContent += `<div class="detail-row"><span class="detail-label">Tanaman</span><span class="detail-value">${record.plantName}</span></div>`;
    htmlContent += `<div class="detail-row"><span class="detail-label">Tanggal</span><span class="detail-value">${record.date}</span></div>`;

    if (record.type === 'Perawatan') {
        htmlContent += `<div class="detail-row"><span class="detail-label">Catatan</span><span class="detail-value">${record.notes || '-'}</span></div>`;
    } else if (record.type === 'Pemupukan') {

        const totalPupukKG = (record.totalUsed / 1000).toLocaleString('id-ID', {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
});

        htmlContent += `<div class="detail-row"><span class="detail-label">Pupuk</span><span class="detail-value">${record.pupukType}</span></div>`;
        htmlContent += `<div class="detail-row"><span class="detail-label">Dosis/Pohon</span><span class="detail-value">${record.dose}g x ${record.quantity} pohon</span></div>`;
        htmlContent += `<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value" style="font-weight: 600; color: var(--accent-green);">${totalPupukKG} kg</span></div>`;
        htmlContent += `<div class="detail-row"><span class="detail-label">Biaya</span><span class="detail-value">Rp ${parseInt(record.cost || 0).toLocaleString('id-ID')}</span></div>`;
        
        const reminderText = record.reminderDueDateISO ? formatDateTime(record.reminderDueDateISO) : 'Tidak Aktif';
        htmlContent += `<div class="detail-row"><span class="detail-label">Jadwal Pengingat</span><span class="detail-value" style="font-size: 13px;">${reminderText}</span></div>`;
        htmlContent += `
    <div class="detail-row" style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px;">
        <span class="detail-label" style="font-size: 12px; opacity: 0.6;">Catatan</span>
        <div class="detail-value" style="
            font-size: 14px; 
            color: var(--text-color); 
            line-height: 1.5; 
            white-space: pre-wrap; 
            word-break: break-word;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            min-height: 40px;
        ">${record.notes || '-'}</div>
    </div>
`;

    } else if (record.type === 'Panen') {
        htmlContent += `<div class="detail-row"><span class="detail-label">Hasil</span><span class="detail-value" style="font-weight: 600; color: var(--accent-green);">${record.quantity} kg</span></div>`;
        htmlContent += `<div class="detail-row"><span class="detail-label">Catatan</span><span class="detail-value">${record.notes || '-'}</span></div>`;
    } else if (['Penyemprotan', 'Pruning', 'Kastrasi'].includes(record.type)) {
        htmlContent += `<div class="detail-row"><span class="detail-label">Jenis Kegiatan</span><span class="detail-value">${record.sawitActivity || record.type}</span></div>`;
        
        // --- LOGIKA BARU: TAMPILKAN TOMBOL PETA KASTRASI ---
        if (record.sawitActivity === 'Kastrasi' && record.selectedTreeIds && record.selectedTreeIds.length > 0) {
            htmlContent += `
                <div style="margin-top:10px; padding:10px; background:var(--card-bg-alt); border-radius:10px; border:1px solid var(--border-color); text-align:center;">
                    <div style="font-size:13px; margin-bottom:5px;"><strong>${record.selectedTreeIds.length} Pohon</strong> dikastrasi</div>
                    <button class="secondary-action" onclick="viewRecordMap('${record.id}')" style="width:100%; font-size:12px;">üó∫Ô∏èLihat Peta Kastrasi</button>
                </div>
            `;
        }
        
        htmlContent += `
    <div class="detail-row" style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px;">
        <span class="detail-label" style="font-size: 12px; opacity: 0.6;">Catatan</span>
        <div class="detail-value" style="
            font-size: 14px; 
            color: var(--text-color); 
            line-height: 1.5; 
            white-space: pre-wrap; 
            word-break: break-word;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            min-height: 40px;
        ">${record.notes || '-'}</div>
    </div>
`;

        
                if(record.sawitActivity === 'Penyemprotan' && record.sawitDetails) {
            htmlContent += `<div class="detail-row"><span class="detail-label">Target</span><span class="detail-value">${record.sawitDetails.target || '-'}</span></div>`;
            htmlContent += `<div class="detail-row"><span class="detail-label">Racun</span><span class="detail-value">${record.sawitDetails.poisonName || '-'}</span></div>`;
            
            // Tambahan Info Detail
            htmlContent += `<div class="detail-row"><span class="detail-label">Dosis/Tangki</span><span class="detail-value">${record.sawitDetails.dose}ml x ${record.sawitDetails.quantity}</span></div>`;
            
            const totL = record.sawitDetails.totalUsedLiter ? record.sawitDetails.totalUsedLiter.toFixed(3) + ' L' : '-';
            htmlContent += `<div class="detail-row"><span class="detail-label">Total Pakai</span><span class="detail-value" style="font-weight:bold; color:var(--accent-red);">${totL}</span></div>`;
            
            const costRp = record.sawitDetails.cost ? 'Rp ' + parseInt(record.sawitDetails.cost).toLocaleString('id-ID') : '-';
            htmlContent += `<div class="detail-row"><span class="detail-label">Biaya</span><span class="detail-value">${costRp}</span></div>`;
        }

    }
    htmlContent += `</div>`; 

    previewContent.innerHTML = htmlContent;
    
    if (record.type === 'Perawatan' && record.photoUrl) {
         previewContent.innerHTML += `<h3 style="margin-top: 20px;">Foto Perawatan</h3><img src="${record.photoUrl}" style="max-width: 100%; height: auto; border-radius: 10px; margin-bottom: 20px;">`;
    }
    
    const pinText = record.isPinned ? 'Lepas Pin' : 'üìå Pin Catatan';
    const pinBtnClass = record.isPinned ? 'secondary-action' : 'secondary-action';

    const actionButtonsHTML = `
        <div class="form-actions">
            <button class="${pinBtnClass}" onclick="togglePin('${record.id}')">${pinText}</button>
            <div style="display:flex; gap:10px;">
                <button style="flex:1;" class="primary-action" onclick="editRecord('${record.id}'); closeModal('preview-modal');">‚úèÔ∏è Edit</button>
                <button style="flex:1;" class="danger-btn" onclick="deleteRecord('${record.id}'); closeModal('preview-modal');">üóëÔ∏è Hapus</button>
            </div>
            <button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button>
        </div>
    `;
    previewContent.innerHTML += actionButtonsHTML;
    
    openModal('preview-modal');
}

// --- IMAGE PREVIEW UTILS ---
function updatePerawatanPhotoPreview(url, file, target) {
    const previewDivId = target === 'gallery' ? 'photo-preview-gallery' : 'photo-preview-perawatan';
    const previewDiv = document.getElementById(previewDivId);
    const urlInputId = target === 'gallery' ? 'gallery-photo-url' : 'perawatan-photo-url';
    const fileInputId = target === 'gallery' ? 'gallery-photo-file' : 'perawatan-photo-file';
    
    previewDiv.innerHTML = '';
    let finalUrl = url;
    
    if (file) { 
        finalUrl = URL.createObjectURL(file); 
        document.getElementById(urlInputId).value = ''; 
    } else if (url) {
         document.getElementById(fileInputId).value = '';
    }
    if (finalUrl) {
        const img = document.createElement('img'); 
        img.src = finalUrl; 
        img.style.maxWidth = '100%'; 
        img.style.height = 'auto'; 
        img.style.borderRadius = '8px';
        previewDiv.appendChild(img);
    }
}

function previewPerawatanPhoto(target) {
     const urlInputId = target === 'gallery' ? 'gallery-photo-url' : 'perawatan-photo-url';
     const url = document.getElementById(urlInputId).value;
     if (url.trim() !== '') {
        updatePerawatanPhotoPreview(url, null, target);
     } else {
         const previewDivId = target === 'gallery' ? 'photo-preview-gallery' : 'photo-preview-perawatan';
         document.getElementById(previewDivId).innerHTML = '';
     }
}

// --- NAVIGATION & RENDERERS ---
function toggleSettings() {
    document.getElementById('display-username').textContent = loggedInUsername.charAt(0).toUpperCase() + loggedInUsername.slice(1);
    if (isSettingsOpen) {
        isSettingsOpen = false;
        renderContent('Dashboard');
    } else {
        isSettingsOpen = true;
        currentRecordType = 'Settings';
        localStorage.removeItem('gardenFilterId'); localStorage.removeItem('gardenFilterTitle');
        ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'poison-list', 'map-view', 'finance-view'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('settings-view').style.display = 'block';
        tabButtons.forEach(btn => btn.classList.remove('active'));
    }
}

function renderContent(type) {
    if (type === 'Settings') { toggleSettings(); return; }
    isSettingsOpen = false; settingsView.style.display = 'none';
    if (type !== 'Daftar Catatan') {
        localStorage.removeItem('gardenFilterId'); 
        localStorage.removeItem('gardenFilterTitle');
    }
    currentRecordType = type;
    ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'poison-list', 'finance-view'].forEach(id => document.getElementById(id).style.display = 'none');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.tab-button[data-type="${type}"]`);
    if(activeBtn) activeBtn.classList.add('active');
    const searchWrapper = document.getElementById('search-input')?.parentElement || document.querySelector('.search-bar-wrapper');

    if (type === 'Dashboard') {
        if (searchWrapper) searchWrapper.style.display = 'flex';
        dashboardContent.style.display = 'block'; 
        dashboardContent.classList.add('page-animate');
        renderDashboard();
        
    } else if (type === 'Daftar Kebun') { 
        if (searchWrapper) searchWrapper.style.display = 'flex';
        gardenList.style.display = 'block'; 
        gardenList.classList.add('page-animate');
        renderGardenList();
        
    } else if (type === 'Daftar Pupuk') {
        if (searchWrapper) searchWrapper.style.display = 'flex';
        fertilizerList.style.display = 'block'; 
        fertilizerList.classList.add('page-animate');
        renderFertilizerList(); 
        
    } else if (type === 'Daftar Catatan') {
        if (searchWrapper) searchWrapper.style.display = 'flex';
         recordList.style.display = 'block';
         recordList.classList.add('page-animate');
         renderRecordList(); 
         
    } else if (type === 'Galeri Tanaman') {
        if (searchWrapper) searchWrapper.style.display = 'none';
         galleryView.style.display = 'block'; galleryView.classList.add('page-animate');
         renderGallery();
         
    } else if (type === 'Daftar Racun') {
        if (searchWrapper) searchWrapper.style.display = 'flex';
        poisonList.style.display = 'block'; 
        poisonList.classList.add('page-animate');
        renderPoisonList();
        
    } else if (type === 'Keuangan') {
        if (searchWrapper) searchWrapper.style.display = 'none';
    financeList.style.display = 'block';
           financeList.classList.add('page-animate');
        renderFinanceList();
            
    } else if (type === 'Peta') {
            // Sembunyikan konten lain
            ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'finance-view', 'settings-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            // Tampilkan Container Utama Peta
            document.getElementById('map-view').style.display = 'block';
            
            // --- BAGIAN INI YANG MEMPERBAIKI BUG DAFTAR PETA HILANG ---
            // 1. Pastikan LIST Peta MUNCUL
            document.getElementById('map-list-container').style.display = 'block';
            
            // 2. Pastikan KANVAS Peta SEMBUNYI (Reset total)
            document.getElementById('map-canvas-area').style.display = 'none';
            document.body.classList.remove('editor-active');
            
            // 3. Pastikan kontrol bawaan peta MUNCUL kembali (jika sebelumnya disembunyikan mode kastrasi)
            const defaultControls = document.getElementById('default-map-controls');
            if(defaultControls) defaultControls.style.display = 'flex';
            
            // 4. Hapus kontrol sampah (kastrasi/selector) jika masih nyangkut
            const kastrasiControls = document.getElementById('kastrasi-map-controls');
            if(kastrasiControls) kastrasiControls.remove();
            
            const selectorControls = document.getElementById('selector-map-controls');
            if(selectorControls) selectorControls.remove();

            // Render ulang list
            renderMapList();
        } 
}

tabButtons.forEach(button => {
    button.addEventListener('click', (e) => {
        const type = e.currentTarget.getAttribute('data-type');
        renderContent(type);
    });
});

function calculateTotalFertilizerKg() {
    const totalGram = records
        .filter(r => r.type === 'Pemupukan' && r.totalUsed)
        .reduce((sum, r) => sum + parseFloat(r.totalUsed || 0), 0); 
    return totalGram / 1000;
}

function renderDashboard() {
    closeAvatarMenu();
    localStorage.removeItem('listFilterType'); 
    localStorage.removeItem('listFilterDate');
    listFilterType = 'Semua'; 
    listFilterDate = 'Semua';
    
    dashboardContent.innerHTML = `
        <div id="dashboard-search-results" class="list-container"></div>
        <div id="stat-cards-container" class="list-container" style="padding-top: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;"></div>
        <div id="reminders-list-container" class="list-container"></div>
        <div id="recent-activity-list" class="list-container"><h3>Aktivitas Terbaru</h3></div>
    `;
    
    const searchValue = searchInput.value.trim().toLowerCase();

    if (searchValue.length > 0) {
        document.getElementById('recent-activity-list').style.display = 'none';
        document.getElementById('stat-cards-container').style.display = 'none';
        document.getElementById('reminders-list-container').style.display = 'none';
        document.getElementById('dashboard-search-results').style.display = 'block';

        const searchResults = document.getElementById('dashboard-search-results');
        searchResults.innerHTML = `<h3>Hasil Pencarian untuk "${searchValue}"</h3>`;
        let combinedResults = [];
        
        const filteredRecords = records.filter(r => 
            r.plantName.toLowerCase().includes(searchValue) || 
            r.type.toLowerCase().includes(searchValue) ||
            (r.pupukType && r.pupukType.toLowerCase().includes(searchValue)) ||
            (r.notes && r.notes.toLowerCase().includes(searchValue))
        ).map(r => {
            let detail = r.type;
            if (r.type === 'Pemupukan') detail += `: ${r.pupukType}`;
            if (r.type === 'Panen') detail += `: ${r.quantity}kg`;
            return {
                id: r.id,
                type: 'Catatan',
                title: `${getRecordIcon(r.type)} ${r.plantName}`,
                subtitle: `${r.date} - ${detail}`, 
                action: () => previewRecord(r.id),
            };
        });
        combinedResults.push(...filteredRecords);
        
        const filteredGardens = gardens.filter(g => 
            g.title.toLowerCase().includes(searchValue) || 
            (g.varieties && g.varieties.toLowerCase().includes(searchValue))
        ).map(g => ({
            id: g.id,
            type: 'Kebun',
            title: `üå≥ Kebun: ${g.title}`,
            subtitle: `Varietas: ${g.varieties || '-'} | Umur: ${calculateAge(g.dateTanam)}`,
            action: () => showGardenDetail(g.id),
        }));
        combinedResults.push(...filteredGardens);
        
        const filteredFert = fertilizers.filter(f => f.name.toLowerCase().includes(searchValue)).map(f => ({
            id: f.id, type: 'Stok Pupuk', title: `üõçÔ∏è ${f.name}`, subtitle: `Stok: ${f.currentWeight}kg`, action: () => { renderContent('Daftar Pupuk'); }
        }));
        combinedResults.push(...filteredFert);
        
        if (combinedResults.length === 0) {
             searchResults.innerHTML += '<p style="text-align:center; color: var(--secondary-text-color);">Tidak ada hasil.</p>';
             return;
        }
        
        combinedResults.forEach(res => {
            const card = document.createElement('div');
            card.className = 'record-card';
            card.onclick = res.action;
            card.innerHTML = `
                <div style="flex:1;">
                    <h3 style="margin: 0; font-size: 16px;">${highlightText(res.title, searchValue)}</h3>
                    <p style="margin: 5px 0 0; font-size: 14px; color: var(--secondary-text-color);">${highlightText(res.subtitle, searchValue)}</p>
                    <span style="font-size: 10px; padding: 2px 5px; border-radius: 4px; background: var(--secondary-bg); color: var(--primary-color);">${res.type}</span>
                </div>
            `;
            document.getElementById('dashboard-search-results').appendChild(card);
        });
    
    } else {
        const statsContainer = document.getElementById('stat-cards-container');
        
        // Data Awal
        const totalHarvest = records.filter(r => r.type === 'Panen').reduce((sum, r) => sum + parseFloat(r.quantity || 0), 0);
        const totalFertilizerKg = calculateTotalFertilizerKg(); 
        const totalPupukCost = records.filter(r => r.type === 'Pemupukan').reduce((sum, r) => sum + parseInt(r.cost || 0), 0);
        
        statsContainer.innerHTML = `
    <div class="record-card stat-card" onclick="renderContent('Daftar Kebun')">
        <div style="font-size: 13px; opacity:0.8;">üå≥ Kebun</div>
        <div style="font-size: 20px; font-weight:800;">${gardens.length}</div>
    </div>
    <div class="record-card stat-card" onclick="renderContent('Daftar Catatan')">
        <div style="font-size: 13px; opacity:0.8;">üìù Catatan</div>
        <div style="font-size: 20px; font-weight:800;">${records.length}</div>
    </div>

<div id="harvest-stat-card" class="record-card stat-card" onclick="toggleHarvestFilter()" style="grid-column: span 2; position: relative; height: auto; transition: all 0.3s ease; overflow: hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size: 13px; opacity:0.8;">üçé Total Panen</div>
        <div id="harvest-active-label" style="font-size: 10px; background: var(--primary-color); color:white; padding: 2px 10px; border-radius: 12px; font-weight:bold; white-space: nowrap;">Semua Waktu</div>
    </div>
    <div id="harvest-total-value" style="font-size: 28px; font-weight:800; margin: 8px 0;">0 <span style="font-size:14px; opacity:0.6;">kg</span></div>
    
    <div id="harvest-garden-filter-area" style="display:none; margin-top:5px; margin-bottom:10px;" onclick="event.stopPropagation()">
        <select id="harvest-garden-select" onchange="applyHarvestFilter('current', event)" style="width:100%; padding:8px; border-radius:10px; background:var(--secondary-bg); color:var(--text-color); border:none; font-size:13px; font-weight:600;">
            <option value="all">üåê Semua Kebun</option>
            ${gardens.map(g => `<option value="${g.id}">üå≥ ${g.title}</option>`).join('')}
        </select>
    </div>

    <div id="harvest-filter-menu" style="display:none; gap:6px; flex-wrap:wrap; border-top: 1px solid rgba(125,125,125,0.1); padding-top:12px;">
        <button class="ios-chip active" onclick="applyHarvestFilter('all', event, this)">Semua</button>
        <button class="ios-chip" onclick="applyHarvestFilter('week', event, this)">Minggu</button>
        <button class="ios-chip" onclick="applyHarvestFilter('month', event, this)">Bulan</button>
        <button class="ios-chip" onclick="applyHarvestFilter('year', event, this)">Tahun</button>
        <button class="ios-chip" onclick="openHarvestCustomFilter(event)">üìÖ Kustom</button>
    </div>

    <div id="harvest-custom-date-area" style="display:none; margin-top:10px; padding-top:12px; border-top: 1px dashed rgba(125,125,125,0.2);" onclick="event.stopPropagation()">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">DARI</label>
                <input type="date" id="harvest-start-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">SAMPAI</label>
                <input type="date" id="harvest-end-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
        </div>
        <button onclick="applyHarvestFilter('custom', event)" style="width:100%; background:var(--text-color); color:var(--bg-color); border:none; padding:10px; border-radius:10px; font-size:12px; font-weight:bold; letter-spacing:1px;">TERAPKAN FILTER</button>
    </div>
</div>

<div id="fertilizer-stat-card" class="record-card stat-card" onclick="toggleFertilizerFilter()" style="grid-column: span 2; position: relative; height: auto; transition: all 0.3s ease; overflow: hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size: 13px; opacity:0.8;">üß™ Penggunaan Pupuk</div>
        <div id="fert-active-label" style="font-size: 10px; background: #34C759; color:white; padding: 2px 10px; border-radius: 12px; font-weight:bold; white-space: nowrap;">Semua Waktu</div>
    </div>
    <div id="fert-total-value" style="font-size: 28px; font-weight:800; margin: 8px 0;">0 <span style="font-size:14px; opacity:0.6;">kg</span></div>
    
    <div id="fert-garden-filter-area" style="display:none; margin-top:5px; margin-bottom:10px;" onclick="event.stopPropagation()">
        <select id="fert-garden-select" onchange="applyFertilizerFilter('current', event)" style="width:100%; padding:8px; border-radius:10px; background:var(--secondary-bg); color:var(--text-color); border:none; font-size:13px; font-weight:600; font-family:inherit;">
            <option value="all">üåê Semua Kebun</option>
            ${gardens.map(g => `<option value="${g.id}">üå≥ ${g.title}</option>`).join('')}
        </select>
    </div>

<div id="fert-filter-menu" style="display:none; gap:6px; flex-wrap:wrap; border-top: 1px solid rgba(125,125,125,0.1); padding-top:12px;">
    <button class="ios-chip active" style="font-size: 11px; padding: 4px 10px;" onclick="applyFertilizerFilter('all', event, this)">Semua</button>
    <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyFertilizerFilter('week', event, this)">Minggu</button>
    <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyFertilizerFilter('month', event, this)">Bulan</button>
    <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyFertilizerFilter('year', event, this)">Tahun</button>
    <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="openFertCustomFilter(event)">üìÖ Kustom</button>
</div>


    <div id="fert-custom-date-area" style="display:none; margin-top:10px; padding-top:12px; border-top: 1px dashed rgba(125,125,125,0.2);" onclick="event.stopPropagation()">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">DARI</label>
                <input type="date" id="fert-start-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">SAMPAI</label>
                <input type="date" id="fert-end-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
        </div>
        <button onclick="applyFertilizerFilter('custom', event)" style="width:100%; background:var(--text-color); color:var(--bg-color); border:none; padding:10px; border-radius:10px; font-size:12px; font-weight:bold; letter-spacing:1px;">TERAPKAN FILTER</button>
    </div>
</div>

<div id="cost-stat-card" class="record-card stat-card" onclick="toggleCostFilter()" style="grid-column: span 2; position: relative; height: auto; transition: all 0.3s ease; overflow: hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size: 12px; opacity:0.8;">üí∏ Biaya Operasional Pemupukan</div>
        <div id="cost-active-label" style="font-size: 10px; background: #FF9500; color:white; padding: 2px 10px; border-radius: 12px; font-weight:bold; white-space: nowrap;">Semua Waktu</div>
    </div>
    <div id="cost-total-value" style="font-size: 28px; font-weight:800; margin: 8px 0;">Rp 0</div>
    
    <div id="cost-garden-filter-area" style="display:none; margin-top:5px; margin-bottom:10px;" onclick="event.stopPropagation()">
        <select id="cost-garden-select" onchange="applyCostFilter('current', event)" style="width:100%; padding:8px; border-radius:10px; background:var(--secondary-bg); color:var(--text-color); border:none; font-size:13px; font-weight:600; font-family:inherit;">
            <option value="all">üåê Semua Kebun</option>
            ${gardens.map(g => `<option value="${g.id}">üå≥ ${g.title}</option>`).join('')}
        </select>
    </div>

    <div id="cost-filter-menu" style="display:none; gap:6px; flex-wrap:wrap; border-top: 1px solid rgba(125,125,125,0.1); padding-top:12px;">
        <button class="ios-chip active" style="font-size: 11px; padding: 4px 10px;" onclick="applyCostFilter('all', event, this)">Semua</button>
        <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyCostFilter('week', event, this)">Minggu</button>
        <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyCostFilter('month', event, this)">Bulan</button>
        <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="applyCostFilter('year', event, this)">Tahun</button>
        <button class="ios-chip" style="font-size: 11px; padding: 4px 10px;" onclick="openCostCustomFilter(event)">üìÖ Kustom</button>
    </div>

    <div id="cost-custom-date-area" style="display:none; margin-top:10px; padding-top:12px; border-top: 1px dashed rgba(125,125,125,0.2);" onclick="event.stopPropagation()">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">DARI</label>
                <input type="date" id="cost-start-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
            <div style="flex:1;">
                <label style="font-size:9px; display:block; margin-bottom:3px; opacity:0.6;">SAMPAI</label>
                <input type="date" id="cost-end-date" style="width:100%; border:none; background:var(--secondary-bg); color:var(--text-color); padding:8px; border-radius:8px; font-size:13px; font-family:inherit;">
            </div>
        </div>
        <button onclick="applyCostFilter('custom', event)" style="width:100%; background:var(--text-color); color:var(--bg-color); border:none; padding:10px; border-radius:10px; font-size:12px; font-weight:bold; letter-spacing:1px;">TERAPKAN FILTER</button>
    </div>
</div>

`;
        
        // Reminder & Recent Activity (Tetap sama)
        renderRemindersSection();
        renderRecentActivitySection();
        applyHarvestFilter('all');
        applyFertilizerFilter('all');
        applyCostFilter('all');

    }
}

let currentCostTimeFilter = 'all';

function toggleCostFilter() {
    const menu = document.getElementById('cost-filter-menu');
    const gardenArea = document.getElementById('cost-garden-filter-area');
    const customArea = document.getElementById('cost-custom-date-area');
    const isHidden = menu.style.display === 'none';
    
    if (isHidden) {
        menu.style.display = 'flex';
        gardenArea.style.display = 'block';
    } else {
        menu.style.display = 'none';
        gardenArea.style.display = 'none';
        customArea.style.display = 'none';
    }
}

function openCostCustomFilter(event) {
    event.stopPropagation();
    const area = document.getElementById('cost-custom-date-area');
    const isHidden = area.style.display === 'none';
    
    area.style.display = isHidden ? 'block' : 'none';
    
    if (area.style.display === 'block') {
        document.querySelectorAll('#cost-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
}


function applyCostFilter(filter, event, btn) {
    if (event) event.stopPropagation();

    const labelElement = document.getElementById('cost-active-label');
    const totalDisplay = document.getElementById('cost-total-value');
    const gardenSelect = document.getElementById('cost-garden-select');
    const customArea = document.getElementById('cost-custom-date-area');

    if (!labelElement || !totalDisplay) return;

    if (filter !== 'current' && filter !== 'custom') {
        currentCostTimeFilter = filter;
        if (customArea) customArea.style.display = 'none';
    }
    if (filter === 'custom') currentCostTimeFilter = 'custom';

    const gardenId = gardenSelect ? gardenSelect.value : 'all';
    
    // Filter semua records yang memiliki cost
    let filtered = records.filter(r => r.cost && parseInt(r.cost) > 0);

    if (gardenId !== 'all') {
        filtered = filtered.filter(r => r.gardenIdReference === gardenId);
    }

    const now = new Date();
    let timeLabel = "Semua Waktu";

    if (btn) {
        document.querySelectorAll('#cost-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    if (currentCostTimeFilter === 'week') {
        const d = new Date();
        const monday = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)));
        monday.setHours(0,0,0,0);
        filtered = filtered.filter(r => new Date(r.date) >= monday);
        timeLabel = "Minggu Ini";
    } else if (currentCostTimeFilter === 'month') {
        filtered = filtered.filter(r => new Date(r.date).getMonth() === now.getMonth() && new Date(r.date).getFullYear() === now.getFullYear());
        timeLabel = "Bulan Ini";
    } else if (currentCostTimeFilter === 'year') {
        filtered = filtered.filter(r => new Date(r.date).getFullYear() === now.getFullYear());
        timeLabel = "Tahun Ini";
    } else if (currentCostTimeFilter === 'custom') {
        const start = document.getElementById('cost-start-date').value;
        const end = document.getElementById('cost-end-date').value;
        if (start && end) {
            filtered = filtered.filter(r => r.date >= start && r.date <= end);
            const fDate = (dStr) => {
                const d = new Date(dStr);
                return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`;
            };
            timeLabel = `${fDate(start)} - ${fDate(end)}`;
            if (filter === 'custom' && customArea) customArea.style.display = 'none';
        } else if (filter === 'custom') {
            return showToast("Pilih rentang tanggal!");
        }
    }

    const total = filtered.reduce((sum, r) => sum + (parseInt(r.cost) || 0), 0);
    totalDisplay.innerHTML = `Rp ${total.toLocaleString('id-ID')}`;

    const gardenName = (gardenSelect && gardenId !== 'all') ? ` (${gardenSelect.options[gardenSelect.selectedIndex].text.replace('üå≥ ', '')})` : '';
    labelElement.textContent = timeLabel + gardenName;
}


let currentFertTimeFilter = 'all';

function toggleFertilizerFilter() {
    const menu = document.getElementById('fert-filter-menu');
    const gardenArea = document.getElementById('fert-garden-filter-area');
    const customArea = document.getElementById('fert-custom-date-area');
    const isHidden = menu.style.display === 'none';
    
    if (isHidden) {
        menu.style.display = 'flex';
        gardenArea.style.display = 'block';
    } else {
        menu.style.display = 'none';
        gardenArea.style.display = 'none';
        customArea.style.display = 'none';
    }
}

function openFertCustomFilter(event) {
    event.stopPropagation();
    const area = document.getElementById('fert-custom-date-area');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
    if (area.style.display === 'block') {
        document.querySelectorAll('#fert-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
}

function applyFertilizerFilter(filter, event, btn) {
    if (event) event.stopPropagation();

    const labelElement = document.getElementById('fert-active-label');
    const totalDisplay = document.getElementById('fert-total-value');
    const gardenSelect = document.getElementById('fert-garden-select');
    const customArea = document.getElementById('fert-custom-date-area');

    if (!labelElement || !totalDisplay) return;

    if (filter !== 'current' && filter !== 'custom') {
        currentFertTimeFilter = filter;
        if (customArea) customArea.style.display = 'none';
    }
    if (filter === 'custom') currentFertTimeFilter = 'custom';

    const gardenId = gardenSelect ? gardenSelect.value : 'all';
    let filtered = records.filter(r => r.type === 'Pemupukan');

    if (gardenId !== 'all') {
        filtered = filtered.filter(r => r.gardenIdReference === gardenId);
    }

    const now = new Date();
    let timeLabel = "Semua Waktu";

    if (btn) {
        document.querySelectorAll('#fert-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    if (currentFertTimeFilter === 'week') {
        const d = new Date();
        const monday = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)));
        monday.setHours(0, 0, 0, 0);
        filtered = filtered.filter(r => new Date(r.date) >= monday);
        timeLabel = "Minggu Ini";
    } else if (currentFertTimeFilter === 'month') {
        filtered = filtered.filter(r => {
            const d = new Date(r.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        timeLabel = "Bulan Ini";
    } else if (currentFertTimeFilter === 'year') {
        filtered = filtered.filter(r => new Date(r.date).getFullYear() === now.getFullYear());
        timeLabel = "Tahun Ini";
    } else if (currentFertTimeFilter === 'custom') {
        const start = document.getElementById('fert-start-date').value;
        const end = document.getElementById('fert-end-date').value;
        if (start && end) {
            filtered = filtered.filter(r => r.date >= start && r.date <= end);
            const fDate = (dStr) => {
                const d = new Date(dStr);
                return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
            };
            timeLabel = `${fDate(start)} - ${fDate(end)}`;
            if (filter === 'custom' && customArea) customArea.style.display = 'none';
        } else if (filter === 'custom') {
            return showToast("Pilih rentang tanggal!");
        }
    }
        const total = filtered.reduce((sum, r) => sum + (parseFloat(r.usedAmountKg) || 0), 0);


        totalDisplay.innerHTML = `${total.toLocaleString('id-ID', {
            minimumFractionDigits: 1, 
            maximumFractionDigits: 1
        })} <span style="font-size:14px; opacity:0.6;">kg</span>`;


    const gardenName = (gardenSelect && gardenId !== 'all') ? ` (${gardenSelect.options[gardenSelect.selectedIndex].text.replace('üå≥ ', '')})` : '';
    labelElement.textContent = timeLabel + gardenName;
}


function toggleHarvestFilter() {
    const menu = document.getElementById('harvest-filter-menu');
    const gardenArea = document.getElementById('harvest-garden-filter-area');
    const customArea = document.getElementById('harvest-custom-date-area');
    const isHidden = menu.style.display === 'none';
    
    if (isHidden) {
        menu.style.display = 'flex';
        gardenArea.style.display = 'block';
    } else {
        menu.style.display = 'none';
        gardenArea.style.display = 'none';
        customArea.style.display = 'none';
    }
}


function openHarvestCustomFilter(event) {
    event.stopPropagation();
    const customArea = document.getElementById('harvest-custom-date-area');
    const isHidden = customArea.style.display === 'none';
    
    customArea.style.display = isHidden ? 'block' : 'none';
    
    if (isHidden) {
        document.querySelectorAll('#harvest-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
}


let currentHarvestTimeFilter = 'all'; // Variable global untuk simpan status waktu

function applyHarvestFilter(filter, event, btn) {
    if (event) event.stopPropagation();

    const labelElement = document.getElementById('harvest-active-label');
    const totalDisplay = document.getElementById('harvest-total-value');
    const gardenSelect = document.getElementById('harvest-garden-select');
    const customArea = document.getElementById('harvest-custom-date-area');

    if (!labelElement || !totalDisplay) return;

    const gardenId = gardenSelect ? gardenSelect.value : 'all';

    if (filter !== 'current' && filter !== 'custom') {
        currentHarvestTimeFilter = filter;
        if (customArea) customArea.style.display = 'none';
    }
    if (filter === 'custom') {
        currentHarvestTimeFilter = 'custom';
    }

    let filtered = records.filter(r => r.type === 'Panen');

    if (gardenId !== 'all') {
        filtered = filtered.filter(r => r.gardenIdReference === gardenId);
    }

    const now = new Date();
    let timeLabel = "Semua Waktu";

    if (btn) {
        document.querySelectorAll('#harvest-filter-menu .ios-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    if (currentHarvestTimeFilter === 'week') {
        const d = new Date();
        const monday = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)));
        monday.setHours(0, 0, 0, 0);
        filtered = filtered.filter(r => new Date(r.date) >= monday);
        timeLabel = "Minggu Ini";
    } else if (currentHarvestTimeFilter === 'month') {
        filtered = filtered.filter(r => {
            const d = new Date(r.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        timeLabel = "Bulan Ini";
    } else if (currentHarvestTimeFilter === 'year') {
        filtered = filtered.filter(r => new Date(r.date).getFullYear() === now.getFullYear());
        timeLabel = "Tahun Ini";
    } else if (currentHarvestTimeFilter === 'custom') {
        const start = document.getElementById('harvest-start-date').value;
        const end = document.getElementById('harvest-end-date').value;
        if (start && end) {
            filtered = filtered.filter(r => r.date >= start && r.date <= end);
            const fDate = (dStr) => {
                const d = new Date(dStr);
                return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
            };
            timeLabel = `${fDate(start)} - ${fDate(end)}`;
            if (filter === 'custom' && customArea) customArea.style.display = 'none';
        } else {
            if (filter === 'custom') return showToast("Pilih rentang tanggal!");
        }
    }

    const total = filtered.reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
    totalDisplay.innerHTML = `${total.toFixed(1)} <span style="font-size:14px; opacity:0.6;">kg</span>`;

    const gardenName = (gardenSelect && gardenId !== 'all') ? ` (${gardenSelect.options[gardenSelect.selectedIndex].text.replace('üå≥ ', '')})` : '';
    labelElement.textContent = timeLabel + gardenName;
}


function renderRemindersSection() {
    const remindersList = document.getElementById('reminders-list-container');
    remindersList.innerHTML = '<h3>üîî Pengingat Aktif</h3>';
    const activeReminders = reminders.sort((a, b) => new Date(a.dateDue) - new Date(b.dateDue)).slice(0, 5); 
    if (activeReminders.length === 0) {
        remindersList.innerHTML += '<p style="text-align:center; color: var(--secondary-text-color); font-size:13px;">Tidak ada pengingat.</p>';
    } else {
        activeReminders.forEach(r => {
            const status = getReminderStatus(r.dateDue);
            remindersList.innerHTML += `
                <div class="record-card" onclick="viewRecordAndOpenReminderForm('${r.relatedRecordId}', '${r.id}')" style="border-left: 4px solid ${status.color};">
                    <div style="flex:1;">
                        <h3 style="margin: 0; font-size: 15px;">${getRecordIcon(r.type)} ${r.title}</h3>
                        <p style="margin: 3px 0 0; font-size: 12px; color: ${status.color}; font-weight: 700;">${status.text} ‚Ä¢ ${formatDateTime(r.dateDue)}</p>
                    </div>
                </div>`;
        });
    }
}

function renderRecentActivitySection() {
    const recentList = document.getElementById('recent-activity-list');
    recentList.innerHTML = '<h3>Aktivitas Terbaru</h3>';
    
    // Tentukan batas waktu 48 jam yang lalu (48 jam * 60 mnt * 60 dtk * 1000 ms)
    const fortyEightHoursAgo = Date.now() - (48 * 60 * 60 * 1000);

    // Filter hanya aktivitas yang terjadi dalam 48 jam terakhir
    const recentActivities = records
        .filter(r => {
            const recordDate = new Date(r.date).getTime();
            return recordDate >= fortyEightHoursAgo;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

    if (recentActivities.length === 0) {
        recentList.innerHTML += '<p style="text-align:center; color: var(--secondary-text-color); font-size:13px; padding: 10px;">Tidak ada aktivitas dalam 48 jam terakhir.</p>';
    } else {
        recentActivities.forEach(r => {
            let gardenTitle = '';
            if (r.gardenIdReference) {
                const garden = gardens.find(g => g.id === r.gardenIdReference);
                gardenTitle = garden ? ` (${garden.title})` : '';
            }
            
            recentList.innerHTML += `
                <div class="record-card" onclick="previewRecord('${r.id}')">
                    <div style="flex:1;">
                        <h3 style="margin: 0; font-size: 15px;">${getRecordIcon(r.type)} ${r.plantName}${gardenTitle}</h3>
                        <p style="margin: 3px 0 0; font-size: 12px; color: var(--secondary-text-color);">${r.date}</p>
                    </div>
                </div>`;
        });
    }
}


function renderGardenList() {
    const container = document.getElementById('garden-cards-container');
    container.innerHTML = '';
    const searchValue = searchInput.value.trim().toLowerCase();
    const filteredGardens = gardens.filter(g => g.title.toLowerCase().includes(searchValue) || (g.varieties && g.varieties.toLowerCase().includes(searchValue)));

    if (filteredGardens.length === 0) { container.innerHTML = '<p style="text-align: center; margin-top: 30px; color: var(--secondary-text-color);">Belum ada kebun.</p>'; return; }

    filteredGardens.forEach(garden => {
        const card = document.createElement('div');
        card.className = 'record-card garden-card';
        card.onclick = () => showGardenDetail(garden.id);
        const gardenAge = calculateAge(garden.dateTanam);
        const dateTanamDisplay = garden.dateTanam ? `Tanam: ${garden.dateTanam}` : 'Tanggal Tanam: N/A';
        const highlightedTitle = highlightText(garden.title, searchValue);
        const highlightedVarieties = highlightText(garden.varieties || 'Beragam', searchValue);

        card.innerHTML = `
            <div>
                <h3 style="margin: 0; font-size: 18px;">üå≥ ${highlightedTitle}</h3>
                <p style="margin: 5px 0 0; font-size: 14px; color: var(--secondary-text-color);">${gardenAge} | ${garden.plantCount} Tanaman</p>
                <p style="margin: 2px 0 0; font-size: 12px; color: var(--secondary-text-color);">${dateTanamDisplay} | ${highlightedVarieties}</p>
            </div>
            <div class="action-buttons">
                <button onclick="event.stopPropagation(); deleteGarden('${garden.id}')" style="background: var(--secondary-bg); color: var(--accent-red); border:none; width:40px; height:40px; border-radius:50%; font-size:16px; cursor: pointer;">üóëÔ∏è</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function getGardenTitle(id) {
    const garden = gardens.find(g => g.id === id);
    return garden ? garden.title : 'Tanpa Kebun';
}


function renderRecordList() {
    const listContainer = document.getElementById('record-list');
    if (!listContainer) return;

    const searchValue = (document.getElementById('search-input')?.value || "").trim().toLowerCase();
    
    const fDate = localStorage.getItem('listFilterDate') || 'Semua';
    const fType = localStorage.getItem('listFilterType') || 'Semua';
    const cStart = localStorage.getItem('customDateStart') || '';
    const cEnd = localStorage.getItem('customDateEnd') || '';
    const gTitle = localStorage.getItem('gardenFilterTitle');
    const gId = localStorage.getItem('gardenFilterId');

    if (!listContainer.querySelector('.ios-seg')) {
        listContainer.innerHTML = `
            <div id="header-part"></div>
            <div id="garden-filter-part"></div>
            <div id="date-part"></div>
            <div id="custom-date-part"></div>
            <div class="ios-seg-wrapper">
                <div class="ios-seg"></div>
            </div>
            <div id="record-card-area" class="list-container" style="padding-top:10px;"></div>
        `;
    }

    document.getElementById('header-part').innerHTML = `
        <div style="padding: 15px 15px 5px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:22px; color:var(--text-color);">Catatan</h2>
        </div>
    `;

    document.getElementById('garden-filter-part').innerHTML = `
        <div style="padding: 0 15px 10px;">
            <div style="display:flex; align-items:center; gap:8px; background:var(--secondary-bg); padding:10px 12px; border-radius:12px; border:1px solid var(--border-color);">
                <span style="font-size:16px;">üå≥</span>
                <select onchange="if(this.value==='all'){clearGardenFilter()}else{const g=gardens.find(x=>x.id===this.value); localStorage.setItem('gardenFilterId', g.id); localStorage.setItem('gardenFilterTitle', g.title); renderRecordList();}" style="flex:1; background:none; border:none; font-size:14px; font-weight:bold; outline:none; color:var(--text-color); -webkit-appearance: none;">
                    <option value="all" ${!gId ? 'selected' : ''}>Semua Kebun</option>
                    ${gardens.map(g => `<option value="${g.id}" ${gId === g.id ? 'selected' : ''}>${g.title}</option>`).join('')}
                </select>
                ${gId ? `<span onclick="clearGardenFilter()" style="color:var(--accent-red); font-size:18px; font-weight:bold; padding-left:5px;">‚úï</span>` : ''}
            </div>
        </div>
    `;

    document.getElementById('date-part').innerHTML = `
        <div style="padding: 0 15px 10px;">
            <div style="display:flex; align-items:center; gap:8px; background:var(--secondary-bg); padding:10px 12px; border-radius:12px; border:1px solid var(--border-color);">
                <span style="font-size:16px;">üìÖ</span>
                <select onchange="handleDateFilterChange(this.value)" style="flex:1; background:none; border:none; font-size:14px; font-weight:bold; outline:none; color:var(--text-color); -webkit-appearance: none;">
                    <option value="Semua" ${fDate === 'Semua' ? 'selected' : ''}>Semua Waktu</option>
                    <option value="Hari Ini" ${fDate === 'Hari Ini' ? 'selected' : ''}>Hari Ini</option>
                    <option value="7 Hari" ${fDate === '7 Hari' ? 'selected' : ''}>7 Hari Terakhir</option>
                    <option value="Bulan Ini" ${fDate === 'Bulan Ini' ? 'selected' : ''}>Bulan Ini</option>
                    <option value="Custom" ${fDate === 'Custom' ? 'selected' : ''}>Pilih Tanggal...</option>
                </select>
            </div>
        </div>
    `;

    const customArea = document.getElementById('custom-date-part');
    if (fDate === 'Custom') {
        customArea.style.display = 'flex';
        customArea.style.padding = '0 15px 15px';
        customArea.style.gap = '8px';
        customArea.style.alignItems = 'center';
        customArea.innerHTML = `
            <input type="date" value="${cStart}" onchange="setCustomDate('start', this.value)" style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border-color); background:var(--secondary-bg); color:var(--text-color); font-size:13px; outline:none;">
            <span style="font-size:12px; color:var(--secondary-text-color); font-weight:bold;">-</span>
            <input type="date" value="${cEnd}" onchange="setCustomDate('end', this.value)" style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border-color); background:var(--secondary-bg); color:var(--text-color); font-size:13px; outline:none;">
        `;
    } else {
        customArea.style.display = 'none';
    }

    const categories = ["Semua", "Perawatan", "Pemupukan", "Panen", "Penyemprotan", "Pruning", "Kastrasi"];
    const segContainer = listContainer.querySelector('.ios-seg');
    segContainer.innerHTML = categories.map(c => `
        <div class="ios-seg-item ${fType === c ? "active" : ""}" onclick="setListFilter('${c}')">${c}</div>
    `).join("");

    let filtered = [...records].sort((a, b) => {
        if (a.isPinned === b.isPinned) return new Date(b.date) - new Date(a.date);
        return a.isPinned ? -1 : 1;
    });

    if (gId) filtered = filtered.filter(r => r.gardenIdReference === gId);
    if (searchValue) filtered = filtered.filter(r => r.plantName.toLowerCase().includes(searchValue) || (r.notes && r.notes.toLowerCase().includes(searchValue)));
    if (fType !== 'Semua') filtered = filtered.filter(r => r.type === fType || r.sawitActivity === fType);

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

    filtered = filtered.filter(r => {
        const rD = new Date(r.date);
        const rTime = new Date(rD.getFullYear(), rD.getMonth(), rD.getDate()).getTime();
        if (fDate === 'Hari Ini') return rTime === today;
        if (fDate === '7 Hari') return rTime >= (today - 7*24*60*60*1000);
        if (fDate === 'Bulan Ini') return rD.getMonth() === now.getMonth() && rD.getFullYear() === now.getFullYear();
        if (fDate === 'Custom') {
            if (!cStart || !cEnd) return true;
            return rTime >= new Date(cStart).getTime() && rTime <= new Date(cEnd).getTime();
        }
        return true;
    });

    const cardArea = document.getElementById('record-card-area');
    if (filtered.length === 0) {
        cardArea.innerHTML = `<div style="text-align:center; padding:60px; color:var(--secondary-text-color); opacity:0.7;">Tidak ada data.</div>`;
    } else {
        cardArea.innerHTML = filtered.map(r => `
            <div class="record-card ${r.isPinned ? 'pinned' : ''}" onclick="previewRecord('${r.id}')">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="margin:0; font-size:16px; color:var(--text-color);">${getRecordIcon(r.type)} ${r.plantName}</h3>
                        <span style="font-size:12px; color:var(--secondary-text-color);">${r.date}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <p style="margin:0; font-size:13px; color:var(--secondary-text-color);">${r.type}</p>
                        <p style="margin:0; font-size:11px; opacity:0.6;">üå≥ ${gardens.find(gx=>gx.id===r.gardenIdReference)?.title || 'Tanpa Kebun'}</p>
                    </div>
                </div>
            </div>
        `).join("");
    }
}

// --- FUNGSI PENDUKUNG (WAJIB ADA) ---
function handleDateFilterChange(val) {
    localStorage.setItem('listFilterDate', val);
    renderRecordList();
}

function setCustomDate(type, val) {
    localStorage.setItem(type === 'start' ? 'customDateStart' : 'customDateEnd', val);
    renderRecordList();
}

function setListFilter(type) { listFilterType = type; localStorage.setItem('listFilterType', type); renderRecordList(); }
function setListFilterDate(val) {
    listFilterDate = val;
    localStorage.setItem('listFilterDate', val); // Simpan pilihan user
    renderRecordList();
    showToast(`Filter: ${val}`);
}
function setListSort(sort) { listSortBy = sort; renderRecordList(); }
function clearGardenFilter() { localStorage.removeItem('gardenFilterId'); localStorage.removeItem('gardenFilterTitle'); renderRecordList(); }

function renderGardenSelection() {
document.getElementById('add-options-title').textContent = 'Pilih Kebun'; 
const container = document.getElementById('garden-selection-area');
container.innerHTML = '';

// Opsi 1: Catat Manual (Tanpa Kebun)
container.innerHTML += `<div class="dashboard-nav-card" onclick="renderRecordTypeOptions(null, null)">üìù Catat Manual (Tanpa Kebun).</div>`;

// ===============================================
// TEKS ALERT BARU DENGAN WARNA MERAH
// ===============================================
container.innerHTML += `
<p style="
    text-align: center; 
    color: red; 
    font-size: 0.85em; 
    margin: 10px 0; 
    padding: 0 15px;
    font-weight: bold; 
">
    Jika Tidak Ada Pilihan Kebun Anda Disini, Tambah Kebun Terlebih Dahulu Di Menu Kebunüå≥
</p>
`;
// ===============================================

// Daftar Kebun yang Ada
gardens.forEach(garden => {
container.innerHTML += `<div class="dashboard-nav-card" onclick="renderRecordTypeOptions('${garden.title.replace(/'/g, "\\'")}', '${garden.id}')">üå≥ ${garden.title}</div>`;
});

// Tombol Batal
container.innerHTML += `<div class="form-actions" style="justify-content: center; margin-top: 15px;"><button type="button" class="cancel-btn" onclick="closeModal('add-options-modal')">Batal</button></div>`;
}


function renderRecordTypeOptions(gardenTitle, gardenId) {
    const container = document.getElementById('garden-selection-area');
    // Cek apakah ini sawit (hanya untuk Pruning & Kastrasi)
    const isSawit = gardenTitle && (gardenTitle.toLowerCase().includes('sawit') || gardenTitle.toLowerCase().includes('kelapa sawit'));
    
    container.innerHTML = '';
    document.getElementById('add-options-title').textContent = `Catat untuk ${gardenTitle||'Manual'}`;
    
    const item = (icon, label, type) => `<div class="dashboard-nav-card" onclick="openFormModal('${type}', '${gardenTitle||''}', '${gardenId||''}')">${icon} ${label}</div>`;
    
    // --- MENU UMUM (Sekarang Penyemprotan ada disini) ---
    container.innerHTML += item('üí¶','Perawatan','Perawatan');
    container.innerHTML += item('üß™','Pemupukan','Pemupukan');
    container.innerHTML += item('üí®','Penyemprotan','Penyemprotan'); // <-- PINDAH KESINI (Bisa untuk semua)
    container.innerHTML += item('üçé','Panen','Panen');
    
    // --- MENU KHUSUS SAWIT (Hanya Pruning & Kastrasi) ---
    if(isSawit) {
        container.innerHTML += '<h3 style="margin-top: 15px; color: var(--secondary-text-color); font-size: 15px; font-weight: 600; text-transform: uppercase;">KEGIATAN KHUSUS SAWIT</h3>';
        container.innerHTML += item('‚úÇÔ∏è','Pruning (Potong Pelepah)','Pruning');
        container.innerHTML += item('‚ùå','Kastrasi (Buang Bunga/Buah)','Kastrasi');
    }
    
    container.innerHTML += `<div class="form-actions" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;"><button type="button" class="secondary-action" style="flex: 1;" onclick="renderGardenSelection()">Kembali</button><button type="button" class="cancel-btn" style="flex: 1;" onclick="closeModal('add-options-modal')">Tutup</button></div>`;
}

// --- GALLERY LOGIC ---
function openGalleryModal() { document.getElementById('gallery-form').reset(); document.getElementById('photo-preview-gallery').innerHTML = ''; document.getElementById('gallery-photo-file').value = ''; document.getElementById('gallery-photo-url').value = ''; openModal('gallery-add-modal'); }
async function handleGallerySubmit(e) {
    e.preventDefault();
    const plantName = document.getElementById('gallery-plant-name').value;
    const file = document.getElementById('gallery-photo-file').files[0];
    let url = document.getElementById('gallery-photo-url').value;
    if (!plantName || (!file && !url)) { showCustomDialog('Error', 'Nama Tanaman dan Foto (File atau URL) wajib diisi.'); return; }
    if(file) {
         url = await new Promise((resolve, reject) => { 
            const reader = new FileReader(); const image = new Image();
            reader.onloadend = () => { image.onload = () => resolve(reader.result); image.onerror = () => reject(new Error('File bukan gambar valid.')); image.src = reader.result; }; 
            reader.onerror = reject; reader.readAsDataURL(file); 
        });
    }
    galleryPhotos.unshift({id:Date.now().toString(), plantName, photoUrl:url, date: new Date().toISOString().slice(0, 10)});
    saveGalleryPhotos(); closeModal('gallery-add-modal'); renderContent('Galeri Tanaman'); showCustomDialog('Berhasil', 'Foto berhasil ditambahkan ke galeri.');
}
function deleteGalleryPhoto(id) {
    const confirmDelete = () => { galleryPhotos=galleryPhotos.filter(p=>p.id!==id); saveGalleryPhotos(); renderContent('Galeri Tanaman'); showCustomDialog('Berhasil Dihapus', 'Foto telah dihapus dari galeri.'); };
    showConfirmDialog('Hapus Foto', 'Yakin ingin menghapus foto ini dari galeri?', confirmDelete, null, 'danger');
}
function renderGallery() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';
    const searchValue = searchInput.value.trim().toLowerCase();
    const filteredPhotos = galleryPhotos.filter(p => p.plantName.toLowerCase().includes(searchValue));
    if (filteredPhotos.length === 0) { grid.innerHTML = '<p style="text-align: center; margin: 20px 0; grid-column: 1/4; color: var(--secondary-text-color);">Tidak ada foto di galeri.</p>'; return; }
    filteredPhotos.forEach(p => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        const highlightedPlantName = highlightText(p.plantName, searchValue);
        item.innerHTML = `<img src="${p.photoUrl}" alt="${p.plantName}" onclick="previewPhoto('${p.photoUrl}','${highlightedPlantName}')"><div class="gallery-actions"><button onclick="event.stopPropagation();deleteGalleryPhoto('${p.id}')">X</button></div>`;
        grid.appendChild(item);
    });
}
function previewPhoto(url, title) {
    document.getElementById('garden-detail-content').style.display = 'none';
    document.getElementById('preview-content').style.display = 'block';
    document.getElementById('preview-title').innerHTML = title;
    document.getElementById('preview-content').innerHTML = `<img src="${url}" style="width:100%;border-radius:10px; margin-bottom: 15px;"><div class="form-actions"><button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button></div>`;
    openModal('preview-modal');
}

function showGardenDetail(id) {
     const garden = gardens.find(g => g.id === id);
     if (!garden) return;
     const previewContent = document.getElementById('preview-content');
     const detailContainer = document.getElementById('garden-detail-content');
     previewContent.style.display = 'none'; 
     detailContainer.style.display = 'block'; 
     detailContainer.innerHTML = ''; 
     document.getElementById('preview-title').textContent = `Detail Kebun`;
     const age = calculateAge(garden.dateTanam);
     const dateTanam = garden.dateTanam || 'N/A';
     const varieties = garden.varieties || '-';
     const plantCount = `${garden.plantCount} Pohon`;
     const area = `${garden.area} m¬≤`;
     detailContainer.innerHTML = `<h3>${garden.title}</h3><div class="detail-group"><div class="detail-row"><span class="detail-label">Umur Tanaman</span><span class="detail-value" style="color: var(--accent-green); font-weight: 600;">${age}</span></div><div class="detail-row"><span class="detail-label">Tanggal Tanam</span><span class="detail-value">${dateTanam}</span></div><div class="detail-row"><span class="detail-label">Varietas</span><span class="detail-value">${varieties}</span></div></div><div class="detail-group"><div class="detail-row"><span class="detail-label">Jumlah Tanaman</span><span class="detail-value">${plantCount}</span></div><div class="detail-row"><span class="detail-label">Luas Lahan</span><span class="detail-value">${area}</span></div></div><div class="form-actions"><button class="primary-action" onclick="viewGardenRecords('${garden.id}', '${garden.title}'); closeModal('preview-modal');">Lihat Catatan</button><button class="secondary-action" onclick="openGardenModal('${garden.id}'); closeModal('preview-modal');">Edit Data Kebun</button><button type="button" class="cancel-btn" onclick="closeModal('preview-modal')">Tutup</button></div>`;
     openModal('preview-modal');
}

function viewGardenRecords(gardenId, gardenTitle) { localStorage.setItem('gardenFilterId', gardenId); localStorage.setItem('gardenFilterTitle', gardenTitle); setListFilter('Semua'); setListFilterDate('Semua'); renderContent('Daftar Catatan'); }

function viewRecordAndOpenReminderForm(originalRecordId, reminderId) {
    const originalRecord = records.find(r => r.id === originalRecordId);
    const reminder = reminders.find(r => r.id === reminderId);
    if (!originalRecord || !reminder) { showCustomDialog('Error', 'Data catatan atau pengingat tidak ditemukan.'); if(reminder) { reminders = reminders.filter(r => r.id !== reminderId); saveReminders(); } renderContent('Dashboard'); return; }
    reminders = reminders.filter(r => r.id !== reminderId); saveReminders();
    openFormModal('Pemupukan', originalRecord.plantName, originalRecord.gardenIdReference);
    document.getElementById('record-id').value = ''; 
    document.getElementById('record-date').valueAsDate = new Date(); 
    // PREFILL PUPUK DARI CATATAN SEBELUMNYA
    document.getElementById('pupuk-dose').value = originalRecord.dose || '';
    document.getElementById('pupuk-quantity').value = originalRecord.quantity || '';
    document.getElementById('pupuk-notes').value = `Melanjutkan siklus pemupukan dari catatan tanggal ${originalRecord.date}.`;
    document.getElementById('pupuk-reminder-date').value = ''; 
    document.getElementById('pupuk-reminder-time').value = ''; 
    calculatePupukTotal();
    closeModal('preview-modal');
    showCustomDialog('Pengingat Selesai', `Pengingat **${originalRecord.plantName}** telah diselesaikan. Silakan buat catatan baru.`);
    setTimeout(() => { document.getElementById('record-modal').querySelector('#record-modal-title').scrollIntoView({ behavior: 'smooth' }); }, 300);
}



async function initializeApp() {
    try {
        // 1. Inisialisasi Database IndexedDB
        await dbHelper.open();
        await dbHelper.migrateFromLocalStorage(); // Cek & pindahkan data lama jika ada
        
        // 2. Muat daftar user terdaftar global
        const users = await dbHelper.get('registeredUsers');
        if (users) {
            registeredUsers = users;
        } else {
            await saveRegisteredUsers(); // Simpan default jika kosong
        }

        // 3. Cek Status Login (Session)
        if (localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('loggedInUsername')) {
            loggedInUsername = localStorage.getItem('loggedInUsername');
            loginScreen.style.display = 'none';
            loadingIndicator.style.display = 'flex'; 
            
            // Memberikan sedikit jeda agar loading indicator terlihat dan DB benar-benar siap
            setTimeout(async () => {
                // Ambil data user dari IndexedDB
                await loadUserData(loggedInUsername);
                
                // Set Nama di Header
                const capitalizedUser = loggedInUsername.charAt(0).toUpperCase() + loggedInUsername.slice(1);
                document.getElementById('header-username').textContent = `Halo, ${capitalizedUser}!`;
                
                // --- PENYEMPURNAAN VISUAL AVATAR ---
                // Pastikan avatar asinkron termuat dan header langsung ter-update
                await loadUserAvatar();
                if (typeof updateHeaderAvatar === 'function') {
                    await updateHeaderAvatar(); 
                }

                // Sembunyikan loading dan tampilkan App
                loadingIndicator.style.display = 'none';
                app.style.display = 'block';
                checkDarkMode();
                renderContent('Dashboard');
            }, 500); 

        } else { 
            // Jika tidak ada session, tampilkan layar login
            loginScreen.style.display = 'flex'; 
            loadingIndicator.style.display = 'none';
            checkDarkMode(); 
        }
    } catch (err) {
        console.error("Critical Error:", err);
        alert("Gagal menginisialisasi database: " + err);
    }
}

const searchInputEl = document.getElementById('search-input');

if (searchInputEl) {
    searchInputEl.addEventListener('input', function(e) {
        // 1. Ambil apa yang sedang aktif (Dashboard, Kebun, Catatan, dll)
        // 2. Panggil fungsi render ulang untuk halaman tersebut
        
        switch (currentRecordType) {
            case 'Dashboard':
                renderDashboard();
                break;
            case 'Daftar Kebun':
                renderGardenList();
                break;
            case 'Daftar Pupuk':
                renderFertilizerList();
                break;
            case 'Daftar Racun':
                renderPoisonList();
                break;
            case 'Daftar Catatan':
                renderRecordList();
                break;
            case 'Galeri Tanaman':
                renderGallery();
                break;
            default:
                // Jika di tab lain atau setting, mungkin tidak perlu search
                break;
        }
    });
    
    // Opsional: Tombol "X" (Clear) di input search bawaan browser
    // agar list kembali normal saat dikosongkan
    searchInputEl.addEventListener('search', function(e) {
        if (!this.value) {
            searchInputEl.dispatchEvent(new Event('input'));
        }
    });
}

initializeApp();
// --- JAVASCRIPT LOGIC END ---

// Render map list
function renderMapList() {
    document.getElementById('map-list-container').innerHTML = '';
    if (maps.length === 0) {
        document.getElementById('map-list-container').innerHTML = '<p style="text-align:center; color:var(--secondary-text-color); padding:12px;">Belum ada peta. Buat peta baru.</p>';
        return;
    }
    maps.forEach(m => {
        const div = document.createElement('div');
        div.className = 'record-card';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.innerHTML = `<div><h3 style="margin:0;">üó∫Ô∏è ${m.title}</h3><p style="margin:4px 0 0; color:var(--secondary-text-color); font-size:13px;">Kebun: ${m.gardenTitle}</p></div>
                         <div style="display:flex; gap:8px;">
                            <button class="primary-action" onclick="openMap('${m.id}')">Buka</button>
                            <button class="secondary-action" onclick="editMap('${m.id}')">Edit</button>
                            <button class="danger-btn" onclick="deleteMap('${m.id}')">Hapus</button>
                         </div>`;
        document.getElementById('map-list-container').appendChild(div);
    });
}

// Open map form (modal-like inline)

async function openMapForm(mapId) {
    // Full-sheet modal form for creating/editing a map
    const editing = !!mapId;
    let mapObj = null;
    if (editing) mapObj = maps.find(x=>x.id===mapId) || null;
    // build garden options
    if (gardens.length === 0) {
        // show custom dialog to inform user
        showCustomDialog('Tidak Ada Kebun', 'Belum ada kebun. Tambah kebun dulu di menu Kebun.', null, 'OK');
        return;
    }
    const options = gardens.map(g=>`<option value="${g.id}">${g.title}</option>`).join('');
    const fields = `
        <div class="form-group"><label>Judul Peta</label><input id="sheet-map-title" placeholder="Contoh: Peta Kebun Belakang" value="${editing ? (mapObj.title||'') : ''}"></div>
        <div class="form-group"><label>Pilih Kebun</label><select id="sheet-map-garden">${options}</select></div>
        <div class="form-group"><label>Catatan (opsional)</label><textarea id="sheet-map-desc" rows="3">${editing ? (mapObj.desc||'') : ''}</textarea></div>
    `;
    const res = await showInputSheet(editing ? 'Ubah Peta' : 'Tambah Peta', fields);
    if (!res) return; // cancelled
    const title = res['sheet-map-title'] && res['sheet-map-title'].trim();
    const gardenId = res['sheet-map-garden'];
    const desc = res['sheet-map-desc'] || '';
    if (!title) { showToast('Nama peta tidak boleh kosong'); return; }
    const garden = gardens.find(g=>g.id===gardenId);
    if (!garden) { showToast('Kebun tidak valid'); return; }
    if (editing) {
        mapObj.title = title;
        mapObj.gardenId = garden.id;
        mapObj.gardenTitle = garden.title;
        mapObj.desc = desc;
    } else {
        const newMap = { id: Date.now().toString(), title, gardenId: garden.id, gardenTitle: garden.title, desc, trees: [] };
        maps.unshift(newMap);
    }
    saveMaps();
    renderMapList();
}


// Open a map for viewing/editing
activeMap = null;
mapScale = 1;
mapTranslate = {x:0,y:0};
isPanning = false;
panStart = {x:0,y:0};
// Buka Peta
// VERSI STABIL: Menghindari peta kosong saat baru login
async function openMap(mapId) {
    // 1. Cek paksa: Jika data maps di RAM kosong, ambil ulang dari database (IndexedDB)
    if (maps.length === 0 && loggedInUsername) {
        showToast("Sinkronisasi peta...");
        await loadUserData(loggedInUsername);
    }

    const m = maps.find(x => x.id === mapId);
    
    // 2. Validasi: Jika data benar-benar tidak ditemukan
    if (!m) {
        showCustomDialog("Gagal Membuka", "Data peta tidak ditemukan. Coba refresh halaman.");
        return;
    }

    activeMap = m;

    // Persiapan UI Kanvas
    document.getElementById('map-menu-container').style.display = 'none';
    document.getElementById('map-canvas-area').style.display = 'block';
    document.body.classList.add('editor-active');
    
    mapScale = 1; 
    mapTranslate = {x: 0, y: 0};
    
    const mapViewport = document.getElementById('map-viewport');
    const mapInner = document.getElementById('map-inner');

    // Reset transformasi kanvas
    mapViewport.style.transform = `translate(${mapTranslate.x}px, ${mapTranslate.y}px) scale(${mapScale})`;
    
    // 3. Render isi pohon dari data database
    mapInner.innerHTML = '';
    if (activeMap.trees) {
        activeMap.trees.forEach(t => renderTreeElement(t));
    }
    
    // Gulir otomatis ke area kanvas
    document.getElementById('map-canvas-area').scrollIntoView({ behavior: 'smooth' });
    
    // Bersihkan sisa notif loading jika ada
    document.querySelectorAll('.app-toast').forEach(t => t.remove());
if (activeMap && activeMap.texts) {
    activeMap.texts.forEach(txt => renderTextElement(txt));
}

}

// Tutup Peta
function closeMapView() {
    activeMap = null;
    document.getElementById('map-canvas-area').style.display = 'none';
    document.body.classList.remove('editor-active');

    // PERBAIKAN: Tampilkan kembali menu utama
    document.getElementById('map-menu-container').style.display = 'block';
    
    // Pastikan list dirender ulang jika perlu
    renderMapList();
    cancelMultiSelect();
}

// Edit map metadata
function editMap(mapId) {
    openMapForm(mapId);
}

// Delete map

async function deleteMap(mapId) {
    const ok = await showConfirmSheet('Hapus Peta', 'Hapus peta ini?');
    if (!ok) return;
    maps = maps.filter(m=>m.id!==mapId);
    saveMaps();
    renderMapList();
}


// Add tree prompt

async function addTreePrompt() {
    if (!activeMap) { showCustomDialog('Error', 'Buka peta dulu.'); return; }
    
    // Set default tanggal ke hari ini
    const today = new Date().toISOString().split('T')[0];

    const fields = `
        <div class="form-group">
            <label>Nama Pohon</label>
            <input id="sheet-tree-name" placeholder="Contoh: Durian Musang King">
        </div>
        <div class="form-group">
            <label>Tanggal Tanam</label>
            <input type="date" id="sheet-tree-date" value="${today}">
        </div>
        <div class="form-group">
            <label>Deskripsi (opsional)</label>
            <textarea id="sheet-tree-desc" rows="3"></textarea>
        </div>
    `;

    const res = await showInputSheet('Tambah Pohon', fields);
    if (!res) return;

    const name = res['sheet-tree-name'] && res['sheet-tree-name'].trim();
    const datePlanted = res['sheet-tree-date']; // Ambil tanggal
    const desc = res['sheet-tree-desc'] || '';

    if (!name) { showNotify('Nama pohon tidak boleh kosong'); return; }

    const mapInner = document.getElementById('map-inner');
    const rect = mapInner.getBoundingClientRect();
    
    // Random posisi agak ke tengah
    const x = Math.max(50, rect.width/2 + (Math.random()*100-50));
    const y = Math.max(50, rect.height/2 + (Math.random()*100-50));

    // Masukkan datePlanted ke object tree
    const tree = { 
        id: Date.now().toString(), 
        x, y, name, desc, 
        datePlanted: datePlanted, 
        photos: [] 
    };

    activeMap.trees.push(tree);
    saveMaps();
    renderTreeElement(tree);
    showNotify('Pohon berhasil ditanam üå±');
}



// Render a tree DOM element
function renderTreeElement(tree) {
    const mapInner = document.getElementById('map-inner');
    const el = document.createElement('div');
    el.className = 'map-tree';
    el.dataset.id = tree.id;
    if(tree.groupId) el.dataset.group = tree.groupId;
    el.style.position = 'absolute';
    el.style.left = tree.x + 'px';
    el.style.top = tree.y + 'px';
    el.style.width = '48px';
    el.style.height = '48px';
    el.style.borderRadius = '50%';
    el.style.background = tree.isLocked ? 'rgba(142,142,147,0.95)' : 'rgba(52,199,89,0.95)';
    el.style.display = 'flex';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'center';
    el.style.color = '#fff';
    el.style.cursor = tree.isLocked ? 'default' : 'grab';
    el.style.userSelect = 'none';
    el.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
    el.style.transition = 'transform 0.2s';
    el.innerHTML = tree.isLocked ? 'üîí' : (tree.groupId ? 'üå≥' : 'üå≥');

    const label = document.createElement('div');
    label.className = 'tree-label';
    label.textContent = tree.name || '';
    label.style.position = 'absolute';
    label.style.top = '52px';
    label.style.left = '50%';
    label.style.transform = 'translateX(-50%)';
    label.style.fontSize = '12px';
    label.style.color = '#fff';
    el.appendChild(label);

    el.addEventListener('click', (ev) => { 
        ev.stopPropagation(); 
        if (typeof isMultiSelectMode !== 'undefined' && isMultiSelectMode) {
            handleTreeClick(tree.id, el);
        } else {
            openTreeDetail(tree.id); 
        }
    });

    el.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openTreeActionMenu(tree, el);
    });

    let dragging = false, start = {x:0,y:0};
    let groupElements = [];

    el.addEventListener('pointerdown', (e) => {
        if (tree.isLocked || (typeof isMultiSelectMode !== 'undefined' && isMultiSelectMode)) return; 
        e.stopPropagation();
        dragging = true;
        el.setPointerCapture(e.pointerId);
        start = {x:e.clientX, y:e.clientY};
        
        groupElements = [];
        if (tree.groupId) {
            const members = document.querySelectorAll(`.map-tree[data-group="${tree.groupId}"]`);
            members.forEach(m => {
                groupElements.push({
                    el: m,
                    origX: parseFloat(m.style.left),
                    origY: parseFloat(m.style.top)
                });
            });
        } else {
            groupElements.push({
                el: el,
                origX: parseFloat(el.style.left),
                origY: parseFloat(el.style.top)
            });
        }
    });

    el.addEventListener('pointermove', (e) => {
        if (!dragging) return;
        const dx = (e.clientX - start.x) / (typeof mapScale !== 'undefined' ? mapScale : 1);
        const dy = (e.clientY - start.y) / (typeof mapScale !== 'undefined' ? mapScale : 1);
        
        groupElements.forEach(item => {
            item.el.style.left = (item.origX + dx) + 'px';
            item.el.style.top = (item.origY + dy) + 'px';
        });
    });

    el.addEventListener('pointerup', (e) => {
        if (!dragging) return;
        dragging = false;
        el.releasePointerCapture(e.pointerId);
        groupElements.forEach(item => {
            const t = activeMap.trees.find(x => x.id === item.el.dataset.id);
            if (t) {
                t.x = parseFloat(item.el.style.left);
                t.y = parseFloat(item.el.style.top);
            }
        });
        saveMaps();
    });

    mapInner.appendChild(el);
}


// Open tree detail modal
function openTreeDetail(treeId) {
    const t = activeMap.trees.find(x => x.id === treeId);
    if (!t) return;

    // Pastikan array photoNotes ada
    if (!t.photoNotes) t.photoNotes = [];

    // 1. Hitung Umur
    const ageString = getTreeAgeString(t.datePlanted);
    
    // 2. Format Tanggal Tampilan (DD/MM/YYYY)
    let dateDisplay = '-';
    if(t.datePlanted) {
        const d = new Date(t.datePlanted);
        dateDisplay = d.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
    }

    // 3. Render Daftar Foto + Catatan Per Foto
    const photosHtml = (t.photos || [])
        .map((p, i) => `
            <div style="margin-bottom:15px; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                <div style="display:flex; gap:10px; align-items:flex-start; margin-bottom:8px;">
                    <img src="${p}" style="width:70px; height:70px; object-fit:cover; border-radius:8px; cursor:zoom-in;" onclick="showImageLightbox('${p}')">
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:13px; margin-bottom:4px; opacity:0.7;">Catatan Foto ${i + 1}:</div>
                        <textarea 
                            oninput="updatePhotoNote('${t.id}', ${i}, this.value)" 
                            placeholder="Tulis keterangan foto..." 
                            style="width:100%; background:rgba(0,0,0,0.2); color:#fff; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:6px; font-size:12px; resize:none; font-family:inherit;"
                        >${t.photoNotes[i] || ''}</textarea>
                    </div>
                </div>
                <button class="danger-btn" style="width:100%; padding:5px; font-size:11px; opacity:0.6;" onclick="removeTreePhoto('${t.id}', ${i})">Hapus Foto Ini</button>
            </div>
        `)
        .join('') || '<p style="color:var(--secondary-text-color); font-size:13px; font-style:italic; text-align:center;">Belum ada foto.</p>';

    // 4. Susun HTML Modal
    const html = `
        <div style="margin-bottom:15px;">
            <h3 style="margin:0 0 5px 0; font-size:22px;">${t.name}</h3>
            <p style="color:var(--secondary-text-color); margin:0; font-size:14px;">${t.desc || 'Tidak ada deskripsi'}</p>
        </div>

        <div style="
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border: 1px solid rgba(52, 199, 89, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <div>
                <div style="font-size:12px; color:var(--secondary-text-color); margin-bottom:2px;">üìÖ Tanggal Tanam</div>
                <div style="font-weight:600; font-size:14px;"> ${dateDisplay}</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; color:var(--secondary-text-color); margin-bottom:2px;">Umur Pohon</div>
                <div style="font-weight:800; font-size:16px; color:var(--accent-green);">üå± ${ageString}</div>
            </div>
        </div>

        <div style="margin-top:8px;">
            <h4 style="margin:0 0 10px 0; font-size:15px;">Galeri & Keterangan</h4>
            <div style="max-height:300px; overflow-y:auto; padding-right:5px;">
                ${photosHtml}
            </div>
        </div>

        <div style="margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
            <input type="file" id="tree-photo-file" accept="image/*" style="display:none;" onchange="saveTreePhotoPrompt('${t.id}')">
            
            <button class="save-btn" onclick="document.getElementById('tree-photo-file').click()" style="width:100%; margin-bottom:10px; background:#007AFF;">
                üì∏ Tambah Foto Baru
            </button>
            
            <div style="text-align:center; font-size:11px; color:var(--secondary-text-color); opacity:0.7; line-height:1.4;">
                Klik foto untuk Zoom ‚Ä¢ Catatan tersimpan otomatis<br>
                <span style="color:#ff3b30;">Tahan Icon Pohon di Map untuk Menghapus Pohon</span>
            </div>
        </div>
    `;

    showCustomDialog('Detail Pohon', html, null, null);
}

// FUNGSI PENTING: Supaya pas ngetik langsung simpan ke data
function updatePhotoNote(treeId, photoIndex, value) {
    const t = activeMap.trees.find(x => x.id === treeId);
    if (t) {
        if (!t.photoNotes) t.photoNotes = [];
        t.photoNotes[photoIndex] = value;
        saveMaps(); // Simpan ke localstorage/DB lu
    }
}


// Save photo from file input (reads as data URL)
function saveTreePhotoPrompt(treeId) {
    const fileInput = document.getElementById('tree-photo-file');
    const file = fileInput.files[0];

    // Validasi jika file belum dipilih
    if (!file) {
        // Coba tutup dialog detail pohon dulu (supaya alert kelihatan)
        const treeDialog = document.getElementById('custom-dialog');
        if (treeDialog) {
            treeDialog.classList.remove('active');
            treeDialog.style.display = 'none';
        }
        
        // Tampilkan alert
        setTimeout(() => {
            showCustomAlert('Pilih file gambar terlebih dahulu.', 'Foto Kosong');
        }, 100);
        return;
    }

    // Proses Simpan Foto
    const reader = new FileReader();
    reader.onload = (e) => {
        const dataUrl = e.target.result;
        const t = activeMap.trees.find(x => x.id === treeId);
        
        if (t) {
            t.photos = t.photos || [];
            t.photos.push(dataUrl);
            saveMaps();

            // 1. Tutup Dialog Detail Pohon
            closeModal('custom-dialog');

            // 2. Tampilkan Dialog Berhasil (Delay dikit biar smooth)
            setTimeout(() => {
                showCustomDialog(
                    'Berhasil Upload', 
                    'Foto pohon berhasil ditambahkan ke galeri.',
                    // Callback (Opsional): Buka lagi detail pohon setelah klik OK
                    () => { 
                        closeModal('custom-dialog');
                        setTimeout(() => openTreeDetail(treeId), 300); 
                    },
                    'Lihat Pohon'
                );
            }, 300);
        }
    };
    reader.readAsDataURL(file);
}


// Remove photo
function removeTreePhoto(treeId, index) {
    const t = activeMap.trees.find(x => x.id === treeId);
    if (!t) return;

    showConfirmDialog("Hapus Foto", "Yakin ingin menghapus foto ini?", () => {
        t.photos.splice(index, 1);
        saveMaps();
        setTimeout(() => { openTreeDetail(treeId); }, 50);
        setTimeout(() => {
    showCustomDialog("Berhasil", "Foto telah dihapus.", null, null);
       }, 300);
    });
}

// Zoom map (simple scale)
function zoomMap(factor) {
    mapScale = Math.max(0.3, Math.min(3, mapScale * factor));
    const mapViewport = document.getElementById('map-viewport');
    mapViewport.style.transform = `translate(${mapTranslate.x}px, ${mapTranslate.y}px) scale(${mapScale})`;
}

// Panning the viewport (pointer events on map-canvas-area)
const mapCanvasArea = document.getElementById('map-canvas-area');
if (mapCanvasArea) {
    mapCanvasArea.addEventListener('pointerdown', (e)=>{
        if(!activeMap) return;
        isPanning = true;
        panStart = {x: e.clientX, y: e.clientY, tx: mapTranslate.x, ty: mapTranslate.y};
    });
    window.addEventListener('pointermove', (e)=>{
        if(!isPanning) return;
        mapTranslate.x = panStart.tx + (e.clientX - panStart.x);
        mapTranslate.y = panStart.ty + (e.clientY - panStart.y);
        const mapViewport = document.getElementById('map-viewport');
        if(mapViewport) mapViewport.style.transform = `translate(${mapTranslate.x}px, ${mapTranslate.y}px) scale(${mapScale})`;
    });
    window.addEventListener('pointerup', (e)=>{
        if(isPanning) isPanning = false;
    });
}

// Hook renderContent to show map view
(function hookPetaInRender() {
    const originalRenderContent = window.renderContent;
    window.renderContent = function(type) {
        // call original for known types
        originalRenderContent(type);
        if (type === 'Peta') {
            // hide other views
            ['dashboard-content', 'garden-list', 'fertilizer-list', 'record-list', 'gallery-view', 'settings-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            document.getElementById('map-view').style.display = 'block';
            document.getElementById('map-list-container').style.display = 'block';
            document.getElementById('map-canvas-area').style.display = 'none';
            renderMapList();
        } else {
            // when leaving Peta, ensure map area hidden
            const mv = document.getElementById('map-view');
            if (mv) mv.style.display = 'none';
        }
    };
})();


// --- Full-sheet modal helpers (async) ---
function showSheet(optionsHtml, initialValues) {
    return new Promise((resolve, reject) => {
        const modal = document.getElementById('sheet-modal');
        const inner = document.getElementById('sheet-inner');
        inner.innerHTML = optionsHtml + `
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="cancel-btn" id="sheet-cancel">Batal</button>
                <button class="save-btn" id="sheet-save">Simpan</button>
            </div>`;
        modal.style.display = 'flex';
        setTimeout(()=> modal.classList.add('active'), 10);

        function close(result) {
            modal.classList.remove('active');
            setTimeout(()=>{ modal.style.display='none'; inner.innerHTML=''; resolve(result); }, 250);
        }

        document.getElementById('sheet-cancel').onclick = ()=> close(null);
        document.getElementById('sheet-save').onclick = ()=> {
            // collect inputs
            const inputs = inner.querySelectorAll('input, textarea, select');
            const data = {};
            inputs.forEach(i=>{
                if(i.type==='checkbox') data[i.id]=i.checked;
                else data[i.id]=i.value;
            });
            close(data);
        };
    });
}

function showConfirmSheet(title, message) {
    return new Promise((resolve)=>{
        const html = `<h3 style="margin-top:0;">${title}</h3><p style="color:var(--secondary-text-color)">${message}</p>`;
        showSheet(html).then(res => {
            // res null => cancel, otherwise confirmed (no data needed)
            resolve(Boolean(res));
        });
    });
}

function showInputSheet(title, fieldsHtml) {
    return showSheet(`<h3 style="margin-top:0;">${title}</h3>` + fieldsHtml);
}

</script>
<script>if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register('sw.js'); }); }

</script>



<div id="avatarBackdrop" style="
 position:fixed; inset:0; background:rgba(0,0,0,0.4);
 backdrop-filter: blur(12px); display:none; z-index:9998;" onclick="closeAvatarMenu()"></div>

<div id="avatarMenu" style="
 position: fixed; bottom: -420px; left: 0; right: 0;
 background: rgba(28,28,28,0.92); padding: 20px;
 border-top-left-radius: 28px; border-top-right-radius: 28px;
 display: flex; flex-direction: column; gap: 14px;
 transition: 0.35s cubic-bezier(.25,.8,.25,1); z-index: 9999;
 backdrop-filter: blur(20px);">

<div id="avatarMenuPreview" style="
    width:130px; height:130px;
    border-radius:50%; overflow:hidden;
    border:4px solid rgba(255,255,255,0.25);
    margin:0 auto 18px auto;
    background:#222;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 14px rgba(0,0,0,0.4);
">
    <img id="avatarMenuPreviewImg" src="" style="width:100%; height:100%; object-fit:cover;">
</div>

    <button class="ios-btn" onclick="previewAvatar()">Lihat Foto Profil</button>
    <button class="ios-btn" onclick="openAvatarPicker()">Ganti Foto Profil</button>
    <button class="ios-btn destructive" onclick="deleteAvatar()">Hapus Foto Profil</button>
    <button class="ios-btn cancel" onclick="closeAvatarMenu()">Tutup</button>
    <input type="file" id="avatarFile" accept="image/*" style="display:none;" onchange="saveUserAvatar(this.files[0])">
</div>



<script>
window.openAvatarMenu = async function() {
    const menu = document.getElementById("avatarMenu");
    const backdrop = document.getElementById('avatarBackdrop');
    
    // Munculkan UI Menu
    if(menu) { menu.style.bottom = "0"; }
    if(backdrop) { backdrop.style.display = 'block'; }
    
    // REFRESH DATA: Paksa ambil foto terbaru dari IndexedDB untuk preview tengah
    if (typeof updateAvatarMenuPreview === 'function') {
        await updateAvatarMenuPreview();
    }
};

function closeAvatarMenu() {
    const menu = document.getElementById("avatarMenu");
    const backdrop = document.getElementById('avatarBackdrop');
    
    // 1. Sembunyikan Menu (Geser ke bawah)
    if (menu) { 
        menu.style.bottom = "-430px"; 
    }
    
    // 2. Sembunyikan Backdrop Gelap
    if (backdrop) { 
        backdrop.style.display = 'none'; 
    }
}

function openAvatarPicker(){
    document.getElementById("avatarFile").click();
}
function previewAvatar(){
    const stored = localStorage.getItem(`avatar_${loggedInUsername}`);
    if(!stored){ alert("Belum ada foto profil"); return; }
    const w = window.open(); w.document.write(`<img src="${stored}" style="width:100%;height:auto;">`);
}
async function deleteAvatar() {
    const key = `avatar_${loggedInUsername}`;
    const stored = await dbHelper.get(key);

    if (!stored) {
        showCustomDialog('Tidak Ada Foto Profil', 'Silahkan tambah dulu foto profil Anda.', null, null);
        return;
    }

    showConfirmDialog("Hapus Foto Profil", "Yakin ingin menghapus foto profil?", async () => {
        // 1. Hapus dari Database
        await dbHelper.delete(key);
        
        // 2. Refresh visual header & menu preview secara instan
        if (typeof updateHeaderAvatar === 'function') {
            await updateHeaderAvatar(); 
        }
        if (typeof updateAvatarMenuPreview === 'function') {
            await updateAvatarMenuPreview();
        }
        
        closeAvatarMenu();
        setTimeout(() => {
            showCustomDialog('Berhasil', 'Foto profil berhasil dihapus.', null, null);
        }, 500);
    });
}


async function loadUserAvatar() {
    const avatarDiv = document.getElementById("profileAvatar");
    const username = loggedInUsername || "User";
    // Ambil dari IndexedDB
    const stored = await dbHelper.get(`avatar_${username}`);
    if (stored) {
        avatarDiv.innerHTML = `<img src="${stored}" style="width:100%;height:100%;object-fit:cover;">`;
        return;
    }
    const initial = username.charAt(0).toUpperCase();
    avatarDiv.textContent = initial;
    avatarDiv.innerHTML = initial; // Reset text
    avatarDiv.style.backgroundImage = 'none';
}

async function saveUserAvatar(file) {
    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64 = e.target.result;
        // Simpan ke IndexedDB
        await dbHelper.set(`avatar_${loggedInUsername}`, base64);
        loadUserAvatar();
        closeAvatarMenu();
        showNotify("Foto profil diperbarui");
    };
    reader.readAsDataURL(file);
}

</script>


<script>
function showNotify(msg){
 let n=document.createElement('div');
 n.style.position='fixed'; n.style.top='20px'; n.style.left='50%';
 n.style.transform='translateX(-50%)';
 n.style.background='rgba(0,0,0,0.8)';
 n.style.color='#fff'; n.style.padding='12px 18px';
 n.style.borderRadius='14px'; n.style.zIndex='99999';
 n.style.backdropFilter='blur(10px)';
 n.innerText=msg;
 document.body.appendChild(n);
 setTimeout(()=>{n.style.opacity='0';}, 1800);
 setTimeout(()=>{n.remove();}, 2300);
}
const _saveUserAvatar = saveUserAvatar;
saveUserAvatar = function(f){ _saveUserAvatar(f); showNotify("Foto profil diperbarui"); };
</script>


<script>
const _openAvatarMenu = openAvatarMenu;
openAvatarMenu = function(){
 _openAvatarMenu();
 document.getElementById('avatarBackdrop').style.display='block';
};
const _closeAvatarMenu = closeAvatarMenu;
closeAvatarMenu = function(){
 _closeAvatarMenu();
 document.getElementById('avatarBackdrop').style.display='none';
};
</script>


<div id="avatarPreviewModal" style="
 position:fixed; inset:0; background:rgba(0,0,0,0.55);
 backdrop-filter: blur(10px);
 display:none; align-items:center; justify-content:center;
 z-index:99999; flex-direction:column;">
   <img id="avatarPreviewImg" src="" style="max-width:80%; max-height:70%; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
   <button onclick="closeAvatarPreview()" style="
      margin-top:20px; padding:12px 20px; border-radius:14px;
      background:rgba(255,255,255,0.15); color:#fff; border:none;
      backdrop-filter:blur(8px); font-size:15px;">Tutup</button>
</div>


<script>
async function previewAvatar(){
    const stored = await dbHelper.get(`avatar_${loggedInUsername}`);
    if(!stored){ showCustomDialog('Tidak Ada Foto Profil', 'Silahkan Tambah Dulu Foto Profil Anda.'); return; }
    document.getElementById("avatarPreviewImg").src = stored;
    document.getElementById("avatarPreviewModal").style.display = "flex";
}
</script>


<script>
// HANYA GUNAKAN YANG INI
// Gunakan yang ini agar sinkron dengan IndexedDB
async function updateAvatarMenuPreview() {
    if (!loggedInUsername || !dbHelper.db) return;

    const key = `avatar_${loggedInUsername}`;
    const img = document.getElementById("avatarMenuPreviewImg");
    if (!img) return;

    try {
        // AMBIL DARI INDEXEDDB (Bukan LocalStorage)
        const stored = await dbHelper.get(key);
        
        if (stored) {
            img.src = stored; // Tampilkan foto asli jika ada
        } else {
            // Jika kosong, baru buat inisial pake rumus di atas
            img.src = generateAvatarPlaceholder(loggedInUsername);
        }
    } catch (e) {
        console.error("Gagal load preview:", e);
    }
}

function generateAvatarPlaceholder(name) {
    const initials = (name && name.length > 0) ? name.charAt(0).toUpperCase() : "?";
    const canvas = document.createElement("canvas");
    const size = 240;
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext("2d");

    const pastel = ["#A5C9FF", "#FFB3C6", "#C6FFDD", "#FFD6A5", "#B5EAD7", "#FFDFBA", "#D7B5FF", "#B5FFF6"];
    const bg = pastel[Math.floor(Math.random() * pastel.length)];

    ctx.fillStyle = bg;
    ctx.beginPath();
    ctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 100px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(initials, size/2, size/2 + 8);

    return canvas.toDataURL("image/png");
}

window.updateAvatarMenuPreview = async function() {
    if (!loggedInUsername || !dbHelper.db) return;

    const key = `avatar_${loggedInUsername}`;
    const img = document.getElementById("avatarMenuPreviewImg");
    if (!img) return;

    try {
        const stored = await dbHelper.get(key);
        
        if (stored) {
            img.src = stored;
        } else {
            img.src = generateAvatarPlaceholder(loggedInUsername);
        }
    } catch (e) {
        console.error("Gagal memuat pratinjau avatar dari database:", e);
        img.src = generateAvatarPlaceholder(loggedInUsername);
    }
};

// Override updateHeaderAvatar if exists
window.updateHeaderAvatar = async function() {
    if (!loggedInUsername || !dbHelper.db) return;
    const key = `avatar_${loggedInUsername}`;
    const el = document.getElementById("profileAvatar");
    if (!el) return;

    try {
        const stored = await dbHelper.get(key);
        
        if (stored) {
            // JIKA ADA FOTO
            el.style.backgroundImage = `url('${stored}')`;
            el.textContent = ""; // Hapus inisial teks
            el.style.backgroundColor = "transparent";
        } else {
            // JIKA FOTO DIHAPUS/KOSONG
            const placeholder = generateAvatarPlaceholder(loggedInUsername);
            el.style.backgroundImage = `url('${placeholder}')`;
            
            // --- INI PERBAIKAN TELITINYA ---
            el.textContent = ""; // WAJIB KOSONG! 
            // Karena huruf inisial sudah digambar di dalam gambar 'placeholder' (canvas)
            // Kalau nggak dikosongin, teks '1' lu bakal numpuk di atas gambar bulet.
        }
        
        el.style.backgroundSize = "cover";
        el.style.backgroundPosition = "center";
        el.style.backgroundRepeat = "no-repeat";

    } catch (e) {
        console.error("Gagal update header avatar:", e);
    }
};

</script>
<script>

function deleteTree(treeId) {
    const t = activeMap.trees.find(x => x.id === treeId);
    if (!t) return;

    // Hapus dari data
    activeMap.trees = activeMap.trees.filter(x => x.id !== treeId);
    saveMaps();

    // Tutup dialog
    closeModal('custom-dialog');

    // Refresh map
    if (typeof renderMapTrees === 'function') renderMapTrees();
    else if (typeof renderActiveMap === 'function') renderActiveMap();

    showCustomDialog('Berhasil', 'Pohon telah dihapus.', null, null);
}

</script>
<script>

function closeAvatarPreview() {
    const modal = document.getElementById("avatarPreviewModal");
    if (modal) {
        modal.style.display = "none";
    }
}
</script>

<script>
function openTreeActionMenu(tree, el){
    const old = document.getElementById('treeActionMenu');
    if(old) old.remove();
    const backdrop = document.createElement('div');
    backdrop.id="treeActionMenu";
    backdrop.style.cssText="position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;z-index:99999;";
    backdrop.addEventListener("click",()=>backdrop.remove());

    const box=document.createElement('div');
    box.style.cssText="width:92%;margin-bottom:20px;background:rgba(30,30,30,0.9);border-radius:18px;padding:12px;box-shadow:0 4px 20px rgba(0,0,0,0.5);animation:popupUp .25s ease;";

    const makeBtn=(t,c,a)=>{
        const b=document.createElement('div');
        b.innerText=t;
        b.style.cssText="padding:14px;margin:6px 0;text-align:center;background:"+c+";border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;transition:0.15s;";
        b.onclick=()=>{a();backdrop.remove();};
        return b;
    };
    
    box.appendChild(makeBtn("‚úèÔ∏è Edit Data", "rgba(0,122,255,0.2)", () => {
    openEditTreeModal(tree, el);
}));

    
box.appendChild(makeBtn("üóë Hapus Pohon","rgba(255,0,0,0.15)",()=>{
    activeMap.trees=activeMap.trees.filter(x=>x.id!==tree.id);
    saveMaps(); 
    el.remove();
    
    showToast('Pohon dihapus.');
    if(typeof closeTreeDetail === 'function') closeTreeDetail();
}));

box.appendChild(makeBtn(tree.isLocked ? "üîì Buka Kunci" : "üîí Kunci Posisi", "rgba(255,149,0,0.2)", () => {
    tree.isLocked = !tree.isLocked;
    saveMaps();

    el.remove(); 
    renderTreeElement(tree);
    showToast(tree.isLocked ? "Posisi dikunci" : "Kunci dibuka");
    backdrop.remove();
}));


    
    box.appendChild(makeBtn("‚ùå Tutup","rgba(255,255,255,0.1)",()=>{}));

    backdrop.appendChild(box);
    document.body.appendChild(backdrop);
}

</script>
<style>
@keyframes popupUp{from{transform:translateY(40px);opacity:0;}to{transform:translateY(0);opacity:1;}}
</style>


<script>
function copyTree(treeId){
    const t=activeMap.trees.find(x=>x.id===treeId);
    if(!t) return;
    const copy={...t,id:Date.now().toString(),x:t.x+30,y:t.y+30,name:t.name+" (copy)"};
    activeMap.trees.push(copy);
    saveMaps();
    renderTreeElement(copy);
    showCustomDialog("Berhasil","Pohon berhasil disalin.",null,null);
}
function deleteTree(treeId){
    activeMap.trees=activeMap.trees.filter(x=>x.id!==treeId);
    saveMaps();
    closeModal('custom-dialog');
    if(typeof renderActiveMap==="function") renderActiveMap();
    else if(typeof renderMapTrees==="function") renderMapTrees();
    showCustomDialog("Berhasil","Pohon telah dihapus.",null,null);
}
</script>

</body>
</html>